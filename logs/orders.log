2025-06-25 21:54:00,553 - INFO - orders - Application starting up - Orders logging initialized
2025-06-25 21:54:02,347 - INFO - orders - Found 0 pending order keys in Redis
2025-06-25 21:54:02,499 - DEBUG - orders - Completed SL/TP check cycle for 0 live orders and 0 demo orders
2025-06-25 21:54:07,508 - INFO - orders - Found 0 pending order keys in Redis
2025-06-25 21:54:07,516 - DEBUG - orders - Completed SL/TP check cycle for 0 live orders and 0 demo orders
2025-06-25 21:54:12,528 - INFO - orders - Found 0 pending order keys in Redis
2025-06-25 21:54:12,569 - DEBUG - orders - Completed SL/TP check cycle for 0 live orders and 0 demo orders
2025-06-25 21:54:14,154 - app.api.v1.endpoints.orders - INFO - [get_rejected_orders] user_type: demo
2025-06-25 21:54:17,586 - INFO - orders - Found 0 pending order keys in Redis
2025-06-25 21:54:17,596 - DEBUG - orders - Completed SL/TP check cycle for 0 live orders and 0 demo orders
2025-06-25 21:54:22,714 - INFO - orders - Found 0 pending order keys in Redis
2025-06-25 21:54:22,846 - DEBUG - orders - Completed SL/TP check cycle for 0 live orders and 0 demo orders
2025-06-25 21:54:24,073 - app.api.v1.endpoints.orders - INFO - [get_rejected_orders] user_type: demo
2025-06-25 21:54:27,950 - INFO - orders - Found 0 pending order keys in Redis
2025-06-25 21:54:27,975 - DEBUG - orders - Completed SL/TP check cycle for 0 live orders and 0 demo orders
2025-06-25 21:54:29,506 - INFO - orders - [SLTP_FLOW] After refresh: order 8776888990 stop_loss=None, take_profit=None
2025-06-25 21:54:29,506 - INFO - orders - [SLTP_CHECK] Checking order 8776888990: symbol=AUDCHF, type=BUY, stop_loss=None, take_profit=None, user_id=9
2025-06-25 21:54:29,506 - INFO - orders - [SLTP_CHECK] Order 8776888990 has no SL/TP set. Skipping.
2025-06-25 21:54:31,914 - INFO - orders - [SLTP_FLOW] After refresh: order 8776888990 stop_loss=None, take_profit=None
2025-06-25 21:54:31,914 - INFO - orders - [SLTP_CHECK] Checking order 8776888990: symbol=AUDCHF, type=BUY, stop_loss=None, take_profit=None, user_id=9
2025-06-25 21:54:31,914 - INFO - orders - [SLTP_CHECK] Order 8776888990 has no SL/TP set. Skipping.
2025-06-25 21:54:33,086 - INFO - orders - Found 0 pending order keys in Redis
2025-06-25 21:54:33,260 - DEBUG - orders - Completed SL/TP check cycle for 0 live orders and 0 demo orders
2025-06-25 21:54:38,296 - INFO - orders - Found 0 pending order keys in Redis
2025-06-25 21:54:38,366 - DEBUG - orders - Completed SL/TP check cycle for 0 live orders and 0 demo orders
2025-06-25 21:54:43,524 - INFO - orders - Found 0 pending order keys in Redis
2025-06-25 21:54:43,542 - DEBUG - orders - Completed SL/TP check cycle for 0 live orders and 0 demo orders
2025-06-25 21:54:43,924 - INFO - orders - Order placement request received - User ID: 6, Symbol: AUDCHF, Type: BUY, Quantity: 0.01
2025-06-25 21:54:43,930 - INFO - orders - [DEBUG] group_settings_cache: {'sending_orders': 'barclays'}
2025-06-25 21:54:43,931 - INFO - orders - [DEBUG] sending_orders_cache value: barclays (type: <class 'str'>)
2025-06-25 21:54:43,931 - INFO - orders - Order placement: user_id=6, is_barclays_live_user=False, user_type=demo, group_name=Group B, sending_orders_setting=barclays
2025-06-25 21:54:44,229 - INFO - orders - [ORDER_MARGIN_CALC] Calculating margin for AUDCHF BUY order, quantity: 0.01
2025-06-25 21:54:44,229 - INFO - orders - [ORDER_MARGIN_CALC] Contract size for AUDCHF: 100000.00000000 (raw: 100000.00000000, type: <class 'decimal.Decimal'>)
2025-06-25 21:54:44,231 - INFO - orders - [ORDER_MARGIN_CALC] Got BUY price for AUDCHF from cache: 0.5243600000
2025-06-25 21:54:44,232 - INFO - orders - [ORDER_MARGIN_CALC] Contract value calculation for AUDCHF:
2025-06-25 21:54:44,232 - INFO - orders - [ORDER_MARGIN_CALC] Contract value = quantity * contract_size = 0.01 * 100000.00000000 = 1000.0000000000
2025-06-25 21:54:44,232 - INFO - orders - [ORDER_MARGIN_CALC] Margin calculation: (contract_value * price) / leverage = (1000.0000000000 * 0.5243600000) / 100.00 = 5.243600000000000000 (rounded to 5.24)
2025-06-25 21:54:44,232 - INFO - orders - [ORDER_MARGIN_CALC] Commission settings for AUDCHF: type=0, value_type=0, rate=10.0000
2025-06-25 21:54:44,232 - INFO - orders - [ORDER_MARGIN_CALC] Per lot commission: 0.01 * 10.0000 = 0.100000
2025-06-25 21:54:44,233 - INFO - orders - [ORDER_MARGIN_CALC] Profit currency for AUDCHF: CHF
2025-06-25 21:54:44,233 - INFO - orders - [ORDER_MARGIN_CALC] Converting margin from CHF to USD: 5.24 CHF
2025-06-25 21:54:44,233 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 5.24 CHF to USD for margin for AUDCHF BUY order (user_id: 6, position: )
2025-06-25 21:54:44,233 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CHFUSD
2025-06-25 21:54:44,237 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-06-25 21:54:44,238 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CHFUSD, trying inverse
2025-06-25 21:54:44,238 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCHF
2025-06-25 21:54:44,241 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('0.8036000000'), 'o': Decimal('0.8035600000')}
2025-06-25 21:54:44,242 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 0.8036000000
2025-06-25 21:54:44,242 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 5.24 CHF / 0.8036000000 = 6.520657043305126928820308611 USD
2025-06-25 21:54:44,242 - INFO - orders - [ORDER_MARGIN_CALC] Margin after USD conversion: 5.24 CHF -> 6.520657043305126928820308611 USD
2025-06-25 21:54:44,242 - INFO - orders - [ORDER_MARGIN_CALC] Final results for AUDCHF BUY: margin=6.520657043305126928820308611, price=0.5243600000, contract_value=1000.0000000000, commission=0.10
2025-06-25 21:54:44,242 - app.services.order_processing - INFO - [COMMISSION_CALC] User 6 Symbol AUDCHF: Calculated commission=0.10
2025-06-25 21:54:44,256 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_ENTRY] User 6, Symbol AUDCHF, Positions count: 0
2025-06-25 21:54:44,257 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB] No open positions for User 6, Symbol AUDCHF. Returning zero margin.
2025-06-25 21:54:44,257 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_ENTRY] User 6, Symbol AUDCHF, Positions count: 1
2025-06-25 21:54:44,257 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_POS_DETAIL] User 6, Symbol AUDCHF, Pos 1 (ID: None): Type=BUY, Qty=0.01, StoredMargin=6.520657043305126928820308611
2025-06-25 21:54:44,257 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_POS_DETAIL] User 6, Symbol AUDCHF, Pos 1: MarginPerLot=652.0657043305126928820308611
2025-06-25 21:54:44,257 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_CALC] User 6, Symbol AUDCHF: TotalBuyQty=0.01, TotalSellQty=0, NetQty=0.01
2025-06-25 21:54:44,257 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_CALC] User 6, Symbol AUDCHF: AllMarginsPerLot=[Decimal('652.0657043305126928820308611')], HighestMarginPerLot=652.0657043305126928820308611
2025-06-25 21:54:44,257 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_EXIT] User 6, Symbol AUDCHF: CalculatedTotalMargin=6.52, ContributingOrders=1 (based on individual stored margins)
2025-06-25 21:54:44,257 - app.services.order_processing - INFO - [MARGIN_PROCESS] User 6 Symbol AUDCHF: MarginBefore=0.00, MarginAfter=6.52, AdditionalMargin=6.52
2025-06-25 21:54:44,257 - app.services.order_processing - INFO - [MARGIN_PROCESS_DEBUG] User 6 Symbol AUDCHF
2025-06-25 21:54:44,257 - app.services.order_processing - INFO - [MARGIN_PROCESS_DEBUG] Full margin for this order: 6.520657043305126928820308611
2025-06-25 21:54:44,257 - app.services.order_processing - INFO - [MARGIN_PROCESS_DEBUG] Existing open orders count: 0
2025-06-25 21:54:44,257 - app.services.order_processing - INFO - [MARGIN_PROCESS_DEBUG] Total margin before: 0.0
2025-06-25 21:54:44,258 - app.services.order_processing - INFO - [MARGIN_PROCESS_DEBUG] Total margin after: 6.52
2025-06-25 21:54:44,258 - app.services.order_processing - INFO - [MARGIN_PROCESS_DEBUG] Additional margin needed: 6.52
2025-06-25 21:54:44,284 - app.services.order_processing - INFO - [MARGIN_PROCESS] User 6: OriginalMarginDB=0E-8, CalculatedNewMargin=6.52
2025-06-25 21:54:44,419 - INFO - orders - [PRE-CRUD] About to call create_order with: {'order_id': '1053131246', 'order_status': 'OPEN', 'order_user_id': 6, 'order_company_name': 'AUDCHF', 'order_type': 'BUY', 'order_price': Decimal('0.5243600000'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('1000.0000000000'), 'margin': Decimal('6.520657043305126928820308611'), 'commission': Decimal('0.10'), 'stop_loss': None, 'take_profit': None, 'stoploss_id': None, 'takeprofit_id': None, 'status': 'OPEN'}
2025-06-25 21:54:44,555 - INFO - orders - [MARGIN_COMMIT_CHECK] User 6 margin in session BEFORE commit: 6.52000000
2025-06-25 21:54:44,597 - INFO - orders - User data cache updated for user 6 after placing order
2025-06-25 21:54:45,854 - INFO - orders - Portfolio cache updated and websocket event published for user 6 after placing order.
2025-06-25 21:54:45,893 - INFO - orders - Starting update_user_static_orders for user 6, user_type demo
2025-06-25 21:54:45,893 - INFO - orders - Using order model: DemoUserOrder
2025-06-25 21:54:45,913 - INFO - orders - Fetched 1 open orders for user 6
2025-06-25 21:54:45,924 - INFO - orders - Fetched 0 pending orders for user 6
2025-06-25 21:54:45,927 - INFO - orders - Updated static orders cache for user 6 with 1 open orders and 0 pending orders
2025-06-25 21:54:48,349 - INFO - orders - [SLTP_FLOW] After refresh: order 8776888990 stop_loss=None, take_profit=None
2025-06-25 21:54:48,350 - INFO - orders - [SLTP_CHECK] Checking order 8776888990: symbol=AUDCHF, type=BUY, stop_loss=None, take_profit=None, user_id=9
2025-06-25 21:54:48,350 - INFO - orders - [SLTP_CHECK] Order 8776888990 has no SL/TP set. Skipping.
2025-06-25 21:54:48,848 - INFO - orders - Order placement request received - User ID: 6, Symbol: AUDCHF, Type: SELL, Quantity: 0.01
2025-06-25 21:54:48,853 - INFO - orders - Found 0 pending order keys in Redis
2025-06-25 21:54:48,922 - INFO - orders - [DEBUG] group_settings_cache: {'sending_orders': 'barclays'}
2025-06-25 21:54:48,922 - INFO - orders - [DEBUG] sending_orders_cache value: barclays (type: <class 'str'>)
2025-06-25 21:54:48,922 - INFO - orders - Order placement: user_id=6, is_barclays_live_user=False, user_type=demo, group_name=Group B, sending_orders_setting=barclays
2025-06-25 21:54:48,929 - DEBUG - orders - Completed SL/TP check cycle for 0 live orders and 0 demo orders
2025-06-25 21:54:49,306 - INFO - orders - [ORDER_MARGIN_CALC] Calculating margin for AUDCHF SELL order, quantity: 0.01
2025-06-25 21:54:49,306 - INFO - orders - [ORDER_MARGIN_CALC] Contract size for AUDCHF: 100000.00000000 (raw: 100000.00000000, type: <class 'decimal.Decimal'>)
2025-06-25 21:54:49,309 - INFO - orders - [ORDER_MARGIN_CALC] Got SELL price for AUDCHF from cache: 0.5238800000
2025-06-25 21:54:49,310 - INFO - orders - [ORDER_MARGIN_CALC] Contract value calculation for AUDCHF:
2025-06-25 21:54:49,310 - INFO - orders - [ORDER_MARGIN_CALC] Contract value = quantity * contract_size = 0.01 * 100000.00000000 = 1000.0000000000
2025-06-25 21:54:49,310 - INFO - orders - [ORDER_MARGIN_CALC] Margin calculation: (contract_value * price) / leverage = (1000.0000000000 * 0.5238800000) / 100.00 = 5.238800000000000000 (rounded to 5.24)
2025-06-25 21:54:49,310 - INFO - orders - [ORDER_MARGIN_CALC] Commission settings for AUDCHF: type=0, value_type=0, rate=10.0000
2025-06-25 21:54:49,310 - INFO - orders - [ORDER_MARGIN_CALC] Per lot commission: 0.01 * 10.0000 = 0.100000
2025-06-25 21:54:49,310 - INFO - orders - [ORDER_MARGIN_CALC] Profit currency for AUDCHF: CHF
2025-06-25 21:54:49,310 - INFO - orders - [ORDER_MARGIN_CALC] Converting margin from CHF to USD: 5.24 CHF
2025-06-25 21:54:49,311 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 5.24 CHF to USD for margin for AUDCHF SELL order (user_id: 6, position: )
2025-06-25 21:54:49,311 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CHFUSD
2025-06-25 21:54:49,314 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-06-25 21:54:49,314 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CHFUSD, trying inverse
2025-06-25 21:54:49,314 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCHF
2025-06-25 21:54:49,316 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('0.8036000000'), 'o': Decimal('0.8035600000')}
2025-06-25 21:54:49,317 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 0.8036000000
2025-06-25 21:54:49,317 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 5.24 CHF / 0.8036000000 = 6.520657043305126928820308611 USD
2025-06-25 21:54:49,317 - INFO - orders - [ORDER_MARGIN_CALC] Margin after USD conversion: 5.24 CHF -> 6.520657043305126928820308611 USD
2025-06-25 21:54:49,317 - INFO - orders - [ORDER_MARGIN_CALC] Final results for AUDCHF SELL: margin=6.520657043305126928820308611, price=0.5238800000, contract_value=1000.0000000000, commission=0.10
2025-06-25 21:54:49,317 - app.services.order_processing - INFO - [COMMISSION_CALC] User 6 Symbol AUDCHF: Calculated commission=0.10
2025-06-25 21:54:49,325 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_ENTRY] User 6, Symbol AUDCHF, Positions count: 1
2025-06-25 21:54:49,325 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_POS_DETAIL] User 6, Symbol AUDCHF, Pos 1 (ID: 356): Type=BUY, Qty=0.01000000, StoredMargin=6.52065704
2025-06-25 21:54:49,326 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_POS_DETAIL] User 6, Symbol AUDCHF, Pos 1: MarginPerLot=652.065704
2025-06-25 21:54:49,326 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_CALC] User 6, Symbol AUDCHF: TotalBuyQty=0.01000000, TotalSellQty=0, NetQty=0.01000000
2025-06-25 21:54:49,326 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_CALC] User 6, Symbol AUDCHF: AllMarginsPerLot=[Decimal('652.065704')], HighestMarginPerLot=652.065704
2025-06-25 21:54:49,326 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_EXIT] User 6, Symbol AUDCHF: CalculatedTotalMargin=6.52, ContributingOrders=1 (based on individual stored margins)
2025-06-25 21:54:49,326 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_ENTRY] User 6, Symbol AUDCHF, Positions count: 2
2025-06-25 21:54:49,326 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_POS_DETAIL] User 6, Symbol AUDCHF, Pos 1 (ID: 356): Type=BUY, Qty=0.01000000, StoredMargin=6.52065704
2025-06-25 21:54:49,326 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_POS_DETAIL] User 6, Symbol AUDCHF, Pos 1: MarginPerLot=652.065704
2025-06-25 21:54:49,326 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_POS_DETAIL] User 6, Symbol AUDCHF, Pos 2 (ID: None): Type=SELL, Qty=0.01, StoredMargin=6.520657043305126928820308611
2025-06-25 21:54:49,326 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_POS_DETAIL] User 6, Symbol AUDCHF, Pos 2: MarginPerLot=652.0657043305126928820308611
2025-06-25 21:54:49,326 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_CALC] User 6, Symbol AUDCHF: TotalBuyQty=0.01000000, TotalSellQty=0.01, NetQty=0.01000000
2025-06-25 21:54:49,326 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_CALC] User 6, Symbol AUDCHF: AllMarginsPerLot=[Decimal('652.065704'), Decimal('652.0657043305126928820308611')], HighestMarginPerLot=652.0657043305126928820308611
2025-06-25 21:54:49,327 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_EXIT] User 6, Symbol AUDCHF: CalculatedTotalMargin=6.52, ContributingOrders=2 (based on individual stored margins)
2025-06-25 21:54:49,327 - app.services.order_processing - INFO - [MARGIN_PROCESS] User 6 Symbol AUDCHF: MarginBefore=6.52, MarginAfter=6.52, AdditionalMargin=0.00
2025-06-25 21:54:49,327 - app.services.order_processing - INFO - [MARGIN_PROCESS_DEBUG] User 6 Symbol AUDCHF
2025-06-25 21:54:49,328 - app.services.order_processing - INFO - [MARGIN_PROCESS_DEBUG] Full margin for this order: 6.520657043305126928820308611
2025-06-25 21:54:49,328 - app.services.order_processing - INFO - [MARGIN_PROCESS_DEBUG] Existing open orders count: 1
2025-06-25 21:54:49,329 - app.services.order_processing - INFO - [MARGIN_PROCESS_DEBUG] Total margin before: 6.52
2025-06-25 21:54:49,329 - app.services.order_processing - INFO - [MARGIN_PROCESS_DEBUG] Total margin after: 6.52
2025-06-25 21:54:49,329 - app.services.order_processing - INFO - [MARGIN_PROCESS_DEBUG] Additional margin needed: 0.0
2025-06-25 21:54:49,337 - app.services.order_processing - INFO - [MARGIN_PROCESS] User 6: OriginalMarginDB=6.52000000, CalculatedNewMargin=6.52
2025-06-25 21:54:49,382 - INFO - orders - [PRE-CRUD] About to call create_order with: {'order_id': '2333650127', 'order_status': 'OPEN', 'order_user_id': 6, 'order_company_name': 'AUDCHF', 'order_type': 'SELL', 'order_price': Decimal('0.5238800000'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('1000.0000000000'), 'margin': Decimal('6.520657043305126928820308611'), 'commission': Decimal('0.10'), 'stop_loss': None, 'take_profit': None, 'stoploss_id': None, 'takeprofit_id': None, 'status': 'OPEN'}
2025-06-25 21:54:49,460 - INFO - orders - [MARGIN_COMMIT_CHECK] User 6 margin in session BEFORE commit: 6.52000000
2025-06-25 21:54:49,602 - INFO - orders - User data cache updated for user 6 after placing order
2025-06-25 21:54:51,121 - INFO - orders - Portfolio cache updated and websocket event published for user 6 after placing order.
2025-06-25 21:54:51,138 - INFO - orders - Starting update_user_static_orders for user 6, user_type demo
2025-06-25 21:54:51,138 - INFO - orders - Using order model: DemoUserOrder
2025-06-25 21:54:51,172 - INFO - orders - Fetched 2 open orders for user 6
2025-06-25 21:54:51,181 - INFO - orders - Fetched 0 pending orders for user 6
2025-06-25 21:54:51,194 - INFO - orders - Updated static orders cache for user 6 with 2 open orders and 0 pending orders
2025-06-25 21:54:52,635 - INFO - orders - Order placement request received - User ID: 6, Symbol: AUDCHF, Type: BUY, Quantity: 0.01
2025-06-25 21:54:52,655 - INFO - orders - [DEBUG] group_settings_cache: {'sending_orders': 'barclays'}
2025-06-25 21:54:52,655 - INFO - orders - [DEBUG] sending_orders_cache value: barclays (type: <class 'str'>)
2025-06-25 21:54:52,655 - INFO - orders - Order placement: user_id=6, is_barclays_live_user=False, user_type=demo, group_name=Group B, sending_orders_setting=barclays
2025-06-25 21:54:53,043 - INFO - orders - [ORDER_MARGIN_CALC] Calculating margin for AUDCHF BUY order, quantity: 0.01
2025-06-25 21:54:53,043 - INFO - orders - [ORDER_MARGIN_CALC] Contract size for AUDCHF: 100000.00000000 (raw: 100000.00000000, type: <class 'decimal.Decimal'>)
2025-06-25 21:54:53,048 - INFO - orders - [ORDER_MARGIN_CALC] Got BUY price for AUDCHF from cache: 0.5243600000
2025-06-25 21:54:53,049 - INFO - orders - [ORDER_MARGIN_CALC] Contract value calculation for AUDCHF:
2025-06-25 21:54:53,049 - INFO - orders - [ORDER_MARGIN_CALC] Contract value = quantity * contract_size = 0.01 * 100000.00000000 = 1000.0000000000
2025-06-25 21:54:53,049 - INFO - orders - [ORDER_MARGIN_CALC] Margin calculation: (contract_value * price) / leverage = (1000.0000000000 * 0.5243600000) / 100.00 = 5.243600000000000000 (rounded to 5.24)
2025-06-25 21:54:53,049 - INFO - orders - [ORDER_MARGIN_CALC] Commission settings for AUDCHF: type=0, value_type=0, rate=10.0000
2025-06-25 21:54:53,049 - INFO - orders - [ORDER_MARGIN_CALC] Per lot commission: 0.01 * 10.0000 = 0.100000
2025-06-25 21:54:53,049 - INFO - orders - [ORDER_MARGIN_CALC] Profit currency for AUDCHF: CHF
2025-06-25 21:54:53,049 - INFO - orders - [ORDER_MARGIN_CALC] Converting margin from CHF to USD: 5.24 CHF
2025-06-25 21:54:53,050 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 5.24 CHF to USD for margin for AUDCHF BUY order (user_id: 6, position: )
2025-06-25 21:54:53,050 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CHFUSD
2025-06-25 21:54:53,055 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-06-25 21:54:53,055 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CHFUSD, trying inverse
2025-06-25 21:54:53,055 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCHF
2025-06-25 21:54:53,059 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('0.8036000000'), 'o': Decimal('0.8035600000')}
2025-06-25 21:54:53,059 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 0.8036000000
2025-06-25 21:54:53,059 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 5.24 CHF / 0.8036000000 = 6.520657043305126928820308611 USD
2025-06-25 21:54:53,060 - INFO - orders - [ORDER_MARGIN_CALC] Margin after USD conversion: 5.24 CHF -> 6.520657043305126928820308611 USD
2025-06-25 21:54:53,060 - INFO - orders - [ORDER_MARGIN_CALC] Final results for AUDCHF BUY: margin=6.520657043305126928820308611, price=0.5243600000, contract_value=1000.0000000000, commission=0.10
2025-06-25 21:54:53,060 - app.services.order_processing - INFO - [COMMISSION_CALC] User 6 Symbol AUDCHF: Calculated commission=0.10
2025-06-25 21:54:53,104 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_ENTRY] User 6, Symbol AUDCHF, Positions count: 2
2025-06-25 21:54:53,105 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_POS_DETAIL] User 6, Symbol AUDCHF, Pos 1 (ID: 356): Type=BUY, Qty=0.01000000, StoredMargin=6.52065704
2025-06-25 21:54:53,105 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_POS_DETAIL] User 6, Symbol AUDCHF, Pos 1: MarginPerLot=652.065704
2025-06-25 21:54:53,105 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_POS_DETAIL] User 6, Symbol AUDCHF, Pos 2 (ID: 357): Type=SELL, Qty=0.01000000, StoredMargin=6.52065704
2025-06-25 21:54:53,105 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_POS_DETAIL] User 6, Symbol AUDCHF, Pos 2: MarginPerLot=652.065704
2025-06-25 21:54:53,105 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_CALC] User 6, Symbol AUDCHF: TotalBuyQty=0.01000000, TotalSellQty=0.01000000, NetQty=0.01000000
2025-06-25 21:54:53,105 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_CALC] User 6, Symbol AUDCHF: AllMarginsPerLot=[Decimal('652.065704'), Decimal('652.065704')], HighestMarginPerLot=652.065704
2025-06-25 21:54:53,105 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_EXIT] User 6, Symbol AUDCHF: CalculatedTotalMargin=6.52, ContributingOrders=2 (based on individual stored margins)
2025-06-25 21:54:53,105 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_ENTRY] User 6, Symbol AUDCHF, Positions count: 3
2025-06-25 21:54:53,106 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_POS_DETAIL] User 6, Symbol AUDCHF, Pos 1 (ID: 356): Type=BUY, Qty=0.01000000, StoredMargin=6.52065704
2025-06-25 21:54:53,106 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_POS_DETAIL] User 6, Symbol AUDCHF, Pos 1: MarginPerLot=652.065704
2025-06-25 21:54:53,106 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_POS_DETAIL] User 6, Symbol AUDCHF, Pos 2 (ID: 357): Type=SELL, Qty=0.01000000, StoredMargin=6.52065704
2025-06-25 21:54:53,106 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_POS_DETAIL] User 6, Symbol AUDCHF, Pos 2: MarginPerLot=652.065704
2025-06-25 21:54:53,106 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_POS_DETAIL] User 6, Symbol AUDCHF, Pos 3 (ID: None): Type=BUY, Qty=0.01, StoredMargin=6.520657043305126928820308611
2025-06-25 21:54:53,110 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_POS_DETAIL] User 6, Symbol AUDCHF, Pos 3: MarginPerLot=652.0657043305126928820308611
2025-06-25 21:54:53,110 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_CALC] User 6, Symbol AUDCHF: TotalBuyQty=0.02000000, TotalSellQty=0.01000000, NetQty=0.02000000
2025-06-25 21:54:53,110 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_CALC] User 6, Symbol AUDCHF: AllMarginsPerLot=[Decimal('652.065704'), Decimal('652.065704'), Decimal('652.0657043305126928820308611')], HighestMarginPerLot=652.0657043305126928820308611
2025-06-25 21:54:53,110 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_EXIT] User 6, Symbol AUDCHF: CalculatedTotalMargin=13.04, ContributingOrders=3 (based on individual stored margins)
2025-06-25 21:54:53,111 - app.services.order_processing - INFO - [MARGIN_PROCESS] User 6 Symbol AUDCHF: MarginBefore=6.52, MarginAfter=13.04, AdditionalMargin=6.52
2025-06-25 21:54:53,111 - app.services.order_processing - INFO - [MARGIN_PROCESS_DEBUG] User 6 Symbol AUDCHF
2025-06-25 21:54:53,111 - app.services.order_processing - INFO - [MARGIN_PROCESS_DEBUG] Full margin for this order: 6.520657043305126928820308611
2025-06-25 21:54:53,111 - app.services.order_processing - INFO - [MARGIN_PROCESS_DEBUG] Existing open orders count: 2
2025-06-25 21:54:53,111 - app.services.order_processing - INFO - [MARGIN_PROCESS_DEBUG] Total margin before: 6.52
2025-06-25 21:54:53,111 - app.services.order_processing - INFO - [MARGIN_PROCESS_DEBUG] Total margin after: 13.04
2025-06-25 21:54:53,111 - app.services.order_processing - INFO - [MARGIN_PROCESS_DEBUG] Additional margin needed: 6.52
2025-06-25 21:54:53,197 - app.services.order_processing - INFO - [MARGIN_PROCESS] User 6: OriginalMarginDB=6.52000000, CalculatedNewMargin=13.04
2025-06-25 21:54:53,282 - INFO - orders - [PRE-CRUD] About to call create_order with: {'order_id': '3701391709', 'order_status': 'OPEN', 'order_user_id': 6, 'order_company_name': 'AUDCHF', 'order_type': 'BUY', 'order_price': Decimal('0.5243600000'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('1000.0000000000'), 'margin': Decimal('6.520657043305126928820308611'), 'commission': Decimal('0.10'), 'stop_loss': None, 'take_profit': None, 'stoploss_id': None, 'takeprofit_id': None, 'status': 'OPEN'}
2025-06-25 21:54:53,427 - INFO - orders - [MARGIN_COMMIT_CHECK] User 6 margin in session BEFORE commit: 13.04000000
2025-06-25 21:54:53,521 - INFO - orders - User data cache updated for user 6 after placing order
2025-06-25 21:54:54,007 - INFO - orders - Found 0 pending order keys in Redis
2025-06-25 21:54:54,068 - DEBUG - orders - Completed SL/TP check cycle for 0 live orders and 0 demo orders
2025-06-25 21:54:54,855 - INFO - orders - Portfolio cache updated and websocket event published for user 6 after placing order.
2025-06-25 21:54:54,865 - INFO - orders - Starting update_user_static_orders for user 6, user_type demo
2025-06-25 21:54:54,865 - INFO - orders - Using order model: DemoUserOrder
2025-06-25 21:54:54,891 - INFO - orders - Fetched 3 open orders for user 6
2025-06-25 21:54:54,913 - INFO - orders - Fetched 0 pending orders for user 6
2025-06-25 21:54:54,928 - INFO - orders - Updated static orders cache for user 6 with 3 open orders and 0 pending orders
2025-06-25 21:54:55,067 - INFO - orders - [SLTP_FLOW] After refresh: order 8776888990 stop_loss=None, take_profit=None
2025-06-25 21:54:55,068 - INFO - orders - [SLTP_CHECK] Checking order 8776888990: symbol=AUDCHF, type=BUY, stop_loss=None, take_profit=None, user_id=9
2025-06-25 21:54:55,068 - INFO - orders - [SLTP_CHECK] Order 8776888990 has no SL/TP set. Skipping.
2025-06-25 21:54:59,138 - INFO - orders - Found 0 pending order keys in Redis
2025-06-25 21:54:59,216 - DEBUG - orders - Completed SL/TP check cycle for 0 live orders and 0 demo orders
