2025-06-27 04:47:38,541 - INFO - orders - Application starting up - Orders logging initialized
2025-06-27 04:47:38,541 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-06-27 04:47:55,446 - app.api.v1.endpoints.orders - INFO - [get_rejected_orders] user_type: demo
2025-06-27 04:48:39,251 - INFO - orders - [PENDING_ORDER_EXECUTION][PORTFOLIO_UPDATE] user_id=9, user_type=live, group_name=Group B, free_margin=9543.008928808299232896597465, margin_level=147141.7400432711746209028885, balance=10000.00000000, equity=9549.498928808299232896597465
2025-06-27 04:48:40,071 - INFO - orders - [PENDING_ORDER_EXECUTION][PORTFOLIO_UPDATE] user_id=10, user_type=demo, group_name=Group B, free_margin=1546.749918463856636286375758, margin_level=11934.35285741282812766928660, balance=1559.93932766, equity=1559.819918463856636286375758
2025-06-27 04:49:40,115 - INFO - orders - [PENDING_ORDER_EXECUTION][PORTFOLIO_UPDATE] user_id=9, user_type=live, group_name=Group B, free_margin=9542.967666078556502371210130, margin_level=147141.1042539068798516365197, balance=10000.00000000, equity=9549.457666078556502371210130
2025-06-27 04:49:41,350 - INFO - orders - [PENDING_ORDER_EXECUTION][PORTFOLIO_UPDATE] user_id=10, user_type=demo, group_name=Group B, free_margin=1546.823181703797117800912867, margin_level=11934.91340247740717521738995, balance=1559.93932766, equity=1559.893181703797117800912867
2025-06-27 05:03:29,174 - INFO - orders - Application starting up - Orders logging initialized
2025-06-27 05:03:29,174 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-06-27 05:04:14,818 - INFO - orders - Application starting up - Orders logging initialized
2025-06-27 05:04:14,818 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-06-27 05:04:17,062 - app.api.v1.endpoints.orders - INFO - [get_rejected_orders] user_type: demo
2025-06-27 05:04:30,310 - INFO - orders - [PENDING_ORDER_EXECUTION][PORTFOLIO_UPDATE] user_id=9, user_type=live, group_name=Group B, free_margin=9542.936442879127203573260600, margin_level=147140.6231568432542923460801, balance=10000.00000000, equity=9549.426442879127203573260600
2025-06-27 05:04:32,419 - INFO - orders - [PENDING_ORDER_EXECUTION][PORTFOLIO_UPDATE] user_id=10, user_type=demo, group_name=Group B, free_margin=1546.705946965697963966603193, margin_level=11934.01642666945649553636720, balance=1559.93932766, equity=1559.775946965697963966603193
2025-06-27 05:04:44,799 - INFO - orders - Application starting up - Orders logging initialized
2025-06-27 05:04:44,800 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-06-27 05:05:15,670 - INFO - orders - [PENDING_ORDER_EXECUTION][PORTFOLIO_UPDATE] user_id=9, user_type=live, group_name=Group B, free_margin=9542.870037791097818878029858, margin_level=147139.5999659645272554395972, balance=10000.00000000, equity=9549.360037791097818878029858
2025-06-27 05:05:16,348 - INFO - orders - [PENDING_ORDER_EXECUTION][PORTFOLIO_UPDATE] user_id=10, user_type=demo, group_name=Group B, free_margin=1546.705956354919600014651478, margin_level=11934.01649850741851579687435, balance=1559.93932766, equity=1559.775956354919600014651478
2025-06-27 05:05:45,368 - INFO - orders - [PENDING_ORDER_EXECUTION][PORTFOLIO_UPDATE] user_id=9, user_type=live, group_name=Group B, free_margin=9542.945119442393603043309599, margin_level=147140.7568481108413411912111, balance=10000.00000000, equity=9549.435119442393603043309599
2025-06-27 05:05:45,746 - INFO - orders - [PENDING_ORDER_EXECUTION][PORTFOLIO_UPDATE] user_id=10, user_type=demo, group_name=Group B, free_margin=1546.647351569985935302390999, margin_level=11933.56810688589085923788064, balance=1559.93932766, equity=1559.717351569985935302390999
2025-06-27 05:06:04,118 - app.api.v1.endpoints.orders - INFO - [get_rejected_orders] user_type: demo
2025-06-27 05:06:06,466 - app.api.v1.endpoints.orders - INFO - [get_rejected_orders] user_type: demo
2025-06-27 05:06:44,213 - app.api.v1.endpoints.orders - INFO - [get_rejected_orders] user_type: demo
2025-06-27 05:06:45,958 - INFO - orders - [PENDING_ORDER_EXECUTION][PORTFOLIO_UPDATE] user_id=9, user_type=live, group_name=Group B, free_margin=9542.787385645453976597209186, margin_level=147138.3264352150073435625452, balance=10000.00000000, equity=9549.277385645453976597209186
2025-06-27 05:06:46,859 - INFO - orders - [PENDING_ORDER_EXECUTION][PORTFOLIO_UPDATE] user_id=10, user_type=demo, group_name=Group B, free_margin=1546.705954208387333074505725, margin_level=11934.01648208406528748665436, balance=1559.93932766, equity=1559.775954208387333074505725
2025-06-27 05:07:12,591 - INFO - orders - Add stoploss request received - Order ID: 4068750376, User ID: 10
2025-06-27 05:07:12,605 - INFO - orders - Generated stoploss_id: 2996123137 for order 4068750376
2025-06-27 05:07:12,608 - INFO - orders - User 10 is_barclays_live_user: False
2025-06-27 05:07:12,608 - INFO - orders - Non-Barclays user. Adding stoploss to order 4068750376 immediately
2025-06-27 05:07:12,702 - INFO - orders - Starting update_user_static_orders for user 10, user_type demo
2025-06-27 05:07:12,702 - INFO - orders - Using order model: DemoUserOrder
2025-06-27 05:07:12,710 - INFO - orders - Fetched 2 open orders for user 10
2025-06-27 05:07:12,718 - INFO - orders - Fetched 0 pending orders for user 10
2025-06-27 05:07:12,719 - INFO - orders - Updated static orders cache for user 10 with 2 open orders and 0 pending orders
2025-06-27 05:07:23,357 - INFO - orders - Add takeprofit request received - Order ID: 4068750376, User ID: 10
2025-06-27 05:07:23,373 - INFO - orders - Generated takeprofit_id: 3656539613 for order 4068750376
2025-06-27 05:07:23,378 - INFO - orders - User 10 is_barclays_live_user: False
2025-06-27 05:07:23,378 - INFO - orders - Non-Barclays user. Adding takeprofit to order 4068750376 immediately
2025-06-27 05:07:23,407 - INFO - orders - Starting update_user_static_orders for user 10, user_type demo
2025-06-27 05:07:23,407 - INFO - orders - Using order model: DemoUserOrder
2025-06-27 05:07:23,413 - INFO - orders - Fetched 2 open orders for user 10
2025-06-27 05:07:23,419 - INFO - orders - Fetched 0 pending orders for user 10
2025-06-27 05:07:23,421 - INFO - orders - Updated static orders cache for user 10 with 2 open orders and 0 pending orders
2025-06-27 05:07:24,831 - INFO - orders - [ORDER_CLOSE] Closing demo order 4068750376 at price 0.8922500000 due to STOP_LOSS
2025-06-27 05:07:24,855 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_ENTRY] User 10, Symbol AUDCAD, Positions count: 2
2025-06-27 05:07:24,855 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_POS_DETAIL] User 10, Symbol AUDCAD, Pos 1 (ID: 387): Type=SELL, Qty=0.01000000, StoredMargin=6.53460704
2025-06-27 05:07:24,855 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_POS_DETAIL] User 10, Symbol AUDCAD, Pos 1: MarginPerLot=653.460704
2025-06-27 05:07:24,855 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_POS_DETAIL] User 10, Symbol AUDCAD, Pos 2 (ID: 389): Type=SELL, Qty=0.01000000, StoredMargin=6.53470279
2025-06-27 05:07:24,855 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_POS_DETAIL] User 10, Symbol AUDCAD, Pos 2: MarginPerLot=653.470279
2025-06-27 05:07:24,855 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_CALC] User 10, Symbol AUDCAD: TotalBuyQty=0, TotalSellQty=0.02000000, NetQty=0.02000000
2025-06-27 05:07:24,855 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_CALC] User 10, Symbol AUDCAD: AllMarginsPerLot=[Decimal('653.460704'), Decimal('653.470279')], HighestMarginPerLot=653.470279
2025-06-27 05:07:24,855 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_EXIT] User 10, Symbol AUDCAD: CalculatedTotalMargin=13.07, ContributingOrders=2 (based on individual stored margins)
2025-06-27 05:07:24,856 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_ENTRY] User 10, Symbol AUDCAD, Positions count: 1
2025-06-27 05:07:24,856 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_POS_DETAIL] User 10, Symbol AUDCAD, Pos 1 (ID: 389): Type=SELL, Qty=0.01000000, StoredMargin=6.53470279
2025-06-27 05:07:24,856 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_POS_DETAIL] User 10, Symbol AUDCAD, Pos 1: MarginPerLot=653.470279
2025-06-27 05:07:24,856 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_CALC] User 10, Symbol AUDCAD: TotalBuyQty=0, TotalSellQty=0.01000000, NetQty=0.01000000
2025-06-27 05:07:24,857 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_CALC] User 10, Symbol AUDCAD: AllMarginsPerLot=[Decimal('653.470279')], HighestMarginPerLot=653.470279
2025-06-27 05:07:24,857 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_EXIT] User 10, Symbol AUDCAD: CalculatedTotalMargin=6.53, ContributingOrders=1 (based on individual stored margins)
2025-06-27 05:07:24,885 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of -0.01000000000000000000000000 CAD to USD for PnL on Close (user_id: 10, position: 4068750376)
2025-06-27 05:07:24,886 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CADUSD
2025-06-27 05:07:24,887 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-06-27 05:07:24,887 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CADUSD, trying inverse
2025-06-27 05:07:24,887 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCAD
2025-06-27 05:07:24,890 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('1.3651900000'), 'o': Decimal('1.3651800000')}
2025-06-27 05:07:24,890 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 1.3651900000
2025-06-27 05:07:24,890 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: -0.01000000000000000000000000 CAD / 1.3651900000 = -0.007324987730645551168701792424 USD
2025-06-27 05:07:25,065 - INFO - orders - Starting update_user_static_orders for user 10, user_type demo
2025-06-27 05:07:25,065 - INFO - orders - Using order model: DemoUserOrder
2025-06-27 05:07:25,075 - INFO - orders - Fetched 1 open orders for user 10
2025-06-27 05:07:25,089 - INFO - orders - Fetched 0 pending orders for user 10
2025-06-27 05:07:25,094 - INFO - orders - Updated static orders cache for user 10 with 1 open orders and 0 pending orders
2025-06-27 05:07:25,105 - INFO - orders - [PENDING_ORDER_EXECUTION_DEBUG] Published order execution notification for order 4068750376 to channel user:10:notifications
2025-06-27 05:07:25,112 - INFO - orders - [ORDER_CLOSE] Removed order 4068750376 from Redis pending orders (type: BUY_LIMIT)
2025-06-27 05:07:25,119 - INFO - orders - [ORDER_CLOSE] Removed order 4068750376 from Redis pending orders (type: SELL_LIMIT)
2025-06-27 05:07:25,123 - INFO - orders - [ORDER_CLOSE] Removed order 4068750376 from Redis pending orders (type: BUY_STOP)
2025-06-27 05:07:25,128 - INFO - orders - [ORDER_CLOSE] Removed order 4068750376 from Redis pending orders (type: SELL_STOP)
2025-06-27 05:07:25,128 - INFO - orders - [ORDER_CLOSE] Successfully closed order 4068750376 due to STOP_LOSS with robust margin/wallet logic.
2025-06-27 05:07:25,128 - INFO - orders - [ORDER_CLOSE] Order details - Net Profit: -0.21000000, Commission: 0.20, Swap: 0E-8
2025-06-27 05:07:25,128 - INFO - orders - [ORDER_CLOSE] User margin updated: 13.07000000 -> 6.53000000
2025-06-27 05:07:25,128 - INFO - orders - [ORDER_CLOSE] User wallet updated: 1559.93932766 -> 1559.72932766
2025-06-27 05:07:45,382 - INFO - orders - [PENDING_ORDER_EXECUTION][PORTFOLIO_UPDATE] user_id=9, user_type=live, group_name=Group B, free_margin=9542.857524182548521517149900, margin_level=147139.4071522734749078143282, balance=10000.00000000, equity=9549.347524182548521517149900
2025-06-27 05:07:46,093 - INFO - orders - [PENDING_ORDER_EXECUTION][PORTFOLIO_UPDATE] user_id=10, user_type=demo, group_name=Group B, free_margin=1553.106652540421327121834736, margin_level=23884.17538346740164045688723, balance=1559.72932766, equity=1559.636652540421327121834736
2025-06-27 05:08:11,878 - app.api.v1.endpoints.orders - INFO - [get_closed_orders] user_type: demo
2025-06-27 05:08:45,373 - INFO - orders - [PENDING_ORDER_EXECUTION][PORTFOLIO_UPDATE] user_id=9, user_type=live, group_name=Group B, free_margin=9542.926409544186279293820302, margin_level=147140.4685600028702510604053, balance=10000.00000000, equity=9549.416409544186279293820302
2025-06-27 05:08:46,098 - INFO - orders - [PENDING_ORDER_EXECUTION][PORTFOLIO_UPDATE] user_id=10, user_type=demo, group_name=Group B, free_margin=1553.135950452561178374973448, margin_level=23884.62404980951268568106352, balance=1559.72932766, equity=1559.665950452561178374973448
2025-06-27 05:10:47,096 - INFO - orders - Application starting up - Orders logging initialized
2025-06-27 05:10:47,096 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-06-27 05:10:58,851 - app.api.v1.endpoints.orders - INFO - [get_rejected_orders] user_type: live
2025-06-27 05:11:48,438 - INFO - orders - [PENDING_ORDER_EXECUTION][PORTFOLIO_UPDATE] user_id=9, user_type=live, group_name=Group B, free_margin=9543.046561534323353892732482, margin_level=147142.3199003747820322454928, balance=10000.00000000, equity=9549.536561534323353892732482
2025-06-27 05:11:49,858 - INFO - orders - [PENDING_ORDER_EXECUTION][PORTFOLIO_UPDATE] user_id=10, user_type=demo, group_name=Group B, free_margin=1553.179901344634598340182097, margin_level=23885.29711094386827473479475, balance=1559.72932766, equity=1559.709901344634598340182097
2025-06-27 05:12:48,706 - INFO - orders - [PENDING_ORDER_EXECUTION][PORTFOLIO_UPDATE] user_id=9, user_type=live, group_name=Group B, free_margin=9542.812415368249796633502284, margin_level=147138.7121012056979450462602, balance=10000.00000000, equity=9549.302415368249796633502284
2025-06-27 05:12:49,482 - INFO - orders - [PENDING_ORDER_EXECUTION][PORTFOLIO_UPDATE] user_id=10, user_type=demo, group_name=Group B, free_margin=1553.143283703956043956043956, margin_level=23884.73635074970970836208202, balance=1559.72932766, equity=1559.673283703956043956043956
2025-06-27 05:13:48,367 - INFO - orders - [PENDING_ORDER_EXECUTION][PORTFOLIO_UPDATE] user_id=9, user_type=live, group_name=Group B, free_margin=9542.595765605637681340826877, margin_level=147135.3738922286237494734496, balance=10000.00000000, equity=9549.085765605637681340826877
2025-06-27 05:13:48,951 - INFO - orders - [PENDING_ORDER_EXECUTION][PORTFOLIO_UPDATE] user_id=10, user_type=demo, group_name=Group B, free_margin=1553.201903034583287540755394, margin_level=23885.63404340862614916930159, balance=1559.72932766, equity=1559.731903034583287540755394
2025-06-27 05:14:41,824 - app.api.v1.endpoints.orders - INFO - [get_rejected_orders] user_type: live
2025-06-27 05:14:47,670 - INFO - orders - [PENDING_ORDER_EXECUTION][PORTFOLIO_UPDATE] user_id=9, user_type=live, group_name=Group B, free_margin=7987.591353895453635089124775, margin_level=123175.3675484661577055335096, balance=8445.00000000, equity=7994.081353895453635089124775
2025-06-27 05:14:48,144 - INFO - orders - [PENDING_ORDER_EXECUTION][PORTFOLIO_UPDATE] user_id=10, user_type=demo, group_name=Group B, free_margin=1553.143285958227747943117962, margin_level=23884.73638527148159177822300, balance=1559.72932766, equity=1559.673285958227747943117962
2025-06-27 05:15:47,736 - INFO - orders - [PENDING_ORDER_EXECUTION][PORTFOLIO_UPDATE] user_id=9, user_type=live, group_name=Group B, free_margin=7987.637726737927754274413598, margin_level=123176.0820760851734094670816, balance=8445.00000000, equity=7994.127726737927754274413598
2025-06-27 05:15:48,760 - INFO - orders - [PENDING_ORDER_EXECUTION][PORTFOLIO_UPDATE] user_id=10, user_type=demo, group_name=Group B, free_margin=1553.194572035087002073396781, margin_level=23885.52177695385914354359542, balance=1559.72932766, equity=1559.724572035087002073396781
2025-06-27 05:16:47,865 - INFO - orders - [PENDING_ORDER_EXECUTION][PORTFOLIO_UPDATE] user_id=9, user_type=live, group_name=Group B, free_margin=7987.794261113336003203844614, margin_level=123178.4940079096456579945241, balance=8445.00000000, equity=7994.284261113336003203844614
2025-06-27 05:16:48,253 - INFO - orders - [PENDING_ORDER_EXECUTION][PORTFOLIO_UPDATE] user_id=10, user_type=demo, group_name=Group B, free_margin=1553.201900028469253932551341, margin_level=23885.63399737318918732850446, balance=1559.72932766, equity=1559.731900028469253932551341
2025-06-27 05:17:20,053 - INFO - orders - Application starting up - Orders logging initialized
2025-06-27 05:17:20,053 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-06-27 05:17:27,619 - INFO - orders - Application starting up - Orders logging initialized
2025-06-27 05:17:27,619 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-06-27 05:18:09,572 - INFO - orders - Application starting up - Orders logging initialized
2025-06-27 05:18:09,572 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-06-27 05:18:17,623 - INFO - orders - Order close request received - Order ID: 8776888990, User ID: 9, Close Price: 0.52213
2025-06-27 05:18:17,623 - INFO - orders - user_to_operate_on: <app.database.models.User object at 0x000001AAE88A0690>, type: <class 'app.database.models.User'>, attrs: ['__abstract__', '__class__', '__delattr__', '__dict__', '__dir__', '__doc__', '__eq__', '__firstlineno__', '__format__', '__ge__', '__getattribute__', '__getstate__', '__gt__', '__hash__', '__init__', '__init_subclass__', '__le__', '__lt__', '__mapper__', '__module__', '__ne__', '__new__', '__reduce__', '__reduce_ex__', '__repr__', '__setattr__', '__sizeof__', '__static_attributes__', '__str__', '__subclasshook__', '__table__', '__table_args__', '__tablename__', '__weakref__', '_sa_class_manager', '_sa_instance_state', '_sa_registry', 'account_number', 'address_proof', 'address_proof_image', 'bank_account_number', 'bank_branch_name', 'bank_holder_name', 'bank_ifsc_code', 'city', 'country', 'created_at', 'email', 'fund_manager', 'group_name', 'hashed_password', 'id', 'id_proof', 'id_proof_image', 'isActive', 'is_self_trading', 'is_service_account', 'leverage', 'margin', 'metadata', 'money_requests', 'name', 'net_profit', 'orders', 'otps', 'phone_number', 'pincode', 'referred_by_id', 'reffered_code', 'registry', 'rock_orders', 'security_answer', 'security_question', 'state', 'status', 'updated_at', 'user_favorites', 'user_type', 'wallet_balance', 'wallet_transactions']
2025-06-27 05:18:17,624 - INFO - orders - Using order model: user_orders for user 9 (User)
2025-06-27 05:18:17,624 - INFO - orders - Request to close order 8776888990 for user 9 (User) with price 0.52213. Frontend provided type: BUY, company: AUDCHF, status: CLOSED, frontend_status: CLOSED.
2025-06-27 05:18:18,082 - INFO - orders - User group: Group B, sending_orders setting: barclays
2025-06-27 05:18:18,082 - INFO - orders - Live user 9 from group 'Group B' has 'sending_orders' set to 'barclays'. Pushing close request to Firebase and skipping local DB update.
2025-06-27 05:18:18,105 - INFO - orders - [FIREBASE_CLOSE_REQUEST] Preparing to send payload for user-initiated close: {'order_id': '8776888990', 'close_price': '0.52213', 'user_id': 9, 'order_type': 'BUY', 'order_company_name': 'AUDCHF', 'order_quantity': '0.01000000', 'contract_value': '1000.00000000', 'order_status': 'CLOSED', 'status': 'CLOSED', 'action': 'close_order', 'close_id': '6562078955'}
2025-06-27 05:19:10,286 - INFO - orders - [PENDING_ORDER_EXECUTION][PORTFOLIO_UPDATE] user_id=9, user_type=live, group_name=Group B, free_margin=7988.027078786665331865051557, margin_level=123182.0813372367539578590379, balance=8445.00000000, equity=7994.517078786665331865051557
2025-06-27 05:19:10,789 - INFO - orders - [PENDING_ORDER_EXECUTION][PORTFOLIO_UPDATE] user_id=10, user_type=demo, group_name=Group B, free_margin=1553.128636627811426101101284, margin_level=23884.51204636770943493263835, balance=1559.72932766, equity=1559.658636627811426101101284
2025-06-27 05:19:16,232 - app.api.v1.endpoints.orders - INFO - [get_rejected_orders] user_type: demo
2025-06-27 05:19:31,143 - INFO - orders - Add takeprofit request received - Order ID: 7794553013, User ID: 10
2025-06-27 05:19:31,166 - INFO - orders - Generated takeprofit_id: 6929865576 for order 7794553013
2025-06-27 05:19:31,172 - INFO - orders - User 10 is_barclays_live_user: False
2025-06-27 05:19:31,172 - INFO - orders - Non-Barclays user. Adding takeprofit to order 7794553013 immediately
2025-06-27 05:19:31,207 - INFO - orders - Starting update_user_static_orders for user 10, user_type demo
2025-06-27 05:19:31,208 - INFO - orders - Using order model: DemoUserOrder
2025-06-27 05:19:31,220 - INFO - orders - Fetched 1 open orders for user 10
2025-06-27 05:19:31,227 - INFO - orders - Fetched 0 pending orders for user 10
2025-06-27 05:19:31,231 - INFO - orders - Updated static orders cache for user 10 with 1 open orders and 0 pending orders
2025-06-27 05:19:33,380 - INFO - orders - [ORDER_CLOSE] Closing demo order 7794553013 at price 0.8921900000 due to TAKE_PROFIT
2025-06-27 05:19:33,395 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_ENTRY] User 10, Symbol AUDCAD, Positions count: 1
2025-06-27 05:19:33,395 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_POS_DETAIL] User 10, Symbol AUDCAD, Pos 1 (ID: 389): Type=SELL, Qty=0.01000000, StoredMargin=6.53470279
2025-06-27 05:19:33,395 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_POS_DETAIL] User 10, Symbol AUDCAD, Pos 1: MarginPerLot=653.470279
2025-06-27 05:19:33,395 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_CALC] User 10, Symbol AUDCAD: TotalBuyQty=0, TotalSellQty=0.01000000, NetQty=0.01000000
2025-06-27 05:19:33,395 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_CALC] User 10, Symbol AUDCAD: AllMarginsPerLot=[Decimal('653.470279')], HighestMarginPerLot=653.470279
2025-06-27 05:19:33,395 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_EXIT] User 10, Symbol AUDCAD: CalculatedTotalMargin=6.53, ContributingOrders=1 (based on individual stored margins)
2025-06-27 05:19:33,395 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_ENTRY] User 10, Symbol AUDCAD, Positions count: 0
2025-06-27 05:19:33,395 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB] No open positions for User 10, Symbol AUDCAD. Returning zero margin.
2025-06-27 05:19:33,412 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 0.04000000000000000000000000 CAD to USD for PnL on Close (user_id: 10, position: 7794553013)
2025-06-27 05:19:33,412 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CADUSD
2025-06-27 05:19:33,414 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-06-27 05:19:33,414 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CADUSD, trying inverse
2025-06-27 05:19:33,414 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCAD
2025-06-27 05:19:33,416 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('1.3647700000'), 'o': Decimal('1.3647400000')}
2025-06-27 05:19:33,416 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 1.3647700000
2025-06-27 05:19:33,416 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 0.04000000000000000000000000 CAD / 1.3647700000 = 0.02930896781142610110128446551 USD
2025-06-27 05:19:33,523 - INFO - orders - Starting update_user_static_orders for user 10, user_type demo
2025-06-27 05:19:33,523 - INFO - orders - Using order model: DemoUserOrder
2025-06-27 05:19:33,531 - INFO - orders - Fetched 0 open orders for user 10
2025-06-27 05:19:33,541 - INFO - orders - Fetched 0 pending orders for user 10
2025-06-27 05:19:33,543 - INFO - orders - Updated static orders cache for user 10 with 0 open orders and 0 pending orders
2025-06-27 05:19:33,552 - INFO - orders - [PENDING_ORDER_EXECUTION_DEBUG] Published order execution notification for order 7794553013 to channel user:10:notifications
2025-06-27 05:19:33,555 - INFO - orders - [ORDER_CLOSE] Removed order 7794553013 from Redis pending orders (type: BUY_LIMIT)
2025-06-27 05:19:33,562 - INFO - orders - [ORDER_CLOSE] Removed order 7794553013 from Redis pending orders (type: SELL_LIMIT)
2025-06-27 05:19:33,568 - INFO - orders - [ORDER_CLOSE] Removed order 7794553013 from Redis pending orders (type: BUY_STOP)
2025-06-27 05:19:33,572 - INFO - orders - [ORDER_CLOSE] Removed order 7794553013 from Redis pending orders (type: SELL_STOP)
2025-06-27 05:19:33,572 - INFO - orders - [ORDER_CLOSE] Successfully closed order 7794553013 due to TAKE_PROFIT with robust margin/wallet logic.
2025-06-27 05:19:33,572 - INFO - orders - [ORDER_CLOSE] Order details - Net Profit: -0.17000000, Commission: 0.20, Swap: 0E-8
2025-06-27 05:19:33,572 - INFO - orders - [ORDER_CLOSE] User margin updated: 6.53000000 -> 0E-8
2025-06-27 05:19:33,573 - INFO - orders - [ORDER_CLOSE] User wallet updated: 1559.72932766 -> 1559.55932766
2025-06-27 05:25:30,014 - INFO - orders - Application starting up - Orders logging initialized
2025-06-27 05:25:30,014 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-06-27 05:26:24,359 - INFO - orders - Order placement request received - User ID: 10, Symbol: AUDCAD, Type: BUY, Quantity: 2
2025-06-27 05:26:24,404 - INFO - orders - [DEBUG] db_group_result fetched from DB: [<app.database.models.Group object at 0x000002D79F9EDAE0>, <app.database.models.Group object at 0x000002D79F9ED9D0>, <app.database.models.Group object at 0x000002D79F9EE8B0>, <app.database.models.Group object at 0x000002D79F9EE9C0>, <app.database.models.Group object at 0x000002D79F9EEAD0>, <app.database.models.Group object at 0x000002D79F9EEBE0>, <app.database.models.Group object at 0x000002D79F9EECF0>, <app.database.models.Group object at 0x000002D79F9EEE00>, <app.database.models.Group object at 0x000002D79F9EEF10>, <app.database.models.Group object at 0x000002D79F9EF020>, <app.database.models.Group object at 0x000002D79F9EF130>, <app.database.models.Group object at 0x000002D79F9EF240>, <app.database.models.Group object at 0x000002D79F9EF350>, <app.database.models.Group object at 0x000002D79F9EF460>, <app.database.models.Group object at 0x000002D79F9EF570>, <app.database.models.Group object at 0x000002D79F9EF680>, <app.database.models.Group object at 0x000002D79F9EF790>, <app.database.models.Group object at 0x000002D79F9EF8A0>, <app.database.models.Group object at 0x000002D79F9EF9B0>, <app.database.models.Group object at 0x000002D79F9EFAC0>, <app.database.models.Group object at 0x000002D79F9EFBD0>, <app.database.models.Group object at 0x000002D79F9EFCE0>, <app.database.models.Group object at 0x000002D79F9EFDF0>, <app.database.models.Group object at 0x000002D79F9EFF00>, <app.database.models.Group object at 0x000002D79F9ED7B0>, <app.database.models.Group object at 0x000002D79F9EC7C0>, <app.database.models.Group object at 0x000002D79FA7B350>, <app.database.models.Group object at 0x000002D79FA7B680>, <app.database.models.Group object at 0x000002D79FA7AF10>, <app.database.models.Group object at 0x000002D79FA7AAD0>, <app.database.models.Group object at 0x000002D79FA7B240>, <app.database.models.Group object at 0x000002D79FA7A9C0>, <app.database.models.Group object at 0x000002D79FA79590>, <app.database.models.Group object at 0x000002D79FA79260>, <app.database.models.Group object at 0x000002D79FA79480>, <app.database.models.Group object at 0x000002D79FA79150>, <app.database.models.Group object at 0x000002D79FA78050>, <app.database.models.Group object at 0x000002D79FA78160>, <app.database.models.Group object at 0x000002D79FA78270>, <app.database.models.Group object at 0x000002D79FA78380>, <app.database.models.Group object at 0x000002D79FA78490>, <app.database.models.Group object at 0x000002D79FA785A0>, <app.database.models.Group object at 0x000002D79FA786B0>, <app.database.models.Group object at 0x000002D79FA787C0>, <app.database.models.Group object at 0x000002D79FA788D0>, <app.database.models.Group object at 0x000002D79FA789E0>, <app.database.models.Group object at 0x000002D79FA78AF0>, <app.database.models.Group object at 0x000002D79FA78C00>, <app.database.models.Group object at 0x000002D79FA78D10>, <app.database.models.Group object at 0x000002D79FA78E20>, <app.database.models.Group object at 0x000002D79FA78F30>, <app.database.models.Group object at 0x000002D79FA79040>, <app.database.models.Group object at 0x000002D79FA798C0>, <app.database.models.Group object at 0x000002D79FA796A0>, <app.database.models.Group object at 0x000002D79FA797B0>, <app.database.models.Group object at 0x000002D79FA799D0>, <app.database.models.Group object at 0x000002D79FA79AE0>, <app.database.models.Group object at 0x000002D79FA79BF0>, <app.database.models.Group object at 0x000002D79FA79D00>, <app.database.models.Group object at 0x000002D79FA79E10>, <app.database.models.Group object at 0x000002D79FA79F20>, <app.database.models.Group object at 0x000002D79FA7A030>, <app.database.models.Group object at 0x000002D79FA7A140>, <app.database.models.Group object at 0x000002D79FA7A250>, <app.database.models.Group object at 0x000002D79FA7A360>, <app.database.models.Group object at 0x000002D79FA7A470>, <app.database.models.Group object at 0x000002D79FA7A580>, <app.database.models.Group object at 0x000002D79FA7A690>, <app.database.models.Group object at 0x000002D79FA7A7A0>, <app.database.models.Group object at 0x000002D79FA7A8B0>, <app.database.models.Group object at 0x000002D79FA7BAC0>, <app.database.models.Group object at 0x000002D79FA7B130>, <app.database.models.Group object at 0x000002D79FB61260>, <app.database.models.Group object at 0x000002D79FB61370>, <app.database.models.Group object at 0x000002D79FB61480>, <app.database.models.Group object at 0x000002D79FB61590>, <app.database.models.Group object at 0x000002D79FB616A0>, <app.database.models.Group object at 0x000002D79FB617B0>, <app.database.models.Group object at 0x000002D79FB618C0>]
2025-06-27 05:26:24,404 - INFO - orders - [DEBUG] Number of group records found: 79
2025-06-27 05:26:24,404 - INFO - orders - [DEBUG] sending_orders_cache extracted from DB: barclays
2025-06-27 05:26:24,405 - INFO - orders - [DEBUG] group_settings_cache: None
2025-06-27 05:26:24,405 - INFO - orders - [DEBUG] sending_orders_cache value: barclays (type: <class 'str'>)
2025-06-27 05:26:24,405 - INFO - orders - Order placement: user_id=10, is_barclays_live_user=False, user_type=demo, group_name=Group B, sending_orders_setting=barclays
2025-06-27 05:26:24,732 - INFO - orders - [ORDER_MARGIN_CALC] Calculating margin for AUDCAD BUY order, quantity: 2
2025-06-27 05:26:24,732 - INFO - orders - [ORDER_MARGIN_CALC] Contract size for AUDCAD: 100000.00000000 (raw: 100000.00000000, type: <class 'decimal.Decimal'>)
2025-06-27 05:26:24,740 - INFO - orders - [ORDER_MARGIN_CALC] Got BUY price for AUDCAD from cache: 0.8921800000
2025-06-27 05:26:24,740 - INFO - orders - [ORDER_MARGIN_CALC] Contract value calculation for AUDCAD:
2025-06-27 05:26:24,741 - INFO - orders - [ORDER_MARGIN_CALC] Contract value = quantity * contract_size = 2 * 100000.00000000 = 200000.00000000
2025-06-27 05:26:24,741 - INFO - orders - [ORDER_MARGIN_CALC] Margin calculation: (contract_value * price) / leverage = (200000.00000000 * 0.8921800000) / 100.00 = 1784.3600000000000000 (rounded to 1784.36)
2025-06-27 05:26:24,741 - INFO - orders - [ORDER_MARGIN_CALC] Commission settings for AUDCAD: type=0, value_type=0, rate=10.0000
2025-06-27 05:26:24,742 - INFO - orders - [ORDER_MARGIN_CALC] Per lot commission: 2 * 10.0000 = 20.0000
2025-06-27 05:26:24,742 - INFO - orders - [ORDER_MARGIN_CALC] Profit currency for AUDCAD: CAD
2025-06-27 05:26:24,743 - INFO - orders - [ORDER_MARGIN_CALC] Converting margin from CAD to USD: 1784.36 CAD
2025-06-27 05:26:24,744 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 1784.36 CAD to USD for margin for AUDCAD BUY order (user_id: 10, position: )
2025-06-27 05:26:24,744 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CADUSD
2025-06-27 05:26:24,779 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-06-27 05:26:24,780 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CADUSD, trying inverse
2025-06-27 05:26:24,783 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCAD
2025-06-27 05:26:24,790 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('1.3648700000'), 'o': Decimal('1.3648400000')}
2025-06-27 05:26:24,790 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 1.3648700000
2025-06-27 05:26:24,790 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 1784.36 CAD / 1.3648700000 = 1307.347952552257724178859525 USD
2025-06-27 05:26:24,790 - INFO - orders - [ORDER_MARGIN_CALC] Margin after USD conversion: 1784.36 CAD -> 1307.347952552257724178859525 USD
2025-06-27 05:26:24,790 - INFO - orders - [ORDER_MARGIN_CALC] Final results for AUDCAD BUY: margin=1307.347952552257724178859525, price=0.8921800000, contract_value=200000.00000000, commission=20.00
2025-06-27 05:26:24,790 - app.services.order_processing - INFO - [COMMISSION_CALC] User 10 Symbol AUDCAD: Calculated commission=20.00
2025-06-27 05:26:24,805 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_ENTRY] User 10, Symbol AUDCAD, Positions count: 0
2025-06-27 05:26:24,806 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB] No open positions for User 10, Symbol AUDCAD. Returning zero margin.
2025-06-27 05:26:24,806 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_ENTRY] User 10, Symbol AUDCAD, Positions count: 1
2025-06-27 05:26:24,806 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_POS_DETAIL] User 10, Symbol AUDCAD, Pos 1 (ID: None): Type=BUY, Qty=2, StoredMargin=1307.347952552257724178859525
2025-06-27 05:26:24,806 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_POS_DETAIL] User 10, Symbol AUDCAD, Pos 1: MarginPerLot=653.6739762761288620894297625
2025-06-27 05:26:24,806 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_CALC] User 10, Symbol AUDCAD: TotalBuyQty=2, TotalSellQty=0, NetQty=2
2025-06-27 05:26:24,806 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_CALC] User 10, Symbol AUDCAD: AllMarginsPerLot=[Decimal('653.6739762761288620894297625')], HighestMarginPerLot=653.6739762761288620894297625
2025-06-27 05:26:24,806 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_EXIT] User 10, Symbol AUDCAD: CalculatedTotalMargin=1307.35, ContributingOrders=1 (based on individual stored margins)
2025-06-27 05:26:24,806 - app.services.order_processing - INFO - [MARGIN_PROCESS] User 10 Symbol AUDCAD: MarginBefore=0.00, MarginAfter=1307.35, AdditionalMargin=1307.35
2025-06-27 05:26:24,806 - app.services.order_processing - INFO - [MARGIN_PROCESS_DEBUG] User 10 Symbol AUDCAD
2025-06-27 05:26:24,806 - app.services.order_processing - INFO - [MARGIN_PROCESS_DEBUG] Full margin for this order: 1307.347952552257724178859525
2025-06-27 05:26:24,807 - app.services.order_processing - INFO - [MARGIN_PROCESS_DEBUG] Existing open orders count: 0
2025-06-27 05:26:24,807 - app.services.order_processing - INFO - [MARGIN_PROCESS_DEBUG] Total margin before: 0.0
2025-06-27 05:26:24,807 - app.services.order_processing - INFO - [MARGIN_PROCESS_DEBUG] Total margin after: 1307.35
2025-06-27 05:26:24,807 - app.services.order_processing - INFO - [MARGIN_PROCESS_DEBUG] Additional margin needed: 1307.35
2025-06-27 05:26:24,819 - app.services.order_processing - INFO - [MARGIN_PROCESS] User 10: OriginalMarginDB=0E-8, CalculatedNewMargin=1307.35
2025-06-27 05:26:24,978 - INFO - orders - [PRE-CRUD] About to call create_order with: {'order_id': '3859192777', 'order_status': 'OPEN', 'order_user_id': 10, 'order_company_name': 'AUDCAD', 'order_type': 'BUY', 'order_price': Decimal('0.8921800000'), 'order_quantity': Decimal('2'), 'contract_value': Decimal('200000.00000000'), 'margin': Decimal('1307.347952552257724178859525'), 'commission': Decimal('20.00'), 'stop_loss': None, 'take_profit': None, 'stoploss_id': None, 'takeprofit_id': None, 'status': 'OPEN'}
2025-06-27 05:26:25,078 - INFO - orders - [MARGIN_COMMIT_CHECK] User 10 margin in session BEFORE commit: 1307.35000000
2025-06-27 05:26:25,140 - INFO - orders - User data cache updated for user 10 after placing order
2025-06-27 05:26:26,360 - INFO - orders - Portfolio cache updated and websocket event published for user 10 after placing order.
2025-06-27 05:26:26,393 - INFO - orders - Starting update_user_static_orders for user 10, user_type demo
2025-06-27 05:26:26,394 - INFO - orders - Using order model: DemoUserOrder
2025-06-27 05:26:26,450 - INFO - orders - Fetched 1 open orders for user 10
2025-06-27 05:26:26,485 - INFO - orders - Fetched 0 pending orders for user 10
2025-06-27 05:26:26,504 - INFO - orders - Updated static orders cache for user 10 with 1 open orders and 0 pending orders
2025-06-27 05:26:30,789 - INFO - orders - [PENDING_ORDER_EXECUTION][PORTFOLIO_UPDATE] user_id=9, user_type=live, group_name=Group B, free_margin=7987.180866467133357544487997, margin_level=123169.0426266122243073110631, balance=8445.00000000, equity=7993.670866467133357544487997
2025-06-27 05:26:31,384 - INFO - orders - [PENDING_ORDER_EXECUTION][PORTFOLIO_UPDATE] user_id=10, user_type=demo, group_name=Group B, free_margin=232.2093276600000000, margin_level=117.7618333009523081041802119, balance=1559.55932766, equity=1539.5593276600000000
2025-06-27 05:27:30,595 - INFO - orders - [PENDING_ORDER_EXECUTION][PORTFOLIO_UPDATE] user_id=9, user_type=live, group_name=Group B, free_margin=7987.135205369665397715888600, margin_level=123168.3390657883728461616117, balance=8445.00000000, equity=7993.625205369665397715888600
2025-06-27 05:27:31,328 - INFO - orders - [PENDING_ORDER_EXECUTION][PORTFOLIO_UPDATE] user_id=10, user_type=demo, group_name=Group B, free_margin=245.394595320933516950394093, margin_level=118.7703824776022883658082452, balance=1559.55932766, equity=1552.744595320933516950394093
2025-06-27 05:28:31,537 - INFO - orders - [PENDING_ORDER_EXECUTION][PORTFOLIO_UPDATE] user_id=9, user_type=live, group_name=Group B, free_margin=7987.119023064786757156094263, margin_level=123168.0897236484862427749501, balance=8445.00000000, equity=7993.609023064786757156094263
2025-06-27 05:28:32,252 - INFO - orders - [PENDING_ORDER_EXECUTION][PORTFOLIO_UPDATE] user_id=10, user_type=demo, group_name=Group B, free_margin=235.139580321035697803043067, margin_level=117.9859701167274025932644714, balance=1559.55932766, equity=1542.489580321035697803043067
2025-06-27 05:29:31,750 - INFO - orders - [PENDING_ORDER_EXECUTION][PORTFOLIO_UPDATE] user_id=9, user_type=live, group_name=Group B, free_margin=7987.446054081121682523785678, margin_level=123173.1287223593479587640320, balance=8445.00000000, equity=7993.936054081121682523785678
2025-06-27 05:29:32,631 - INFO - orders - [PENDING_ORDER_EXECUTION][PORTFOLIO_UPDATE] user_id=10, user_type=demo, group_name=Group B, free_margin=88.642723010199967770762222, margin_level=106.7803360240333474410649193, balance=1559.55932766, equity=1395.992723010199967770762222
2025-06-27 05:30:31,739 - INFO - orders - [PENDING_ORDER_EXECUTION][PORTFOLIO_UPDATE] user_id=9, user_type=live, group_name=Group B, free_margin=7987.059291770511102483499693, margin_level=123167.1693647228213017488396, balance=8445.00000000, equity=7993.549291770511102483499693
2025-06-27 05:30:32,312 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of -1384.000000000000000000000000 CAD to USD for PnL on Auto-Cutoff (user_id: 10, position: 3859192777)
2025-06-27 05:30:32,312 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CADUSD
2025-06-27 05:30:32,313 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-06-27 05:30:32,313 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CADUSD, trying inverse
2025-06-27 05:30:32,313 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCAD
2025-06-27 05:30:32,317 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('1.3649500000'), 'o': Decimal('1.3649500000')}
2025-06-27 05:30:32,317 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 1.3649500000
2025-06-27 05:30:32,317 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: -1384.000000000000000000000000 CAD / 1.3649500000 = -1013.956555185171618007985640 USD
2025-06-27 05:30:32,361 - INFO - orders - [PENDING_ORDER_EXECUTION][PORTFOLIO_UPDATE] user_id=10, user_type=demo, group_name=Group B, free_margin=-781.762084793385887920992285, margin_level=40.20254065144101518942958772, balance=1559.55932766, equity=525.587915206614112079007715
2025-06-27 05:34:16,656 - INFO - orders - Application starting up - Orders logging initialized
2025-06-27 05:34:16,657 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-06-27 05:35:17,741 - INFO - orders - [PENDING_ORDER_EXECUTION][PORTFOLIO_UPDATE] user_id=9, user_type=live, group_name=Group B, free_margin=7985.399463120923231309583542, margin_level=123141.5941929263980170968188, balance=8445.00000000, equity=7991.889463120923231309583542
2025-06-27 05:36:18,185 - INFO - orders - [PENDING_ORDER_EXECUTION][PORTFOLIO_UPDATE] user_id=9, user_type=live, group_name=Group B, free_margin=7986.053532569164012139757706, margin_level=123151.6723046096149790409508, balance=8445.00000000, equity=7992.543532569164012139757706
2025-06-27 05:36:50,772 - INFO - orders - Application starting up - Orders logging initialized
2025-06-27 05:36:50,772 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-06-27 05:37:07,515 - INFO - orders - Order placement request received - User ID: 10, Symbol: AUDCAD, Type: BUY, Quantity: 0.01
2025-06-27 05:37:07,552 - INFO - orders - [DEBUG] db_group_result fetched from DB: [<app.database.models.Group object at 0x000002532E1D6360>, <app.database.models.Group object at 0x000002532E1D6470>, <app.database.models.Group object at 0x000002532E1D6580>, <app.database.models.Group object at 0x000002532E1D6690>, <app.database.models.Group object at 0x000002532E1D67A0>, <app.database.models.Group object at 0x000002532E1D68B0>, <app.database.models.Group object at 0x000002532E1D69C0>, <app.database.models.Group object at 0x000002532E1D6AD0>, <app.database.models.Group object at 0x000002532E1D6BE0>, <app.database.models.Group object at 0x000002532E1D6CF0>, <app.database.models.Group object at 0x000002532E1D6E00>, <app.database.models.Group object at 0x000002532E1D6F10>, <app.database.models.Group object at 0x000002532E1D7020>, <app.database.models.Group object at 0x000002532E1D7130>, <app.database.models.Group object at 0x000002532E1D7240>, <app.database.models.Group object at 0x000002532E1D7350>, <app.database.models.Group object at 0x000002532E1D7460>, <app.database.models.Group object at 0x000002532E1D7570>, <app.database.models.Group object at 0x000002532E1D7680>, <app.database.models.Group object at 0x000002532E1D7790>, <app.database.models.Group object at 0x000002532E1D78A0>, <app.database.models.Group object at 0x000002532E1D79B0>, <app.database.models.Group object at 0x000002532E1D7AC0>, <app.database.models.Group object at 0x000002532E1D7BD0>, <app.database.models.Group object at 0x000002532E1D7CE0>, <app.database.models.Group object at 0x000002532E1D7DF0>, <app.database.models.Group object at 0x000002532E1D7F00>, <app.database.models.Group object at 0x000002532E1D4270>, <app.database.models.Group object at 0x000002532E1D5150>, <app.database.models.Group object at 0x000002532E3096A0>, <app.database.models.Group object at 0x000002532E309260>, <app.database.models.Group object at 0x000002532E309590>, <app.database.models.Group object at 0x000002532E3098C0>, <app.database.models.Group object at 0x000002532E308F30>, <app.database.models.Group object at 0x000002532E3087C0>, <app.database.models.Group object at 0x000002532E309D00>, <app.database.models.Group object at 0x000002532E3086B0>, <app.database.models.Group object at 0x000002532E309E10>, <app.database.models.Group object at 0x000002532E309480>, <app.database.models.Group object at 0x000002532E3097B0>, <app.database.models.Group object at 0x000002532E309040>, <app.database.models.Group object at 0x000002532E30A030>, <app.database.models.Group object at 0x000002532E30A690>, <app.database.models.Group object at 0x000002532E30A250>, <app.database.models.Group object at 0x000002532E309370>, <app.database.models.Group object at 0x000002532E30A140>, <app.database.models.Group object at 0x000002532E308380>, <app.database.models.Group object at 0x000002532E30ACF0>, <app.database.models.Group object at 0x000002532E3859D0>, <app.database.models.Group object at 0x000002532E384160>, <app.database.models.Group object at 0x000002532E384270>, <app.database.models.Group object at 0x000002532E384380>, <app.database.models.Group object at 0x000002532E384490>, <app.database.models.Group object at 0x000002532E3845A0>, <app.database.models.Group object at 0x000002532E3846B0>, <app.database.models.Group object at 0x000002532E3847C0>, <app.database.models.Group object at 0x000002532E3848D0>, <app.database.models.Group object at 0x000002532E3849E0>, <app.database.models.Group object at 0x000002532E384AF0>, <app.database.models.Group object at 0x000002532E384C00>, <app.database.models.Group object at 0x000002532E384D10>, <app.database.models.Group object at 0x000002532E384E20>, <app.database.models.Group object at 0x000002532E384F30>, <app.database.models.Group object at 0x000002532E385040>, <app.database.models.Group object at 0x000002532E385150>, <app.database.models.Group object at 0x000002532E385260>, <app.database.models.Group object at 0x000002532E385370>, <app.database.models.Group object at 0x000002532E385480>, <app.database.models.Group object at 0x000002532E385590>, <app.database.models.Group object at 0x000002532E3856A0>, <app.database.models.Group object at 0x000002532E3857B0>, <app.database.models.Group object at 0x000002532E3858C0>, <app.database.models.Group object at 0x000002532E385AE0>, <app.database.models.Group object at 0x000002532E385BF0>, <app.database.models.Group object at 0x000002532E385D00>, <app.database.models.Group object at 0x000002532E385E10>, <app.database.models.Group object at 0x000002532E385F20>, <app.database.models.Group object at 0x000002532E386030>, <app.database.models.Group object at 0x000002532E386140>]
2025-06-27 05:37:07,553 - INFO - orders - [DEBUG] Number of group records found: 79
2025-06-27 05:37:07,553 - INFO - orders - [DEBUG] sending_orders_cache extracted from DB: barclays
2025-06-27 05:37:07,553 - INFO - orders - [DEBUG] group_settings_cache: None
2025-06-27 05:37:07,553 - INFO - orders - [DEBUG] sending_orders_cache value: barclays (type: <class 'str'>)
2025-06-27 05:37:07,553 - INFO - orders - Order placement: user_id=10, is_barclays_live_user=False, user_type=demo, group_name=Group B, sending_orders_setting=barclays
2025-06-27 05:37:07,922 - INFO - orders - [ORDER_MARGIN_CALC] Calculating margin for AUDCAD BUY order, quantity: 0.01
2025-06-27 05:37:07,922 - INFO - orders - [ORDER_MARGIN_CALC] Contract size for AUDCAD: 100000.00000000 (raw: 100000.00000000, type: <class 'decimal.Decimal'>)
2025-06-27 05:37:07,929 - INFO - orders - [ORDER_MARGIN_CALC] Got BUY price for AUDCAD from cache: 0.8927000000
2025-06-27 05:37:07,929 - INFO - orders - [ORDER_MARGIN_CALC] Contract value calculation for AUDCAD:
2025-06-27 05:37:07,929 - INFO - orders - [ORDER_MARGIN_CALC] Contract value = quantity * contract_size = 0.01 * 100000.00000000 = 1000.0000000000
2025-06-27 05:37:07,930 - INFO - orders - [ORDER_MARGIN_CALC] Margin calculation: (contract_value * price) / leverage = (1000.0000000000 * 0.8927000000) / 100.00 = 8.927000000000000000 (rounded to 8.93)
2025-06-27 05:37:07,930 - INFO - orders - [ORDER_MARGIN_CALC] Commission settings for AUDCAD: type=0, value_type=0, rate=10.0000
2025-06-27 05:37:07,930 - INFO - orders - [ORDER_MARGIN_CALC] Per lot commission: 0.01 * 10.0000 = 0.100000
2025-06-27 05:37:07,930 - INFO - orders - [ORDER_MARGIN_CALC] Profit currency for AUDCAD: CAD
2025-06-27 05:37:07,930 - INFO - orders - [ORDER_MARGIN_CALC] Converting margin from CAD to USD: 8.93 CAD
2025-06-27 05:37:07,930 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 8.93 CAD to USD for margin for AUDCAD BUY order (user_id: 10, position: )
2025-06-27 05:37:07,930 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CADUSD
2025-06-27 05:37:07,949 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-06-27 05:37:07,949 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CADUSD, trying inverse
2025-06-27 05:37:07,950 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCAD
2025-06-27 05:37:07,985 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('1.3646500000'), 'o': Decimal('1.3646200000')}
2025-06-27 05:37:07,985 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 1.3646500000
2025-06-27 05:37:07,985 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 8.93 CAD / 1.3646500000 = 6.543802440186128311288608801 USD
2025-06-27 05:37:07,985 - INFO - orders - [ORDER_MARGIN_CALC] Margin after USD conversion: 8.93 CAD -> 6.543802440186128311288608801 USD
2025-06-27 05:37:07,986 - INFO - orders - [ORDER_MARGIN_CALC] Final results for AUDCAD BUY: margin=6.543802440186128311288608801, price=0.8927000000, contract_value=1000.0000000000, commission=0.10
2025-06-27 05:37:07,986 - app.services.order_processing - INFO - [COMMISSION_CALC] User 10 Symbol AUDCAD: Calculated commission=0.10
2025-06-27 05:37:08,037 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_ENTRY] User 10, Symbol AUDCAD, Positions count: 0
2025-06-27 05:37:08,038 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB] No open positions for User 10, Symbol AUDCAD. Returning zero margin.
2025-06-27 05:37:08,038 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_ENTRY] User 10, Symbol AUDCAD, Positions count: 1
2025-06-27 05:37:08,038 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_POS_DETAIL] User 10, Symbol AUDCAD, Pos 1 (ID: None): Type=BUY, Qty=0.01, StoredMargin=6.543802440186128311288608801
2025-06-27 05:37:08,038 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_POS_DETAIL] User 10, Symbol AUDCAD, Pos 1: MarginPerLot=654.3802440186128311288608801
2025-06-27 05:37:08,038 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_CALC] User 10, Symbol AUDCAD: TotalBuyQty=0.01, TotalSellQty=0, NetQty=0.01
2025-06-27 05:37:08,038 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_CALC] User 10, Symbol AUDCAD: AllMarginsPerLot=[Decimal('654.3802440186128311288608801')], HighestMarginPerLot=654.3802440186128311288608801
2025-06-27 05:37:08,038 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_EXIT] User 10, Symbol AUDCAD: CalculatedTotalMargin=6.54, ContributingOrders=1 (based on individual stored margins)
2025-06-27 05:37:08,039 - app.services.order_processing - INFO - [MARGIN_PROCESS] User 10 Symbol AUDCAD: MarginBefore=0.00, MarginAfter=6.54, AdditionalMargin=6.54
2025-06-27 05:37:08,039 - app.services.order_processing - INFO - [MARGIN_PROCESS_DEBUG] User 10 Symbol AUDCAD
2025-06-27 05:37:08,039 - app.services.order_processing - INFO - [MARGIN_PROCESS_DEBUG] Full margin for this order: 6.543802440186128311288608801
2025-06-27 05:37:08,039 - app.services.order_processing - INFO - [MARGIN_PROCESS_DEBUG] Existing open orders count: 0
2025-06-27 05:37:08,039 - app.services.order_processing - INFO - [MARGIN_PROCESS_DEBUG] Total margin before: 0.0
2025-06-27 05:37:08,039 - app.services.order_processing - INFO - [MARGIN_PROCESS_DEBUG] Total margin after: 6.54
2025-06-27 05:37:08,039 - app.services.order_processing - INFO - [MARGIN_PROCESS_DEBUG] Additional margin needed: 6.54
2025-06-27 05:37:08,068 - app.services.order_processing - INFO - [MARGIN_PROCESS] User 10: OriginalMarginDB=0E-8, CalculatedNewMargin=6.54
2025-06-27 05:37:08,209 - INFO - orders - [PRE-CRUD] About to call create_order with: {'order_id': '3788252355', 'order_status': 'OPEN', 'order_user_id': 10, 'order_company_name': 'AUDCAD', 'order_type': 'BUY', 'order_price': Decimal('0.8927000000'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('1000.0000000000'), 'margin': Decimal('6.543802440186128311288608801'), 'commission': Decimal('0.10'), 'stop_loss': None, 'take_profit': None, 'stoploss_id': None, 'takeprofit_id': None, 'status': 'OPEN'}
2025-06-27 05:37:08,318 - INFO - orders - [MARGIN_COMMIT_CHECK] User 10 margin in session BEFORE commit: 6.54000000
2025-06-27 05:37:08,409 - INFO - orders - User data cache updated for user 10 after placing order
2025-06-27 05:37:09,669 - INFO - orders - Portfolio cache updated and websocket event published for user 10 after placing order.
2025-06-27 05:37:09,673 - INFO - orders - Starting update_user_static_orders for user 10, user_type demo
2025-06-27 05:37:09,674 - INFO - orders - Using order model: DemoUserOrder
2025-06-27 05:37:09,716 - INFO - orders - Fetched 1 open orders for user 10
2025-06-27 05:37:09,890 - INFO - orders - Fetched 0 pending orders for user 10
2025-06-27 05:37:10,001 - INFO - orders - Updated static orders cache for user 10 with 1 open orders and 0 pending orders
2025-06-27 05:37:29,176 - INFO - orders - Order placement request received - User ID: 10, Symbol: AUDCAD, Type: BUY, Quantity: 0.6
2025-06-27 05:37:29,232 - INFO - orders - [DEBUG] db_group_result fetched from DB: [<app.database.models.Group object at 0x000002532E309260>, <app.database.models.Group object at 0x000002532E309E10>, <app.database.models.Group object at 0x000002532E30A250>, <app.database.models.Group object at 0x000002532E3098C0>, <app.database.models.Group object at 0x000002532E0A6BE0>, <app.database.models.Group object at 0x000002532E0A7240>, <app.database.models.Group object at 0x000002532E0A6E00>, <app.database.models.Group object at 0x000002532E1D56A0>, <app.database.models.Group object at 0x000002532E1D5BF0>, <app.database.models.Group object at 0x000002532E1D5AE0>, <app.database.models.Group object at 0x000002532E1D5590>, <app.database.models.Group object at 0x000002532E1D5D00>, <app.database.models.Group object at 0x000002532E1D58C0>, <app.database.models.Group object at 0x000002532E1D4380>, <app.database.models.Group object at 0x000002532E1D59D0>, <app.database.models.Group object at 0x000002532E1D6030>, <app.database.models.Group object at 0x000002532E1D5260>, <app.database.models.Group object at 0x000002532E1D5040>, <app.database.models.Group object at 0x000002532E1D48D0>, <app.database.models.Group object at 0x000002532E1D5E10>, <app.database.models.Group object at 0x000002532E1D6360>, <app.database.models.Group object at 0x000002532E1D6470>, <app.database.models.Group object at 0x000002532E1D6580>, <app.database.models.Group object at 0x000002532E1D6690>, <app.database.models.Group object at 0x000002532E1D67A0>, <app.database.models.Group object at 0x000002532E1D68B0>, <app.database.models.Group object at 0x000002532E1D69C0>, <app.database.models.Group object at 0x000002532E1D6AD0>, <app.database.models.Group object at 0x000002532E1D6BE0>, <app.database.models.Group object at 0x000002532E1D6CF0>, <app.database.models.Group object at 0x000002532E1D6E00>, <app.database.models.Group object at 0x000002532E1D6F10>, <app.database.models.Group object at 0x000002532E1D7020>, <app.database.models.Group object at 0x000002532E1D7130>, <app.database.models.Group object at 0x000002532E1D7240>, <app.database.models.Group object at 0x000002532E1D7350>, <app.database.models.Group object at 0x000002532E1D7460>, <app.database.models.Group object at 0x000002532E1D7570>, <app.database.models.Group object at 0x000002532E1D7680>, <app.database.models.Group object at 0x000002532E1D7790>, <app.database.models.Group object at 0x000002532E1D78A0>, <app.database.models.Group object at 0x000002532E1D79B0>, <app.database.models.Group object at 0x000002532E1D7AC0>, <app.database.models.Group object at 0x000002532E1D7BD0>, <app.database.models.Group object at 0x000002532E1D7CE0>, <app.database.models.Group object at 0x000002532E1D7DF0>, <app.database.models.Group object at 0x000002532E1D7F00>, <app.database.models.Group object at 0x000002532E1D4270>, <app.database.models.Group object at 0x000002532E1D5150>, <app.database.models.Group object at 0x000002532E1D57B0>, <app.database.models.Group object at 0x000002532E1D4E20>, <app.database.models.Group object at 0x000002532E3867A0>, <app.database.models.Group object at 0x000002532E386580>, <app.database.models.Group object at 0x000002532E3859D0>, <app.database.models.Group object at 0x000002532E384160>, <app.database.models.Group object at 0x000002532E384270>, <app.database.models.Group object at 0x000002532E384380>, <app.database.models.Group object at 0x000002532E384490>, <app.database.models.Group object at 0x000002532E3845A0>, <app.database.models.Group object at 0x000002532E3846B0>, <app.database.models.Group object at 0x000002532E3847C0>, <app.database.models.Group object at 0x000002532E3848D0>, <app.database.models.Group object at 0x000002532E3849E0>, <app.database.models.Group object at 0x000002532E384AF0>, <app.database.models.Group object at 0x000002532E384C00>, <app.database.models.Group object at 0x000002532E384D10>, <app.database.models.Group object at 0x000002532E384E20>, <app.database.models.Group object at 0x000002532E384F30>, <app.database.models.Group object at 0x000002532E385040>, <app.database.models.Group object at 0x000002532E385150>, <app.database.models.Group object at 0x000002532E385260>, <app.database.models.Group object at 0x000002532E385370>, <app.database.models.Group object at 0x000002532E385480>, <app.database.models.Group object at 0x000002532E385590>, <app.database.models.Group object at 0x000002532E3856A0>, <app.database.models.Group object at 0x000002532E3857B0>, <app.database.models.Group object at 0x000002532E3858C0>, <app.database.models.Group object at 0x000002532E385AE0>, <app.database.models.Group object at 0x000002532E385BF0>]
2025-06-27 05:37:29,232 - INFO - orders - [DEBUG] Number of group records found: 79
2025-06-27 05:37:29,233 - INFO - orders - [DEBUG] sending_orders_cache extracted from DB: barclays
2025-06-27 05:37:29,233 - INFO - orders - [DEBUG] group_settings_cache: None
2025-06-27 05:37:29,233 - INFO - orders - [DEBUG] sending_orders_cache value: barclays (type: <class 'str'>)
2025-06-27 05:37:29,234 - INFO - orders - Order placement: user_id=10, is_barclays_live_user=False, user_type=demo, group_name=Group B, sending_orders_setting=barclays
2025-06-27 05:37:29,621 - INFO - orders - [ORDER_MARGIN_CALC] Calculating margin for AUDCAD BUY order, quantity: 0.6
2025-06-27 05:37:29,621 - INFO - orders - [ORDER_MARGIN_CALC] Contract size for AUDCAD: 100000.00000000 (raw: 100000.00000000, type: <class 'decimal.Decimal'>)
2025-06-27 05:37:29,623 - INFO - orders - [ORDER_MARGIN_CALC] Got BUY price for AUDCAD from cache: 0.8926600000
2025-06-27 05:37:29,623 - INFO - orders - [ORDER_MARGIN_CALC] Contract value calculation for AUDCAD:
2025-06-27 05:37:29,623 - INFO - orders - [ORDER_MARGIN_CALC] Contract value = quantity * contract_size = 0.6 * 100000.00000000 = 60000.000000000
2025-06-27 05:37:29,623 - INFO - orders - [ORDER_MARGIN_CALC] Margin calculation: (contract_value * price) / leverage = (60000.000000000 * 0.8926600000) / 100.00 = 535.59600000000000000 (rounded to 535.60)
2025-06-27 05:37:29,623 - INFO - orders - [ORDER_MARGIN_CALC] Commission settings for AUDCAD: type=0, value_type=0, rate=10.0000
2025-06-27 05:37:29,623 - INFO - orders - [ORDER_MARGIN_CALC] Per lot commission: 0.6 * 10.0000 = 6.00000
2025-06-27 05:37:29,624 - INFO - orders - [ORDER_MARGIN_CALC] Profit currency for AUDCAD: CAD
2025-06-27 05:37:29,624 - INFO - orders - [ORDER_MARGIN_CALC] Converting margin from CAD to USD: 535.60 CAD
2025-06-27 05:37:29,624 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 535.60 CAD to USD for margin for AUDCAD BUY order (user_id: 10, position: )
2025-06-27 05:37:29,624 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CADUSD
2025-06-27 05:37:29,625 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-06-27 05:37:29,625 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CADUSD, trying inverse
2025-06-27 05:37:29,625 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCAD
2025-06-27 05:37:29,626 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('1.3644600000'), 'o': Decimal('1.3644100000')}
2025-06-27 05:37:29,627 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 1.3644600000
2025-06-27 05:37:29,627 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 535.60 CAD / 1.3644600000 = 392.5362414435014584524280668 USD
2025-06-27 05:37:29,627 - INFO - orders - [ORDER_MARGIN_CALC] Margin after USD conversion: 535.60 CAD -> 392.5362414435014584524280668 USD
2025-06-27 05:37:29,627 - INFO - orders - [ORDER_MARGIN_CALC] Final results for AUDCAD BUY: margin=392.5362414435014584524280668, price=0.8926600000, contract_value=60000.000000000, commission=6.00
2025-06-27 05:37:29,627 - app.services.order_processing - INFO - [COMMISSION_CALC] User 10 Symbol AUDCAD: Calculated commission=6.00
2025-06-27 05:37:29,641 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_ENTRY] User 10, Symbol AUDCAD, Positions count: 1
2025-06-27 05:37:29,641 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_POS_DETAIL] User 10, Symbol AUDCAD, Pos 1 (ID: 391): Type=BUY, Qty=0.01000000, StoredMargin=6.54380244
2025-06-27 05:37:29,642 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_POS_DETAIL] User 10, Symbol AUDCAD, Pos 1: MarginPerLot=654.380244
2025-06-27 05:37:29,642 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_CALC] User 10, Symbol AUDCAD: TotalBuyQty=0.01000000, TotalSellQty=0, NetQty=0.01000000
2025-06-27 05:37:29,645 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_CALC] User 10, Symbol AUDCAD: AllMarginsPerLot=[Decimal('654.380244')], HighestMarginPerLot=654.380244
2025-06-27 05:37:29,645 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_EXIT] User 10, Symbol AUDCAD: CalculatedTotalMargin=6.54, ContributingOrders=1 (based on individual stored margins)
2025-06-27 05:37:29,646 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_ENTRY] User 10, Symbol AUDCAD, Positions count: 2
2025-06-27 05:37:29,646 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_POS_DETAIL] User 10, Symbol AUDCAD, Pos 1 (ID: 391): Type=BUY, Qty=0.01000000, StoredMargin=6.54380244
2025-06-27 05:37:29,646 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_POS_DETAIL] User 10, Symbol AUDCAD, Pos 1: MarginPerLot=654.380244
2025-06-27 05:37:29,647 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_POS_DETAIL] User 10, Symbol AUDCAD, Pos 2 (ID: None): Type=BUY, Qty=0.6, StoredMargin=392.5362414435014584524280668
2025-06-27 05:37:29,647 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_POS_DETAIL] User 10, Symbol AUDCAD, Pos 2: MarginPerLot=654.227069072502430754046778
2025-06-27 05:37:29,648 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_CALC] User 10, Symbol AUDCAD: TotalBuyQty=0.61000000, TotalSellQty=0, NetQty=0.61000000
2025-06-27 05:37:29,648 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_CALC] User 10, Symbol AUDCAD: AllMarginsPerLot=[Decimal('654.380244'), Decimal('654.227069072502430754046778')], HighestMarginPerLot=654.380244
2025-06-27 05:37:29,649 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_EXIT] User 10, Symbol AUDCAD: CalculatedTotalMargin=399.17, ContributingOrders=2 (based on individual stored margins)
2025-06-27 05:37:29,649 - app.services.order_processing - INFO - [MARGIN_PROCESS] User 10 Symbol AUDCAD: MarginBefore=6.54, MarginAfter=399.17, AdditionalMargin=392.63
2025-06-27 05:37:29,649 - app.services.order_processing - INFO - [MARGIN_PROCESS_DEBUG] User 10 Symbol AUDCAD
2025-06-27 05:37:29,649 - app.services.order_processing - INFO - [MARGIN_PROCESS_DEBUG] Full margin for this order: 392.5362414435014584524280668
2025-06-27 05:37:29,652 - app.services.order_processing - INFO - [MARGIN_PROCESS_DEBUG] Existing open orders count: 1
2025-06-27 05:37:29,652 - app.services.order_processing - INFO - [MARGIN_PROCESS_DEBUG] Total margin before: 6.54
2025-06-27 05:37:29,652 - app.services.order_processing - INFO - [MARGIN_PROCESS_DEBUG] Total margin after: 399.17
2025-06-27 05:37:29,652 - app.services.order_processing - INFO - [MARGIN_PROCESS_DEBUG] Additional margin needed: 392.63
2025-06-27 05:37:29,681 - app.services.order_processing - INFO - [MARGIN_PROCESS] User 10: OriginalMarginDB=6.54000000, CalculatedNewMargin=399.17
2025-06-27 05:37:29,734 - INFO - orders - [PRE-CRUD] About to call create_order with: {'order_id': '2346906695', 'order_status': 'OPEN', 'order_user_id': 10, 'order_company_name': 'AUDCAD', 'order_type': 'BUY', 'order_price': Decimal('0.8926600000'), 'order_quantity': Decimal('0.6'), 'contract_value': Decimal('60000.000000000'), 'margin': Decimal('392.5362414435014584524280668'), 'commission': Decimal('6.00'), 'stop_loss': None, 'take_profit': None, 'stoploss_id': None, 'takeprofit_id': None, 'status': 'OPEN'}
2025-06-27 05:37:29,786 - INFO - orders - [MARGIN_COMMIT_CHECK] User 10 margin in session BEFORE commit: 399.17000000
2025-06-27 05:37:29,822 - INFO - orders - User data cache updated for user 10 after placing order
2025-06-27 05:37:30,331 - INFO - orders - Portfolio cache updated and websocket event published for user 10 after placing order.
2025-06-27 05:37:30,354 - INFO - orders - Starting update_user_static_orders for user 10, user_type demo
2025-06-27 05:37:30,355 - INFO - orders - Using order model: DemoUserOrder
2025-06-27 05:37:30,404 - INFO - orders - Fetched 2 open orders for user 10
2025-06-27 05:37:30,470 - INFO - orders - Fetched 0 pending orders for user 10
2025-06-27 05:37:30,576 - INFO - orders - Updated static orders cache for user 10 with 2 open orders and 0 pending orders
2025-06-27 05:37:51,955 - INFO - orders - [PENDING_ORDER_EXECUTION][PORTFOLIO_UPDATE] user_id=9, user_type=live, group_name=Group B, free_margin=7986.074137455320749984323070, margin_level=123151.9897912992411399741613, balance=8445.00000000, equity=7992.564137455320749984323070
2025-06-27 05:37:53,394 - INFO - orders - [PENDING_ORDER_EXECUTION][PORTFOLIO_UPDATE] user_id=10, user_type=demo, group_name=Group B, free_margin=102.0883683964517216611208021, margin_level=125.5751605572692641383673127, balance=505.59932766, equity=501.2583683964517216611208021
2025-06-27 05:38:52,262 - INFO - orders - [PENDING_ORDER_EXECUTION][PORTFOLIO_UPDATE] user_id=9, user_type=live, group_name=Group B, free_margin=7985.819089198580047917110924, margin_level=123148.0599260181825565040204, balance=8445.00000000, equity=7992.309089198580047917110924
2025-06-27 05:38:53,525 - INFO - orders - [PENDING_ORDER_EXECUTION][PORTFOLIO_UPDATE] user_id=10, user_type=demo, group_name=Group B, free_margin=8.4028512517505826480805593, margin_level=102.1050808557132506571336922, balance=505.59932766, equity=407.5728512517505826480805593
2025-06-27 05:39:26,546 - app.api.v1.endpoints.orders - INFO - [get_rejected_orders] user_type: demo
2025-06-27 05:39:52,787 - INFO - orders - [PENDING_ORDER_EXECUTION][PORTFOLIO_UPDATE] user_id=9, user_type=live, group_name=Group B, free_margin=7985.605382105659430292382984, margin_level=123144.7670586388201894049766, balance=8445.00000000, equity=7992.095382105659430292382984
2025-06-27 05:39:54,012 - INFO - orders - [PENDING_ORDER_EXECUTION][PORTFOLIO_UPDATE] user_id=10, user_type=demo, group_name=Group B, free_margin=-184.4908183339608923807569406, margin_level=53.78139180450412295995266663, balance=505.59932766, equity=214.6791816660391076192430594
2025-06-27 05:40:52,590 - INFO - orders - [PENDING_ORDER_EXECUTION][PORTFOLIO_UPDATE] user_id=9, user_type=live, group_name=Group B, free_margin=7985.992607822967107408987129, margin_level=123150.7335565942543514481838, balance=8445.00000000, equity=7992.482607822967107408987129
2025-06-27 05:40:53,811 - INFO - orders - [PENDING_ORDER_EXECUTION][PORTFOLIO_UPDATE] user_id=10, user_type=demo, group_name=Group B, free_margin=-193.6581254356848030018761726, margin_level=51.48479960024931658143743954, balance=505.59932766, equity=205.5118745643151969981238274
2025-06-27 05:41:51,664 - INFO - orders - [PENDING_ORDER_EXECUTION][PORTFOLIO_UPDATE] user_id=9, user_type=live, group_name=Group B, free_margin=7985.875773193288910640113441, margin_level=123148.9333311754839852097603, balance=8445.00000000, equity=7992.365773193288910640113441
2025-06-27 05:41:52,275 - INFO - orders - [PENDING_ORDER_EXECUTION][PORTFOLIO_UPDATE] user_id=10, user_type=demo, group_name=Group B, free_margin=-188.6611954385729677433540755, margin_level=52.73662964687402165910412218, balance=505.59932766, equity=210.5088045614270322566459245
2025-06-27 05:42:51,531 - INFO - orders - [PENDING_ORDER_EXECUTION][PORTFOLIO_UPDATE] user_id=9, user_type=live, group_name=Group B, free_margin=7985.767325703960246950760428, margin_level=123147.2623375032395524000066, balance=8445.00000000, equity=7992.257325703960246950760428
2025-06-27 05:42:51,972 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 0.35000000000000000000000000 CAD to USD for PnL on Auto-Cutoff (user_id: 10, position: 3788252355)
2025-06-27 05:42:51,972 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CADUSD
2025-06-27 05:42:51,974 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-06-27 05:42:51,974 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CADUSD, trying inverse
2025-06-27 05:42:51,974 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCAD
2025-06-27 05:42:51,974 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('1.3646700000'), 'o': Decimal('1.3646500000')}
2025-06-27 05:42:51,975 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 1.3646700000
2025-06-27 05:42:51,975 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 0.35000000000000000000000000 CAD / 1.3646700000 = 0.2564722606930613261814211494 USD
2025-06-27 05:42:51,996 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of -414.0000000000000000000000000 CAD to USD for PnL on Auto-Cutoff (user_id: 10, position: 2346906695)
2025-06-27 05:42:51,996 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CADUSD
2025-06-27 05:42:51,997 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-06-27 05:42:51,997 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CADUSD, trying inverse
2025-06-27 05:42:51,997 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCAD
2025-06-27 05:42:51,998 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('1.3646700000'), 'o': Decimal('1.3646500000')}
2025-06-27 05:42:51,998 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 1.3646700000
2025-06-27 05:42:51,998 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: -414.0000000000000000000000000 CAD / 1.3646700000 = -303.3700455055068258260238739 USD
2025-06-27 05:42:52,028 - INFO - orders - [PENDING_ORDER_EXECUTION][PORTFOLIO_UPDATE] user_id=10, user_type=demo, group_name=Group B, free_margin=-202.7842455848137644998424528, margin_level=49.19852554430098341562681244, balance=505.59932766, equity=196.3857544151862355001575472
2025-06-27 05:43:51,572 - INFO - orders - [PENDING_ORDER_EXECUTION][PORTFOLIO_UPDATE] user_id=9, user_type=live, group_name=Group B, free_margin=7985.821738137655885378766969, margin_level=123148.1007417204296668531120, balance=8445.00000000, equity=7992.311738137655885378766969
2025-06-27 05:45:20,409 - app.api.v1.endpoints.orders - INFO - [get_rejected_orders] user_type: demo
2025-06-27 06:02:39,745 - INFO - orders - Application starting up - Orders logging initialized
2025-06-27 06:02:39,745 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-06-27 06:03:00,870 - app.api.v1.endpoints.orders - INFO - [get_rejected_orders] user_type: demo
2025-06-27 06:03:41,442 - INFO - orders - [PENDING_ORDER_EXECUTION][PORTFOLIO_UPDATE] user_id=9, user_type=live, group_name=Group B, free_margin=7985.877877936157398112828749, margin_level=123148.9657617281571357908898, balance=8445.00000000, equity=7992.367877936157398112828749
2025-06-27 06:04:19,884 - INFO - orders - Order placement request received - User ID: 10, Symbol: AUDCAD, Type: BUY, Quantity: 0.29
2025-06-27 06:04:19,904 - INFO - orders - [DEBUG] db_group_result fetched from DB: [<app.database.models.Group object at 0x0000012F654886B0>, <app.database.models.Group object at 0x0000012F654889E0>, <app.database.models.Group object at 0x0000012F65488F30>, <app.database.models.Group object at 0x0000012F65488AF0>, <app.database.models.Group object at 0x0000012F65488C00>, <app.database.models.Group object at 0x0000012F65488D10>, <app.database.models.Group object at 0x0000012F65488E20>, <app.database.models.Group object at 0x0000012F6548ACF0>, <app.database.models.Group object at 0x0000012F6548A7A0>, <app.database.models.Group object at 0x0000012F65489480>, <app.database.models.Group object at 0x0000012F65390380>, <app.database.models.Group object at 0x0000012F65390D10>, <app.database.models.Group object at 0x0000012F653907C0>, <app.database.models.Group object at 0x0000012F653905A0>, <app.database.models.Group object at 0x0000012F65390F30>, <app.database.models.Group object at 0x0000012F653909E0>, <app.database.models.Group object at 0x0000012F65390AF0>, <app.database.models.Group object at 0x0000012F65390050>, <app.database.models.Group object at 0x0000012F65390160>, <app.database.models.Group object at 0x0000012F65390C00>, <app.database.models.Group object at 0x0000012F653906B0>, <app.database.models.Group object at 0x0000012F65391150>, <app.database.models.Group object at 0x0000012F65391260>, <app.database.models.Group object at 0x0000012F65391370>, <app.database.models.Group object at 0x0000012F65391480>, <app.database.models.Group object at 0x0000012F65391590>, <app.database.models.Group object at 0x0000012F653916A0>, <app.database.models.Group object at 0x0000012F653917B0>, <app.database.models.Group object at 0x0000012F653918C0>, <app.database.models.Group object at 0x0000012F653919D0>, <app.database.models.Group object at 0x0000012F65391AE0>, <app.database.models.Group object at 0x0000012F65391BF0>, <app.database.models.Group object at 0x0000012F65391D00>, <app.database.models.Group object at 0x0000012F65391E10>, <app.database.models.Group object at 0x0000012F65391F20>, <app.database.models.Group object at 0x0000012F65392030>, <app.database.models.Group object at 0x0000012F65392140>, <app.database.models.Group object at 0x0000012F65392250>, <app.database.models.Group object at 0x0000012F65392360>, <app.database.models.Group object at 0x0000012F65392470>, <app.database.models.Group object at 0x0000012F65392580>, <app.database.models.Group object at 0x0000012F65392690>, <app.database.models.Group object at 0x0000012F653927A0>, <app.database.models.Group object at 0x0000012F653928B0>, <app.database.models.Group object at 0x0000012F653929C0>, <app.database.models.Group object at 0x0000012F65392AD0>, <app.database.models.Group object at 0x0000012F65392BE0>, <app.database.models.Group object at 0x0000012F65392CF0>, <app.database.models.Group object at 0x0000012F65392E00>, <app.database.models.Group object at 0x0000012F65392F10>, <app.database.models.Group object at 0x0000012F65393020>, <app.database.models.Group object at 0x0000012F65393130>, <app.database.models.Group object at 0x0000012F65393240>, <app.database.models.Group object at 0x0000012F65393350>, <app.database.models.Group object at 0x0000012F65393460>, <app.database.models.Group object at 0x0000012F65393570>, <app.database.models.Group object at 0x0000012F65393680>, <app.database.models.Group object at 0x0000012F65393790>, <app.database.models.Group object at 0x0000012F653938A0>, <app.database.models.Group object at 0x0000012F653939B0>, <app.database.models.Group object at 0x0000012F65393AC0>, <app.database.models.Group object at 0x0000012F65393BD0>, <app.database.models.Group object at 0x0000012F65393CE0>, <app.database.models.Group object at 0x0000012F65393DF0>, <app.database.models.Group object at 0x0000012F65393F00>, <app.database.models.Group object at 0x0000012F653908D0>, <app.database.models.Group object at 0x0000012F65390270>, <app.database.models.Group object at 0x0000012F65390490>, <app.database.models.Group object at 0x0000012F65390E20>, <app.database.models.Group object at 0x0000012F6584E030>, <app.database.models.Group object at 0x0000012F6584D7B0>, <app.database.models.Group object at 0x0000012F6584D8C0>, <app.database.models.Group object at 0x0000012F6584D9D0>, <app.database.models.Group object at 0x0000012F6584DAE0>, <app.database.models.Group object at 0x0000012F6584DBF0>, <app.database.models.Group object at 0x0000012F6584DD00>, <app.database.models.Group object at 0x0000012F6584DE10>, <app.database.models.Group object at 0x0000012F6584DF20>, <app.database.models.Group object at 0x0000012F6584E140>]
2025-06-27 06:04:19,904 - INFO - orders - [DEBUG] Number of group records found: 79
2025-06-27 06:04:19,905 - INFO - orders - [DEBUG] sending_orders_cache extracted from DB: barclays
2025-06-27 06:04:19,905 - INFO - orders - [DEBUG] group_settings_cache: None
2025-06-27 06:04:19,905 - INFO - orders - [DEBUG] sending_orders_cache value: barclays (type: <class 'str'>)
2025-06-27 06:04:19,905 - INFO - orders - Order placement: user_id=10, is_barclays_live_user=False, user_type=demo, group_name=Group B, sending_orders_setting=barclays
2025-06-27 06:04:20,231 - INFO - orders - [ORDER_MARGIN_CALC] Calculating margin for AUDCAD BUY order, quantity: 0.29
2025-06-27 06:04:20,231 - INFO - orders - [ORDER_MARGIN_CALC] Contract size for AUDCAD: 100000.00000000 (raw: 100000.00000000, type: <class 'decimal.Decimal'>)
2025-06-27 06:04:20,233 - INFO - orders - [ORDER_MARGIN_CALC] Got BUY price for AUDCAD from cache: 0.8932000000
2025-06-27 06:04:20,234 - INFO - orders - [ORDER_MARGIN_CALC] Contract value calculation for AUDCAD:
2025-06-27 06:04:20,234 - INFO - orders - [ORDER_MARGIN_CALC] Contract value = quantity * contract_size = 0.29 * 100000.00000000 = 29000.0000000000
2025-06-27 06:04:20,234 - INFO - orders - [ORDER_MARGIN_CALC] Margin calculation: (contract_value * price) / leverage = (29000.0000000000 * 0.8932000000) / 100.00 = 259.028000000000000000 (rounded to 259.03)
2025-06-27 06:04:20,234 - INFO - orders - [ORDER_MARGIN_CALC] Commission settings for AUDCAD: type=0, value_type=0, rate=10.0000
2025-06-27 06:04:20,234 - INFO - orders - [ORDER_MARGIN_CALC] Per lot commission: 0.29 * 10.0000 = 2.900000
2025-06-27 06:04:20,234 - INFO - orders - [ORDER_MARGIN_CALC] Profit currency for AUDCAD: CAD
2025-06-27 06:04:20,234 - INFO - orders - [ORDER_MARGIN_CALC] Converting margin from CAD to USD: 259.03 CAD
2025-06-27 06:04:20,235 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 259.03 CAD to USD for margin for AUDCAD BUY order (user_id: 10, position: )
2025-06-27 06:04:20,235 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CADUSD
2025-06-27 06:04:20,238 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-06-27 06:04:20,238 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CADUSD, trying inverse
2025-06-27 06:04:20,239 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCAD
2025-06-27 06:04:20,243 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('1.3645400000'), 'o': Decimal('1.3645300000')}
2025-06-27 06:04:20,243 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 1.3645400000
2025-06-27 06:04:20,243 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 259.03 CAD / 1.3645400000 = 189.8295396250751168892080848 USD
2025-06-27 06:04:20,244 - INFO - orders - [ORDER_MARGIN_CALC] Margin after USD conversion: 259.03 CAD -> 189.8295396250751168892080848 USD
2025-06-27 06:04:20,244 - INFO - orders - [ORDER_MARGIN_CALC] Final results for AUDCAD BUY: margin=189.8295396250751168892080848, price=0.8932000000, contract_value=29000.0000000000, commission=2.90
2025-06-27 06:04:20,246 - app.services.order_processing - INFO - [COMMISSION_CALC] User 10 Symbol AUDCAD: Calculated commission=2.90
2025-06-27 06:04:20,259 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_ENTRY] User 10, Symbol AUDCAD, Positions count: 0
2025-06-27 06:04:20,259 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB] No open positions for User 10, Symbol AUDCAD. Returning zero margin.
2025-06-27 06:04:20,259 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_ENTRY] User 10, Symbol AUDCAD, Positions count: 1
2025-06-27 06:04:20,259 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_POS_DETAIL] User 10, Symbol AUDCAD, Pos 1 (ID: None): Type=BUY, Qty=0.29, StoredMargin=189.8295396250751168892080848
2025-06-27 06:04:20,260 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_POS_DETAIL] User 10, Symbol AUDCAD, Pos 1: MarginPerLot=654.5846193968107478938209821
2025-06-27 06:04:20,260 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_CALC] User 10, Symbol AUDCAD: TotalBuyQty=0.29, TotalSellQty=0, NetQty=0.29
2025-06-27 06:04:20,260 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_CALC] User 10, Symbol AUDCAD: AllMarginsPerLot=[Decimal('654.5846193968107478938209821')], HighestMarginPerLot=654.5846193968107478938209821
2025-06-27 06:04:20,260 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_EXIT] User 10, Symbol AUDCAD: CalculatedTotalMargin=189.83, ContributingOrders=1 (based on individual stored margins)
2025-06-27 06:04:20,260 - app.services.order_processing - INFO - [MARGIN_PROCESS] User 10 Symbol AUDCAD: MarginBefore=0.00, MarginAfter=189.83, AdditionalMargin=189.83
2025-06-27 06:04:20,260 - app.services.order_processing - INFO - [MARGIN_PROCESS_DEBUG] User 10 Symbol AUDCAD
2025-06-27 06:04:20,260 - app.services.order_processing - INFO - [MARGIN_PROCESS_DEBUG] Full margin for this order: 189.8295396250751168892080848
2025-06-27 06:04:20,260 - app.services.order_processing - INFO - [MARGIN_PROCESS_DEBUG] Existing open orders count: 0
2025-06-27 06:04:20,260 - app.services.order_processing - INFO - [MARGIN_PROCESS_DEBUG] Total margin before: 0.0
2025-06-27 06:04:20,260 - app.services.order_processing - INFO - [MARGIN_PROCESS_DEBUG] Total margin after: 189.83
2025-06-27 06:04:20,261 - app.services.order_processing - INFO - [MARGIN_PROCESS_DEBUG] Additional margin needed: 189.83
2025-06-27 06:04:20,281 - app.services.order_processing - INFO - [MARGIN_PROCESS] User 10: OriginalMarginDB=0E-8, CalculatedNewMargin=189.83
2025-06-27 06:04:20,421 - INFO - orders - [PRE-CRUD] About to call create_order with: {'order_id': '4866135596', 'order_status': 'OPEN', 'order_user_id': 10, 'order_company_name': 'AUDCAD', 'order_type': 'BUY', 'order_price': Decimal('0.8932000000'), 'order_quantity': Decimal('0.29'), 'contract_value': Decimal('29000.0000000000'), 'margin': Decimal('189.8295396250751168892080848'), 'commission': Decimal('2.90'), 'stop_loss': None, 'take_profit': None, 'stoploss_id': None, 'takeprofit_id': None, 'status': 'OPEN'}
2025-06-27 06:04:20,534 - INFO - orders - [MARGIN_COMMIT_CHECK] User 10 margin in session BEFORE commit: 189.83000000
2025-06-27 06:04:20,609 - INFO - orders - User data cache updated for user 10 after placing order
2025-06-27 06:04:21,847 - INFO - orders - Portfolio cache updated and websocket event published for user 10 after placing order.
2025-06-27 06:04:21,886 - INFO - orders - Starting update_user_static_orders for user 10, user_type demo
2025-06-27 06:04:21,886 - INFO - orders - Using order model: DemoUserOrder
2025-06-27 06:04:21,927 - INFO - orders - Fetched 1 open orders for user 10
2025-06-27 06:04:21,947 - INFO - orders - Fetched 0 pending orders for user 10
2025-06-27 06:04:21,965 - INFO - orders - Updated static orders cache for user 10 with 1 open orders and 0 pending orders
2025-06-27 06:04:41,552 - INFO - orders - [PENDING_ORDER_EXECUTION][PORTFOLIO_UPDATE] user_id=9, user_type=live, group_name=Group B, free_margin=7985.769702841080212830037145, margin_level=123147.2989651938399511561964, balance=8445.00000000, equity=7992.259702841080212830037145
2025-06-27 06:04:42,383 - INFO - orders - [PENDING_ORDER_EXECUTION][PORTFOLIO_UPDATE] user_id=10, user_type=demo, group_name=Group B, free_margin=-3.2907133764638292883104702, margin_level=98.26649456015180462081311163, balance=190.28932766, equity=186.5392866235361707116895298
2025-06-27 06:05:40,832 - INFO - orders - [PENDING_ORDER_EXECUTION][PORTFOLIO_UPDATE] user_id=9, user_type=live, group_name=Group B, free_margin=7985.878513221937879472126048, margin_level=123148.9755504150674803101086, balance=8445.00000000, equity=7992.368513221937879472126048
2025-06-27 06:05:41,587 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of -180.3800000000000000000000000 CAD to USD for PnL on Auto-Cutoff (user_id: 10, position: 4866135596)
2025-06-27 06:05:41,588 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CADUSD
2025-06-27 06:05:41,592 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-06-27 06:05:41,593 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CADUSD, trying inverse
2025-06-27 06:05:41,593 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCAD
2025-06-27 06:05:41,595 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('1.3648500000'), 'o': Decimal('1.3648100000')}
2025-06-27 06:05:41,595 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 1.3648500000
2025-06-27 06:05:41,595 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: -180.3800000000000000000000000 CAD / 1.3648500000 = -132.1610433380957614389859692 USD
2025-06-27 06:05:41,708 - INFO - orders - [PENDING_ORDER_EXECUTION][PORTFOLIO_UPDATE] user_id=10, user_type=demo, group_name=Group B, free_margin=-134.6017156780957614389859692, margin_level=29.09354913443830720171418153, balance=190.28932766, equity=55.2282843219042385610140308
2025-06-27 06:06:07,696 - app.api.v1.endpoints.orders - INFO - [get_rejected_orders] user_type: demo
2025-06-27 06:08:08,244 - INFO - orders - Application starting up - Orders logging initialized
2025-06-27 06:08:08,244 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-06-27 06:08:22,425 - app.api.v1.endpoints.orders - INFO - [get_rejected_orders] user_type: demo
2025-06-27 06:08:41,841 - INFO - orders - Order placement request received - User ID: 10, Symbol: AUDCAD, Type: BUY, Quantity: 0.3
2025-06-27 06:08:41,855 - INFO - orders - [DEBUG] db_group_result fetched from DB: [<app.database.models.Group object at 0x000001A261024AF0>, <app.database.models.Group object at 0x000001A261025480>, <app.database.models.Group object at 0x000001A261025590>, <app.database.models.Group object at 0x000001A2610256A0>, <app.database.models.Group object at 0x000001A2610257B0>, <app.database.models.Group object at 0x000001A2610258C0>, <app.database.models.Group object at 0x000001A2610259D0>, <app.database.models.Group object at 0x000001A261025AE0>, <app.database.models.Group object at 0x000001A261025BF0>, <app.database.models.Group object at 0x000001A261025D00>, <app.database.models.Group object at 0x000001A261025E10>, <app.database.models.Group object at 0x000001A261025F20>, <app.database.models.Group object at 0x000001A261026030>, <app.database.models.Group object at 0x000001A261026140>, <app.database.models.Group object at 0x000001A261026250>, <app.database.models.Group object at 0x000001A261026360>, <app.database.models.Group object at 0x000001A261026470>, <app.database.models.Group object at 0x000001A261026580>, <app.database.models.Group object at 0x000001A261026690>, <app.database.models.Group object at 0x000001A2610267A0>, <app.database.models.Group object at 0x000001A2610268B0>, <app.database.models.Group object at 0x000001A2610269C0>, <app.database.models.Group object at 0x000001A261026AD0>, <app.database.models.Group object at 0x000001A261026BE0>, <app.database.models.Group object at 0x000001A261026CF0>, <app.database.models.Group object at 0x000001A261026E00>, <app.database.models.Group object at 0x000001A261026F10>, <app.database.models.Group object at 0x000001A261027020>, <app.database.models.Group object at 0x000001A261027130>, <app.database.models.Group object at 0x000001A261027240>, <app.database.models.Group object at 0x000001A261027350>, <app.database.models.Group object at 0x000001A261027460>, <app.database.models.Group object at 0x000001A261027570>, <app.database.models.Group object at 0x000001A261027680>, <app.database.models.Group object at 0x000001A261027790>, <app.database.models.Group object at 0x000001A2610278A0>, <app.database.models.Group object at 0x000001A2610279B0>, <app.database.models.Group object at 0x000001A261027AC0>, <app.database.models.Group object at 0x000001A261027BD0>, <app.database.models.Group object at 0x000001A261027CE0>, <app.database.models.Group object at 0x000001A261027DF0>, <app.database.models.Group object at 0x000001A261027F00>, <app.database.models.Group object at 0x000001A2610246B0>, <app.database.models.Group object at 0x000001A261025150>, <app.database.models.Group object at 0x000001A2610245A0>, <app.database.models.Group object at 0x000001A261024050>, <app.database.models.Group object at 0x000001A261024160>, <app.database.models.Group object at 0x000001A261024270>, <app.database.models.Group object at 0x000001A261024380>, <app.database.models.Group object at 0x000001A261024490>, <app.database.models.Group object at 0x000001A2610249E0>, <app.database.models.Group object at 0x000001A261025040>, <app.database.models.Group object at 0x000001A260D44C00>, <app.database.models.Group object at 0x000001A260D44AF0>, <app.database.models.Group object at 0x000001A260D449E0>, <app.database.models.Group object at 0x000001A260D445A0>, <app.database.models.Group object at 0x000001A260D44F30>, <app.database.models.Group object at 0x000001A26108A360>, <app.database.models.Group object at 0x000001A261088050>, <app.database.models.Group object at 0x000001A261088160>, <app.database.models.Group object at 0x000001A261088270>, <app.database.models.Group object at 0x000001A261088380>, <app.database.models.Group object at 0x000001A261088490>, <app.database.models.Group object at 0x000001A2610885A0>, <app.database.models.Group object at 0x000001A2610886B0>, <app.database.models.Group object at 0x000001A2610887C0>, <app.database.models.Group object at 0x000001A2610888D0>, <app.database.models.Group object at 0x000001A2610889E0>, <app.database.models.Group object at 0x000001A261088AF0>, <app.database.models.Group object at 0x000001A261088C00>, <app.database.models.Group object at 0x000001A261088D10>, <app.database.models.Group object at 0x000001A261088E20>, <app.database.models.Group object at 0x000001A261088F30>, <app.database.models.Group object at 0x000001A261089040>, <app.database.models.Group object at 0x000001A261089150>, <app.database.models.Group object at 0x000001A261089260>, <app.database.models.Group object at 0x000001A261089370>, <app.database.models.Group object at 0x000001A261089480>, <app.database.models.Group object at 0x000001A261089590>]
2025-06-27 06:08:41,856 - INFO - orders - [DEBUG] Number of group records found: 79
2025-06-27 06:08:41,856 - INFO - orders - [DEBUG] sending_orders_cache extracted from DB: barclays
2025-06-27 06:08:41,856 - INFO - orders - [DEBUG] group_settings_cache: None
2025-06-27 06:08:41,856 - INFO - orders - [DEBUG] sending_orders_cache value: barclays (type: <class 'str'>)
2025-06-27 06:08:41,856 - INFO - orders - Order placement: user_id=10, is_barclays_live_user=False, user_type=demo, group_name=Group B, sending_orders_setting=barclays
2025-06-27 06:08:42,168 - INFO - orders - [ORDER_MARGIN_CALC] Calculating margin for AUDCAD BUY order, quantity: 0.3
2025-06-27 06:08:42,168 - INFO - orders - [ORDER_MARGIN_CALC] Contract size for AUDCAD: 100000.00000000 (raw: 100000.00000000, type: <class 'decimal.Decimal'>)
2025-06-27 06:08:42,171 - INFO - orders - [ORDER_MARGIN_CALC] Got BUY price for AUDCAD from cache: 0.8931300000
2025-06-27 06:08:42,172 - INFO - orders - [ORDER_MARGIN_CALC] Contract value calculation for AUDCAD:
2025-06-27 06:08:42,172 - INFO - orders - [ORDER_MARGIN_CALC] Contract value = quantity * contract_size = 0.3 * 100000.00000000 = 30000.000000000
2025-06-27 06:08:42,173 - INFO - orders - [ORDER_MARGIN_CALC] Margin calculation: (contract_value * price) / leverage = (30000.000000000 * 0.8931300000) / 100.00 = 267.93900000000000000 (rounded to 267.94)
2025-06-27 06:08:42,173 - INFO - orders - [ORDER_MARGIN_CALC] Commission settings for AUDCAD: type=0, value_type=0, rate=10.0000
2025-06-27 06:08:42,173 - INFO - orders - [ORDER_MARGIN_CALC] Per lot commission: 0.3 * 10.0000 = 3.00000
2025-06-27 06:08:42,174 - INFO - orders - [ORDER_MARGIN_CALC] Profit currency for AUDCAD: CAD
2025-06-27 06:08:42,174 - INFO - orders - [ORDER_MARGIN_CALC] Converting margin from CAD to USD: 267.94 CAD
2025-06-27 06:08:42,174 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 267.94 CAD to USD for margin for AUDCAD BUY order (user_id: 10, position: )
2025-06-27 06:08:42,174 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CADUSD
2025-06-27 06:08:42,176 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-06-27 06:08:42,176 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CADUSD, trying inverse
2025-06-27 06:08:42,177 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCAD
2025-06-27 06:08:42,179 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('1.3650700000'), 'o': Decimal('1.3650200000')}
2025-06-27 06:08:42,180 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 1.3650700000
2025-06-27 06:08:42,180 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 267.94 CAD / 1.3650700000 = 196.2829744994762173368398690 USD
2025-06-27 06:08:42,180 - INFO - orders - [ORDER_MARGIN_CALC] Margin after USD conversion: 267.94 CAD -> 196.2829744994762173368398690 USD
2025-06-27 06:08:42,180 - INFO - orders - [ORDER_MARGIN_CALC] Final results for AUDCAD BUY: margin=196.2829744994762173368398690, price=0.8931300000, contract_value=30000.000000000, commission=3.00
2025-06-27 06:08:42,180 - app.services.order_processing - INFO - [COMMISSION_CALC] User 10 Symbol AUDCAD: Calculated commission=3.00
2025-06-27 06:08:42,198 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_ENTRY] User 10, Symbol AUDCAD, Positions count: 0
2025-06-27 06:08:42,199 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB] No open positions for User 10, Symbol AUDCAD. Returning zero margin.
2025-06-27 06:08:42,201 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_ENTRY] User 10, Symbol AUDCAD, Positions count: 1
2025-06-27 06:08:42,201 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_POS_DETAIL] User 10, Symbol AUDCAD, Pos 1 (ID: None): Type=BUY, Qty=0.3, StoredMargin=196.2829744994762173368398690
2025-06-27 06:08:42,202 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_POS_DETAIL] User 10, Symbol AUDCAD, Pos 1: MarginPerLot=654.2765816649207244561328967
2025-06-27 06:08:42,202 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_CALC] User 10, Symbol AUDCAD: TotalBuyQty=0.3, TotalSellQty=0, NetQty=0.3
2025-06-27 06:08:42,203 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_CALC] User 10, Symbol AUDCAD: AllMarginsPerLot=[Decimal('654.2765816649207244561328967')], HighestMarginPerLot=654.2765816649207244561328967
2025-06-27 06:08:42,203 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_EXIT] User 10, Symbol AUDCAD: CalculatedTotalMargin=196.28, ContributingOrders=1 (based on individual stored margins)
2025-06-27 06:08:42,204 - app.services.order_processing - INFO - [MARGIN_PROCESS] User 10 Symbol AUDCAD: MarginBefore=0.00, MarginAfter=196.28, AdditionalMargin=196.28
2025-06-27 06:08:42,204 - app.services.order_processing - INFO - [MARGIN_PROCESS_DEBUG] User 10 Symbol AUDCAD
2025-06-27 06:08:42,204 - app.services.order_processing - INFO - [MARGIN_PROCESS_DEBUG] Full margin for this order: 196.2829744994762173368398690
2025-06-27 06:08:42,205 - app.services.order_processing - INFO - [MARGIN_PROCESS_DEBUG] Existing open orders count: 0
2025-06-27 06:08:42,205 - app.services.order_processing - INFO - [MARGIN_PROCESS_DEBUG] Total margin before: 0.0
2025-06-27 06:08:42,205 - app.services.order_processing - INFO - [MARGIN_PROCESS_DEBUG] Total margin after: 196.28
2025-06-27 06:08:42,205 - app.services.order_processing - INFO - [MARGIN_PROCESS_DEBUG] Additional margin needed: 196.28
2025-06-27 06:08:42,249 - app.services.order_processing - INFO - [MARGIN_PROCESS] User 10: OriginalMarginDB=0E-8, CalculatedNewMargin=196.28
2025-06-27 06:08:42,352 - INFO - orders - [PRE-CRUD] About to call create_order with: {'order_id': '2442245613', 'order_status': 'OPEN', 'order_user_id': 10, 'order_company_name': 'AUDCAD', 'order_type': 'BUY', 'order_price': Decimal('0.8931300000'), 'order_quantity': Decimal('0.3'), 'contract_value': Decimal('30000.000000000'), 'margin': Decimal('196.2829744994762173368398690'), 'commission': Decimal('3.00'), 'stop_loss': None, 'take_profit': None, 'stoploss_id': None, 'takeprofit_id': None, 'status': 'OPEN'}
2025-06-27 06:08:42,543 - INFO - orders - [MARGIN_COMMIT_CHECK] User 10 margin in session BEFORE commit: 196.28000000
2025-06-27 06:08:42,614 - INFO - orders - User data cache updated for user 10 after placing order
2025-06-27 06:08:43,656 - INFO - orders - Portfolio cache updated and websocket event published for user 10 after placing order.
2025-06-27 06:08:43,684 - INFO - orders - Starting update_user_static_orders for user 10, user_type demo
2025-06-27 06:08:43,684 - INFO - orders - Using order model: DemoUserOrder
2025-06-27 06:08:43,709 - INFO - orders - Fetched 1 open orders for user 10
2025-06-27 06:08:43,732 - INFO - orders - Fetched 0 pending orders for user 10
2025-06-27 06:08:43,739 - INFO - orders - Updated static orders cache for user 10 with 1 open orders and 0 pending orders
2025-06-27 06:09:09,420 - INFO - orders - [PENDING_ORDER_EXECUTION][PORTFOLIO_UPDATE] user_id=9, user_type=live, group_name=Group B, free_margin=7985.774591957050751360979403, margin_level=123147.3742982596417775189430, balance=8445.00000000, equity=7992.264591957050751360979403
2025-06-27 06:09:10,313 - INFO - orders - [PENDING_ORDER_EXECUTION][PORTFOLIO_UPDATE] user_id=10, user_type=demo, group_name=Group B, free_margin=0.2805393646864082149841428, margin_level=100.1429281458561280899654284, balance=200.00000000, equity=196.5605393646864082149841428
2025-06-27 06:10:08,724 - INFO - orders - [PENDING_ORDER_EXECUTION][PORTFOLIO_UPDATE] user_id=9, user_type=live, group_name=Group B, free_margin=7985.928406562394170105484968, margin_level=123149.7443229952876749689517, balance=8445.00000000, equity=7992.418406562394170105484968
2025-06-27 06:10:09,147 - INFO - orders - [PENDING_ORDER_EXECUTION][PORTFOLIO_UPDATE] user_id=10, user_type=demo, group_name=Group B, free_margin=-44.7668410450986280699955319, margin_level=77.19235732367096593132487676, balance=200.00000000, equity=151.5131589549013719300044681
2025-06-27 06:11:09,073 - INFO - orders - [PENDING_ORDER_EXECUTION][PORTFOLIO_UPDATE] user_id=9, user_type=live, group_name=Group B, free_margin=7986.144597394128638250379344, margin_level=123153.0754606183149191121625, balance=8445.00000000, equity=7992.634597394128638250379344
2025-06-27 06:11:10,601 - INFO - orders - [PENDING_ORDER_EXECUTION][PORTFOLIO_UPDATE] user_id=10, user_type=demo, group_name=Group B, free_margin=-43.4435295668605076974908084, margin_level=77.86655310430991048629977155, balance=200.00000000, equity=152.8364704331394923025091916
2025-06-27 06:12:09,485 - INFO - orders - [PENDING_ORDER_EXECUTION][PORTFOLIO_UPDATE] user_id=9, user_type=live, group_name=Group B, free_margin=7986.433165442374708551658435, margin_level=123157.5218095897489761426569, balance=8445.00000000, equity=7992.923165442374708551658435
2025-06-27 06:12:10,095 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of -150.9000000000000000000000000 CAD to USD for PnL on Auto-Cutoff (user_id: 10, position: 2442245613)
2025-06-27 06:12:10,095 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CADUSD
2025-06-27 06:12:10,098 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-06-27 06:12:10,098 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CADUSD, trying inverse
2025-06-27 06:12:10,098 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCAD
2025-06-27 06:12:10,100 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('1.3655200000'), 'o': Decimal('1.3654800000')}
2025-06-27 06:12:10,100 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 1.3655200000
2025-06-27 06:12:10,100 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: -150.9000000000000000000000000 CAD / 1.3655200000 = -110.5073525103989688909719374 USD
2025-06-27 06:12:10,179 - INFO - orders - Starting update_user_static_orders for user 10, user_type demo
2025-06-27 06:12:10,179 - INFO - orders - Using order model: DemoUserOrder
2025-06-27 06:12:10,188 - INFO - orders - Fetched 0 open orders for user 10
2025-06-27 06:12:10,196 - INFO - orders - Fetched 0 pending orders for user 10
2025-06-27 06:12:10,199 - INFO - orders - Updated static orders cache for user 10 with 0 open orders and 0 pending orders
2025-06-27 06:12:10,211 - INFO - orders - [PENDING_ORDER_EXECUTION][PORTFOLIO_UPDATE] user_id=10, user_type=demo, group_name=Group B, free_margin=-109.7873525103989688909719374, margin_level=44.06595042266202929948444192, balance=200.00000000, equity=86.4926474896010311090280626
