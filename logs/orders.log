2025-07-03 22:26:52,368 - INFO - orders - Application starting up - Orders logging initialized
2025-07-03 22:26:52,368 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-03 22:26:59,036 - app.api.v1.endpoints.orders - INFO - [get_rejected_orders] user_type: live
2025-07-03 22:27:04,196 - INFO - orders - Order placement request received - User: 4, Symbol: AUDCAD, Type: BUY
2025-07-03 22:27:04,568 - ERROR - orders - [MARGIN_CALC] Invalid prices for AUDCAD: bid=0.8924100000, ask=0
2025-07-03 22:27:04,569 - app.services.order_processing - ERROR - Error processing new order: Margin calculation failed
Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\app\services\order_processing.py", line 260, in process_new_order_ultra_optimized
    raise OrderProcessingError("Margin calculation failed")
app.services.order_processing.OrderProcessingError: Margin calculation failed
2025-07-03 22:28:16,664 - INFO - orders - Order placement request received - User: 4, Symbol: AUDCAD, Type: BUY
2025-07-03 22:28:17,047 - ERROR - orders - [MARGIN_CALC] Invalid prices for AUDCAD: bid=0.8923900000, ask=0
2025-07-03 22:28:17,048 - app.services.order_processing - ERROR - Error processing new order: Margin calculation failed
Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\app\services\order_processing.py", line 260, in process_new_order_ultra_optimized
    raise OrderProcessingError("Margin calculation failed")
app.services.order_processing.OrderProcessingError: Margin calculation failed
2025-07-03 22:29:58,802 - INFO - orders - Application starting up - Orders logging initialized
2025-07-03 22:29:58,803 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-03 22:30:21,197 - INFO - orders - Application starting up - Orders logging initialized
2025-07-03 22:30:21,198 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-03 22:30:27,128 - INFO - orders - Application starting up - Orders logging initialized
2025-07-03 22:30:27,129 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-03 22:30:44,124 - INFO - orders - Application starting up - Orders logging initialized
2025-07-03 22:30:44,124 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-03 22:31:27,813 - INFO - orders - Order placement request received - User: 4, Symbol: AUDCAD, Type: BUY
2025-07-03 22:31:28,120 - INFO - orders - [MARGIN_CALC] Market data for AUDCAD: {'b': '0.8923900000', 'o': '0.8923300000'}
2025-07-03 22:31:28,120 - WARNING - orders - [MARGIN_CALC] Missing ask price for AUDCAD, using bid price with spread: bid=0.8923900000, ask=0.89247923900000
2025-07-03 22:31:28,120 - INFO - orders - [MARGIN_CALC] Using prices for AUDCAD: bid=0.8923900000, ask=0.89247923900000
2025-07-03 22:31:28,121 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 8.92 CAD to USD for margin_calculation (user_id: 4, position: None)
2025-07-03 22:31:28,121 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CADUSD
2025-07-03 22:31:28,122 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-03 22:31:28,122 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CADUSD, trying inverse
2025-07-03 22:31:28,122 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCAD
2025-07-03 22:31:28,123 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('1.3571600000'), 'o': Decimal('1.3571200000')}
2025-07-03 22:31:28,123 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 1.3571600000
2025-07-03 22:31:28,124 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 8.92 CAD / 1.3571600000 = 6.572548557281381708862624893 USD
2025-07-03 22:31:28,124 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: AUDCAD, Type: BUY, Qty: 0.01, Price: 0.89247923900000, Margin: 6.572548557281381708862624893, Commission: 0.00
2025-07-03 22:31:28,147 - INFO - orders - [PERF] Order processing: 0.3329s
2025-07-03 22:31:28,148 - DEBUG - orders - [DEBUG][create_user_order] Received order_data: {'order_id': '2893933401', 'order_status': 'OPEN', 'order_user_id': 4, 'order_company_name': 'AUDCAD', 'order_type': 'BUY', 'order_price': Decimal('0.89247923900000'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('892.48'), 'margin': Decimal('6.572548557281381708862624893'), 'status': None, 'stop_loss': None, 'take_profit': None, 'close_id': None}
2025-07-03 22:31:28,149 - DEBUG - orders - [DEBUG][create_user_order] status field value: None
2025-07-03 22:31:28,151 - ERROR - orders - Error creating order: 'status' is required and must be a string of length 10-30.
2025-07-03 22:33:57,786 - INFO - orders - Application starting up - Orders logging initialized
2025-07-03 22:33:57,788 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-03 22:34:09,883 - INFO - orders - Application starting up - Orders logging initialized
2025-07-03 22:34:09,883 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-03 22:34:14,481 - INFO - orders - Application starting up - Orders logging initialized
2025-07-03 22:34:14,482 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-03 22:34:52,127 - INFO - orders - Application starting up - Orders logging initialized
2025-07-03 22:34:52,128 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-03 22:34:59,615 - INFO - orders - Application starting up - Orders logging initialized
2025-07-03 22:34:59,615 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-03 22:35:25,052 - INFO - orders - Application starting up - Orders logging initialized
2025-07-03 22:35:25,052 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-03 22:35:30,994 - INFO - orders - Application starting up - Orders logging initialized
2025-07-03 22:35:30,994 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-03 22:35:52,514 - INFO - orders - Order placement request received - User: 4, Symbol: AUDCAD, Type: BUY
2025-07-03 22:35:52,822 - INFO - orders - [MARGIN_CALC] Market data for AUDCAD: {'b': '0.8923600000', 'o': '0.8923000000'}
2025-07-03 22:35:52,822 - WARNING - orders - [MARGIN_CALC] Missing ask price for AUDCAD, using bid price with spread: bid=0.8923600000, ask=0.89244923600000
2025-07-03 22:35:52,822 - INFO - orders - [MARGIN_CALC] Using prices for AUDCAD: bid=0.8923600000, ask=0.89244923600000
2025-07-03 22:35:52,823 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 8.92 CAD to USD for margin_calculation (user_id: 4, position: None)
2025-07-03 22:35:52,823 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CADUSD
2025-07-03 22:35:52,823 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-03 22:35:52,823 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CADUSD, trying inverse
2025-07-03 22:35:52,823 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCAD
2025-07-03 22:35:52,823 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('1.3571900000'), 'o': Decimal('1.3571500000')}
2025-07-03 22:35:52,823 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 1.3571900000
2025-07-03 22:35:52,823 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 8.92 CAD / 1.3571900000 = 6.572403274412573036936611676 USD
2025-07-03 22:35:52,823 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: AUDCAD, Type: BUY, Qty: 0.01, Price: 0.89244923600000, Margin: 6.572403274412573036936611676, Commission: 0.00
2025-07-03 22:35:52,844 - INFO - orders - [PERF] Order processing: 0.3292s
2025-07-03 22:35:52,844 - DEBUG - orders - [DEBUG][create_user_order] Received order_data: {'order_id': '1244280912', 'order_status': 'OPEN', 'order_user_id': 4, 'order_company_name': 'AUDCAD', 'order_type': 'BUY', 'order_price': Decimal('0.89244923600000'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('892.45'), 'margin': Decimal('6.572403274412573036936611676'), 'status': None, 'stop_loss': None, 'take_profit': None, 'close_id': None}
2025-07-03 22:35:52,844 - DEBUG - orders - [DEBUG][create_user_order] Created OrderActionHistory record for order_id: 1244280912
2025-07-03 22:35:52,858 - INFO - orders - [PERF] Order creation: 0.0139s
2025-07-03 22:37:30,795 - INFO - orders - Application starting up - Orders logging initialized
2025-07-03 22:37:30,796 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-03 22:37:39,679 - INFO - orders - Application starting up - Orders logging initialized
2025-07-03 22:37:39,679 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-03 22:37:55,729 - INFO - orders - Application starting up - Orders logging initialized
2025-07-03 22:37:55,729 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-03 22:38:15,142 - INFO - orders - Application starting up - Orders logging initialized
2025-07-03 22:38:15,143 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-03 22:38:49,048 - INFO - orders - Application starting up - Orders logging initialized
2025-07-03 22:38:49,049 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-03 22:39:12,960 - INFO - orders - Application starting up - Orders logging initialized
2025-07-03 22:39:12,960 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-03 22:39:20,815 - INFO - orders - Application starting up - Orders logging initialized
2025-07-03 22:39:20,815 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-03 22:39:37,399 - INFO - orders - Application starting up - Orders logging initialized
2025-07-03 22:39:37,399 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-03 22:39:40,726 - INFO - orders - Order placement request received - User: 4, Symbol: AUDCAD, Type: BUY
2025-07-03 22:39:41,067 - INFO - orders - [MARGIN_CALC] Market data for AUDCAD: {'b': '0.8923600000', 'o': '0.8923000000'}
2025-07-03 22:39:41,067 - WARNING - orders - [MARGIN_CALC] Missing ask price for AUDCAD, using bid price with spread: bid=0.8923600000, ask=0.89244923600000
2025-07-03 22:39:41,067 - INFO - orders - [MARGIN_CALC] Using prices for AUDCAD: bid=0.8923600000, ask=0.89244923600000
2025-07-03 22:39:41,068 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 8.92 CAD to USD for margin_calculation (user_id: 4, position: None)
2025-07-03 22:39:41,069 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CADUSD
2025-07-03 22:39:41,069 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-03 22:39:41,069 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CADUSD, trying inverse
2025-07-03 22:39:41,070 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCAD
2025-07-03 22:39:41,071 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('1.3570700000'), 'o': Decimal('1.3570300000')}
2025-07-03 22:39:41,071 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 1.3570700000
2025-07-03 22:39:41,071 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 8.92 CAD / 1.3570700000 = 6.572984444428069296351698881 USD
2025-07-03 22:39:41,072 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: AUDCAD, Type: BUY, Qty: 0.01, Price: 0.89244923600000, Margin: 6.572984444428069296351698881, Commission: 0.00
2025-07-03 22:39:41,108 - INFO - orders - [PERF] Order processing: 0.3820s
2025-07-03 22:39:41,109 - DEBUG - orders - [DEBUG][create_user_order] Received order_data: {'order_id': '8870125869', 'order_status': 'OPEN', 'order_user_id': 4, 'order_company_name': 'AUDCAD', 'order_type': 'BUY', 'order_price': Decimal('0.89244923600000'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('892.45'), 'margin': Decimal('6.572984444428069296351698881'), 'status': None, 'stop_loss': None, 'take_profit': None, 'close_id': None}
2025-07-03 22:39:41,110 - DEBUG - orders - [DEBUG][create_user_order] Created OrderActionHistory record for order_id: 8870125869
2025-07-03 22:39:41,135 - INFO - orders - [PERF] Order creation: 0.0260s
2025-07-03 22:39:41,135 - INFO - orders - [PERF] TOTAL place_order: 0.4097s
2025-07-03 22:40:02,003 - INFO - orders - Order close request received - Order ID: 8870125869, User ID: 4, Close Price: 0.89225
2025-07-03 22:40:02,004 - INFO - orders - user_to_operate_on: <app.database.models.User object at 0x00000238609FC910>, type: <class 'app.database.models.User'>, user_type: live, attrs: ['__abstract__', '__class__', '__delattr__', '__dict__', '__dir__', '__doc__', '__eq__', '__firstlineno__', '__format__', '__ge__', '__getattribute__', '__getstate__', '__gt__', '__hash__', '__init__', '__init_subclass__', '__le__', '__lt__', '__mapper__', '__module__', '__ne__', '__new__', '__reduce__', '__reduce_ex__', '__repr__', '__setattr__', '__sizeof__', '__static_attributes__', '__str__', '__subclasshook__', '__table__', '__table_args__', '__tablename__', '__weakref__', '_sa_class_manager', '_sa_instance_state', '_sa_registry', 'account_number', 'address_proof', 'address_proof_image', 'bank_account_number', 'bank_branch_name', 'bank_holder_name', 'bank_ifsc_code', 'city', 'country', 'created_at', 'email', 'fund_manager', 'group_name', 'hashed_password', 'id', 'id_proof', 'id_proof_image', 'isActive', 'is_self_trading', 'is_service_account', 'leverage', 'margin', 'metadata', 'money_requests', 'name', 'net_profit', 'orders', 'otps', 'phone_number', 'pincode', 'referred_by_id', 'reffered_code', 'registry', 'rock_orders', 'security_answer', 'security_question', 'state', 'status', 'updated_at', 'user_favorites', 'user_type', 'wallet_balance', 'wallet_transactions']
2025-07-03 22:40:02,005 - INFO - orders - Using order model: user_orders for user 4 (user_type: live)
2025-07-03 22:40:02,005 - INFO - orders - Request to close order 8870125869 for user 4 (user_type: live) with price 0.89225. Frontend provided type: BUY, company: AUDCAD, status: CLOSED, frontend_status: CLOSED.
2025-07-03 22:40:02,011 - INFO - orders - User group: Standard, sending_orders setting: rock
2025-07-03 22:40:02,023 - INFO - orders - Live user 4 from group 'default' ('sending_orders' is NOT 'barclays'). Processing close locally.
2025-07-03 22:40:02,040 - INFO - orders - Existing entry commission for order 8870125869: 0.0
2025-07-03 22:40:02,040 - INFO - orders - Commission calculation for order 8870125869: entry=0.0, exit=0.100000000000, total=0.10
2025-07-03 22:40:02,040 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of -0.199240000000000000000000 CAD to USD for PnL on Close (user_id: 4, position: 8870125869)
2025-07-03 22:40:02,041 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CADUSD
2025-07-03 22:40:02,042 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-03 22:40:02,042 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CADUSD, trying inverse
2025-07-03 22:40:02,042 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCAD
2025-07-03 22:40:02,044 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('1.3570600000'), 'o': Decimal('1.3570400000')}
2025-07-03 22:40:02,044 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 1.3570600000
2025-07-03 22:40:02,044 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: -0.199240000000000000000000 CAD / 1.3570600000 = -0.1468173846403254093407808056 USD
2025-07-03 22:40:02,073 - INFO - orders - [DEBUG] DB commit completed for order 8870125869. Checking DB state...
2025-07-03 22:40:02,080 - INFO - orders - [DEBUG] After commit & refresh: order_id=8870125869, order_status=CLOSED, close_price=0.89225000, net_profit=-0.25000000, commission=0.10000000, close_id=6750683842, updated_at=2025-07-03 22:40:02
2025-07-03 22:40:02,080 - INFO - orders - AFTER COMMIT: User 4 wallet_balance=6609.52000000, margin=13.14000000
2025-07-03 22:40:02,080 - INFO - orders - Setting user data cache for user 4 with wallet_balance=6609.52000000, margin=13.14000000
2025-07-03 22:40:02,082 - INFO - orders - User data cache updated for user 4
2025-07-03 22:40:02,082 - INFO - orders - Starting update_user_static_orders for user 4, user_type live
2025-07-03 22:40:02,082 - INFO - orders - Using order model: UserOrder
2025-07-03 22:40:02,086 - INFO - orders - Fetched 1 open orders for user 4
2025-07-03 22:40:02,090 - INFO - orders - Fetched 0 pending orders for user 4
2025-07-03 22:40:02,091 - INFO - orders - Updated static orders cache for user 4 with 1 open orders and 0 pending orders
2025-07-03 22:40:02,091 - INFO - orders - Publishing order update for user 4
2025-07-03 22:40:02,093 - INFO - orders - Publishing user data update for user 4
2025-07-03 22:40:02,097 - INFO - orders - Publishing market data trigger
2025-07-03 22:40:02,103 - ERROR - orders - Error processing close order: 1 validation error for OrderResponse
status
  Input should be a valid string [type=string_type, input_value=None, input_type=NoneType]
    For further information visit https://errors.pydantic.dev/2.11/v/string_type
Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\app\api\v1\endpoints\orders.py", line 1393, in close_order
    return OrderResponse.model_validate(db_order, from_attributes=True)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\AppData\Local\Programs\Python\Python313\Lib\site-packages\pydantic\main.py", line 705, in model_validate
    return cls.__pydantic_validator__.validate_python(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        obj, strict=strict, from_attributes=from_attributes, context=context, by_alias=by_alias, by_name=by_name
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
pydantic_core._pydantic_core.ValidationError: 1 validation error for OrderResponse
status
  Input should be a valid string [type=string_type, input_value=None, input_type=NoneType]
    For further information visit https://errors.pydantic.dev/2.11/v/string_type
2025-07-03 22:40:02,105 - ERROR - orders - Error in close_order endpoint: 500: Error processing close order: 1 validation error for OrderResponse
status
  Input should be a valid string [type=string_type, input_value=None, input_type=NoneType]
    For further information visit https://errors.pydantic.dev/2.11/v/string_type
Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\app\api\v1\endpoints\orders.py", line 1393, in close_order
    return OrderResponse.model_validate(db_order, from_attributes=True)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\AppData\Local\Programs\Python\Python313\Lib\site-packages\pydantic\main.py", line 705, in model_validate
    return cls.__pydantic_validator__.validate_python(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        obj, strict=strict, from_attributes=from_attributes, context=context, by_alias=by_alias, by_name=by_name
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
pydantic_core._pydantic_core.ValidationError: 1 validation error for OrderResponse
status
  Input should be a valid string [type=string_type, input_value=None, input_type=NoneType]
    For further information visit https://errors.pydantic.dev/2.11/v/string_type

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\app\api\v1\endpoints\orders.py", line 1581, in close_order
    raise HTTPException(status_code=500, detail=f"Error processing close order: {str(e)}")
fastapi.exceptions.HTTPException: 500: Error processing close order: 1 validation error for OrderResponse
status
  Input should be a valid string [type=string_type, input_value=None, input_type=NoneType]
    For further information visit https://errors.pydantic.dev/2.11/v/string_type
2025-07-03 22:40:02,676 - INFO - orders - Order close request received - Order ID: 1244280912, User ID: 4, Close Price: 0.89225
2025-07-03 22:40:02,676 - INFO - orders - user_to_operate_on: <app.database.models.User object at 0x00000238609FC910>, type: <class 'app.database.models.User'>, user_type: live, attrs: ['__abstract__', '__class__', '__delattr__', '__dict__', '__dir__', '__doc__', '__eq__', '__firstlineno__', '__format__', '__ge__', '__getattribute__', '__getstate__', '__gt__', '__hash__', '__init__', '__init_subclass__', '__le__', '__lt__', '__mapper__', '__module__', '__ne__', '__new__', '__reduce__', '__reduce_ex__', '__repr__', '__setattr__', '__sizeof__', '__static_attributes__', '__str__', '__subclasshook__', '__table__', '__table_args__', '__tablename__', '__weakref__', '_sa_class_manager', '_sa_instance_state', '_sa_registry', 'account_number', 'address_proof', 'address_proof_image', 'bank_account_number', 'bank_branch_name', 'bank_holder_name', 'bank_ifsc_code', 'city', 'country', 'created_at', 'email', 'fund_manager', 'group_name', 'hashed_password', 'id', 'id_proof', 'id_proof_image', 'isActive', 'is_self_trading', 'is_service_account', 'leverage', 'margin', 'metadata', 'money_requests', 'name', 'net_profit', 'orders', 'otps', 'phone_number', 'pincode', 'referred_by_id', 'reffered_code', 'registry', 'rock_orders', 'security_answer', 'security_question', 'state', 'status', 'updated_at', 'user_favorites', 'user_type', 'wallet_balance', 'wallet_transactions']
2025-07-03 22:40:02,677 - INFO - orders - Using order model: user_orders for user 4 (user_type: live)
2025-07-03 22:40:02,677 - INFO - orders - Request to close order 1244280912 for user 4 (user_type: live) with price 0.89225. Frontend provided type: BUY, company: AUDCAD, status: CLOSED, frontend_status: CLOSED.
2025-07-03 22:40:02,690 - INFO - orders - User group: Standard, sending_orders setting: rock
2025-07-03 22:40:02,717 - INFO - orders - Live user 4 from group 'default' ('sending_orders' is NOT 'barclays'). Processing close locally.
2025-07-03 22:40:02,779 - INFO - orders - Existing entry commission for order 1244280912: 0.0
2025-07-03 22:40:02,779 - INFO - orders - Commission calculation for order 1244280912: entry=0.0, exit=0.100000000000, total=0.10
2025-07-03 22:40:02,779 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of -0.199240000000000000000000 CAD to USD for PnL on Close (user_id: 4, position: 1244280912)
2025-07-03 22:40:02,779 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CADUSD
2025-07-03 22:40:02,785 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-03 22:40:02,785 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CADUSD, trying inverse
2025-07-03 22:40:02,785 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCAD
2025-07-03 22:40:02,794 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('1.3570600000'), 'o': Decimal('1.3570400000')}
2025-07-03 22:40:02,794 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 1.3570600000
2025-07-03 22:40:02,794 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: -0.199240000000000000000000 CAD / 1.3570600000 = -0.1468173846403254093407808056 USD
2025-07-03 22:40:02,855 - INFO - orders - [DEBUG] DB commit completed for order 1244280912. Checking DB state...
2025-07-03 22:40:02,864 - INFO - orders - [DEBUG] After commit & refresh: order_id=1244280912, order_status=CLOSED, close_price=0.89225000, net_profit=-0.25000000, commission=0.10000000, close_id=8761894105, updated_at=2025-07-03 22:40:02
2025-07-03 22:40:02,864 - INFO - orders - AFTER COMMIT: User 4 wallet_balance=6609.27000000, margin=6.57000000
2025-07-03 22:40:02,864 - INFO - orders - Setting user data cache for user 4 with wallet_balance=6609.27000000, margin=6.57000000
2025-07-03 22:40:02,866 - INFO - orders - User data cache updated for user 4
2025-07-03 22:40:02,867 - INFO - orders - Starting update_user_static_orders for user 4, user_type live
2025-07-03 22:40:02,867 - INFO - orders - Using order model: UserOrder
2025-07-03 22:40:02,872 - INFO - orders - Fetched 0 open orders for user 4
2025-07-03 22:40:02,877 - INFO - orders - Fetched 0 pending orders for user 4
2025-07-03 22:40:02,879 - INFO - orders - Updated static orders cache for user 4 with 0 open orders and 0 pending orders
2025-07-03 22:40:02,879 - INFO - orders - Publishing order update for user 4
2025-07-03 22:40:02,881 - INFO - orders - Publishing user data update for user 4
2025-07-03 22:40:02,883 - INFO - orders - Publishing market data trigger
2025-07-03 22:40:02,886 - ERROR - orders - Error processing close order: 1 validation error for OrderResponse
status
  Input should be a valid string [type=string_type, input_value=None, input_type=NoneType]
    For further information visit https://errors.pydantic.dev/2.11/v/string_type
Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\app\api\v1\endpoints\orders.py", line 1393, in close_order
    return OrderResponse.model_validate(db_order, from_attributes=True)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\AppData\Local\Programs\Python\Python313\Lib\site-packages\pydantic\main.py", line 705, in model_validate
    return cls.__pydantic_validator__.validate_python(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        obj, strict=strict, from_attributes=from_attributes, context=context, by_alias=by_alias, by_name=by_name
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
pydantic_core._pydantic_core.ValidationError: 1 validation error for OrderResponse
status
  Input should be a valid string [type=string_type, input_value=None, input_type=NoneType]
    For further information visit https://errors.pydantic.dev/2.11/v/string_type
2025-07-03 22:40:02,889 - ERROR - orders - Error in close_order endpoint: 500: Error processing close order: 1 validation error for OrderResponse
status
  Input should be a valid string [type=string_type, input_value=None, input_type=NoneType]
    For further information visit https://errors.pydantic.dev/2.11/v/string_type
Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\app\api\v1\endpoints\orders.py", line 1393, in close_order
    return OrderResponse.model_validate(db_order, from_attributes=True)
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
  File "C:\Users\Dhanush\AppData\Local\Programs\Python\Python313\Lib\site-packages\pydantic\main.py", line 705, in model_validate
    return cls.__pydantic_validator__.validate_python(
           ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~^
        obj, strict=strict, from_attributes=from_attributes, context=context, by_alias=by_alias, by_name=by_name
        ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
    )
    ^
pydantic_core._pydantic_core.ValidationError: 1 validation error for OrderResponse
status
  Input should be a valid string [type=string_type, input_value=None, input_type=NoneType]
    For further information visit https://errors.pydantic.dev/2.11/v/string_type

During handling of the above exception, another exception occurred:

Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\app\api\v1\endpoints\orders.py", line 1581, in close_order
    raise HTTPException(status_code=500, detail=f"Error processing close order: {str(e)}")
fastapi.exceptions.HTTPException: 500: Error processing close order: 1 validation error for OrderResponse
status
  Input should be a valid string [type=string_type, input_value=None, input_type=NoneType]
    For further information visit https://errors.pydantic.dev/2.11/v/string_type
2025-07-03 22:43:23,368 - INFO - orders - Application starting up - Orders logging initialized
2025-07-03 22:43:23,368 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-03 22:44:01,273 - INFO - orders - Application starting up - Orders logging initialized
2025-07-03 22:44:01,273 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-03 22:44:05,745 - INFO - orders - Application starting up - Orders logging initialized
2025-07-03 22:44:05,745 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-03 22:44:40,778 - INFO - orders - Application starting up - Orders logging initialized
2025-07-03 22:44:40,778 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-03 22:45:43,818 - app.api.v1.endpoints.orders - INFO - [get_rejected_orders] user_type: live
2025-07-03 22:45:49,340 - INFO - orders - Order placement request received - User: 4, Symbol: AUDCAD, Type: BUY
2025-07-03 22:45:49,704 - INFO - orders - [MARGIN_CALC] Market data for AUDCAD: {'b': '0.8922700000', 'o': '0.8922200000'}
2025-07-03 22:45:49,704 - WARNING - orders - [MARGIN_CALC] Missing ask price for AUDCAD, using bid price with spread: bid=0.8922700000, ask=0.89235922700000
2025-07-03 22:45:49,704 - INFO - orders - [MARGIN_CALC] Using prices for AUDCAD: bid=0.8922700000, ask=0.89235922700000
2025-07-03 22:45:49,705 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 8.92 CAD to USD for margin_calculation (user_id: 4, position: None)
2025-07-03 22:45:49,705 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CADUSD
2025-07-03 22:45:49,706 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-03 22:45:49,706 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CADUSD, trying inverse
2025-07-03 22:45:49,706 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCAD
2025-07-03 22:45:49,707 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('1.3571600000'), 'o': Decimal('1.3571100000')}
2025-07-03 22:45:49,707 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 1.3571600000
2025-07-03 22:45:49,707 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 8.92 CAD / 1.3571600000 = 6.572548557281381708862624893 USD
2025-07-03 22:45:49,707 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: AUDCAD, Type: BUY, Qty: 0.01, Price: 0.89235922700000, Margin: 6.572548557281381708862624893, Commission: 0.00
2025-07-03 22:45:49,730 - INFO - orders - [PERF] Order processing: 0.3887s
2025-07-03 22:45:49,731 - DEBUG - orders - [DEBUG][create_user_order] Received order_data: {'order_id': '6672455064', 'order_status': 'OPEN', 'order_user_id': 4, 'order_company_name': 'AUDCAD', 'order_type': 'BUY', 'order_price': Decimal('0.89235922700000'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('892.36'), 'margin': Decimal('6.572548557281381708862624893'), 'commission': Decimal('0.00'), 'status': None, 'stop_loss': None, 'take_profit': None, 'stoploss_id': None, 'takeprofit_id': None, 'close_id': None}
2025-07-03 22:45:49,732 - DEBUG - orders - [DEBUG][create_user_order] Created OrderActionHistory record for order_id: 6672455064
2025-07-03 22:45:49,753 - INFO - orders - [PERF] Order creation: 0.0220s
2025-07-03 22:45:49,753 - INFO - orders - [PERF] TOTAL place_order: 0.4136s
2025-07-03 22:45:49,765 - app.api.v1.endpoints.orders - INFO - User 4: Updated static orders cache after order change - 1 open orders, 0 pending orders
2025-07-03 22:45:49,765 - ERROR - orders - Error updating portfolio: calculate_user_portfolio() missing 1 required positional argument: 'redis_client'
2025-07-03 22:45:51,858 - INFO - orders - Order placement request received - User: 4, Symbol: AUDCAD, Type: SELL
2025-07-03 22:45:52,158 - INFO - orders - [MARGIN_CALC] Market data for AUDCAD: {'b': '0.8922700000', 'o': '0.8922200000'}
2025-07-03 22:45:52,158 - WARNING - orders - [MARGIN_CALC] Missing ask price for AUDCAD, using bid price with spread: bid=0.8922700000, ask=0.89235922700000
2025-07-03 22:45:52,158 - INFO - orders - [MARGIN_CALC] Using prices for AUDCAD: bid=0.8922700000, ask=0.89235922700000
2025-07-03 22:45:52,159 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 8.92 CAD to USD for margin_calculation (user_id: 4, position: None)
2025-07-03 22:45:52,159 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CADUSD
2025-07-03 22:45:52,161 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-03 22:45:52,161 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CADUSD, trying inverse
2025-07-03 22:45:52,161 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCAD
2025-07-03 22:45:52,163 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('1.3570600000'), 'o': Decimal('1.3571100000')}
2025-07-03 22:45:52,163 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 1.3570600000
2025-07-03 22:45:52,164 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 8.92 CAD / 1.3570600000 = 6.573032879902141393895627312 USD
2025-07-03 22:45:52,164 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: AUDCAD, Type: SELL, Qty: 0.01, Price: 0.8922700000, Margin: 6.573032879902141393895627312, Commission: 0.00
2025-07-03 22:45:52,182 - INFO - orders - [PERF] Order processing: 0.3228s
2025-07-03 22:45:52,183 - DEBUG - orders - [DEBUG][create_user_order] Received order_data: {'order_id': '7445140659', 'order_status': 'OPEN', 'order_user_id': 4, 'order_company_name': 'AUDCAD', 'order_type': 'SELL', 'order_price': Decimal('0.8922700000'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('892.27'), 'margin': Decimal('6.573032879902141393895627312'), 'commission': Decimal('0.00'), 'status': None, 'stop_loss': None, 'take_profit': None, 'stoploss_id': None, 'takeprofit_id': None, 'close_id': None}
2025-07-03 22:45:52,184 - DEBUG - orders - [DEBUG][create_user_order] Created OrderActionHistory record for order_id: 7445140659
2025-07-03 22:45:52,213 - INFO - orders - [PERF] Order creation: 0.0302s
2025-07-03 22:45:52,214 - INFO - orders - [PERF] TOTAL place_order: 0.3562s
2025-07-03 22:45:52,236 - app.api.v1.endpoints.orders - INFO - User 4: Updated static orders cache after order change - 2 open orders, 0 pending orders
2025-07-03 22:45:52,237 - ERROR - orders - Error updating portfolio: calculate_user_portfolio() missing 1 required positional argument: 'redis_client'
2025-07-03 22:45:55,618 - INFO - orders - Order placement request received - User: 4, Symbol: AUDCAD, Type: SELL
2025-07-03 22:45:55,952 - INFO - orders - [MARGIN_CALC] Market data for AUDCAD: {'b': '0.8922500000', 'o': '0.8922000000'}
2025-07-03 22:45:55,952 - WARNING - orders - [MARGIN_CALC] Missing ask price for AUDCAD, using bid price with spread: bid=0.8922500000, ask=0.89233922500000
2025-07-03 22:45:55,952 - INFO - orders - [MARGIN_CALC] Using prices for AUDCAD: bid=0.8922500000, ask=0.89233922500000
2025-07-03 22:45:55,954 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 8.92 CAD to USD for margin_calculation (user_id: 4, position: None)
2025-07-03 22:45:55,954 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CADUSD
2025-07-03 22:45:55,956 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-03 22:45:55,956 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CADUSD, trying inverse
2025-07-03 22:45:55,957 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCAD
2025-07-03 22:45:55,958 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('1.3571600000'), 'o': Decimal('1.3571200000')}
2025-07-03 22:45:55,958 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 1.3571600000
2025-07-03 22:45:55,958 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 8.92 CAD / 1.3571600000 = 6.572548557281381708862624893 USD
2025-07-03 22:45:55,958 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: AUDCAD, Type: SELL, Qty: 0.01, Price: 0.8922500000, Margin: 6.572548557281381708862624893, Commission: 0.00
2025-07-03 22:45:55,984 - INFO - orders - [PERF] Order processing: 0.3628s
2025-07-03 22:45:55,985 - DEBUG - orders - [DEBUG][create_user_order] Received order_data: {'order_id': '6752035784', 'order_status': 'OPEN', 'order_user_id': 4, 'order_company_name': 'AUDCAD', 'order_type': 'SELL', 'order_price': Decimal('0.8922500000'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('892.25'), 'margin': Decimal('6.572548557281381708862624893'), 'commission': Decimal('0.00'), 'status': None, 'stop_loss': None, 'take_profit': None, 'stoploss_id': None, 'takeprofit_id': None, 'close_id': None}
2025-07-03 22:45:55,986 - DEBUG - orders - [DEBUG][create_user_order] Created OrderActionHistory record for order_id: 6752035784
2025-07-03 22:45:56,009 - INFO - orders - [PERF] Order creation: 0.0239s
2025-07-03 22:45:56,009 - INFO - orders - [PERF] TOTAL place_order: 0.3917s
2025-07-03 22:45:56,021 - app.api.v1.endpoints.orders - INFO - User 4: Updated static orders cache after order change - 3 open orders, 0 pending orders
2025-07-03 22:45:56,022 - ERROR - orders - Error updating portfolio: calculate_user_portfolio() missing 1 required positional argument: 'redis_client'
2025-07-03 22:46:04,969 - INFO - orders - Order placement request received - User: 4, Symbol: AUDCAD, Type: BUY
2025-07-03 22:46:05,360 - INFO - orders - [MARGIN_CALC] Market data for AUDCAD: {'b': '0.8922800000', 'o': '0.8922500000'}
2025-07-03 22:46:05,360 - WARNING - orders - [MARGIN_CALC] Missing ask price for AUDCAD, using bid price with spread: bid=0.8922800000, ask=0.89236922800000
2025-07-03 22:46:05,360 - INFO - orders - [MARGIN_CALC] Using prices for AUDCAD: bid=0.8922800000, ask=0.89236922800000
2025-07-03 22:46:05,362 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 8.92 CAD to USD for margin_calculation (user_id: 4, position: None)
2025-07-03 22:46:05,362 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CADUSD
2025-07-03 22:46:05,363 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-03 22:46:05,363 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CADUSD, trying inverse
2025-07-03 22:46:05,364 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCAD
2025-07-03 22:46:05,365 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('1.3571700000'), 'o': Decimal('1.3571400000')}
2025-07-03 22:46:05,365 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 1.3571700000
2025-07-03 22:46:05,365 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 8.92 CAD / 1.3571700000 = 6.572500128944789525262126336 USD
2025-07-03 22:46:05,365 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: AUDCAD, Type: BUY, Qty: 0.01, Price: 0.89236922800000, Margin: 6.572500128944789525262126336, Commission: 0.00
2025-07-03 22:46:05,383 - INFO - orders - [PERF] Order processing: 0.4119s
2025-07-03 22:46:05,383 - DEBUG - orders - [DEBUG][create_user_order] Received order_data: {'order_id': '3677195413', 'order_status': 'OPEN', 'order_user_id': 4, 'order_company_name': 'AUDCAD', 'order_type': 'BUY', 'order_price': Decimal('0.89236922800000'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('892.37'), 'margin': Decimal('6.572500128944789525262126336'), 'commission': Decimal('0.00'), 'status': None, 'stop_loss': None, 'take_profit': None, 'stoploss_id': None, 'takeprofit_id': None, 'close_id': None}
2025-07-03 22:46:05,384 - DEBUG - orders - [DEBUG][create_user_order] Created OrderActionHistory record for order_id: 3677195413
2025-07-03 22:46:05,400 - INFO - orders - [PERF] Order creation: 0.0174s
2025-07-03 22:46:05,401 - INFO - orders - [PERF] TOTAL place_order: 0.4321s
2025-07-03 22:46:05,412 - app.api.v1.endpoints.orders - INFO - User 4: Updated static orders cache after order change - 4 open orders, 0 pending orders
2025-07-03 22:46:05,412 - ERROR - orders - Error updating portfolio: calculate_user_portfolio() missing 1 required positional argument: 'redis_client'
2025-07-03 22:46:44,895 - INFO - orders - Order close request received - Order ID: 3677195413, User ID: 4, Close Price: 0.89215
2025-07-03 22:46:44,896 - INFO - orders - user_to_operate_on: <app.database.models.User object at 0x00000167ED14E710>, type: <class 'app.database.models.User'>, user_type: live, attrs: ['__abstract__', '__class__', '__delattr__', '__dict__', '__dir__', '__doc__', '__eq__', '__firstlineno__', '__format__', '__ge__', '__getattribute__', '__getstate__', '__gt__', '__hash__', '__init__', '__init_subclass__', '__le__', '__lt__', '__mapper__', '__module__', '__ne__', '__new__', '__reduce__', '__reduce_ex__', '__repr__', '__setattr__', '__sizeof__', '__static_attributes__', '__str__', '__subclasshook__', '__table__', '__table_args__', '__tablename__', '__weakref__', '_sa_class_manager', '_sa_instance_state', '_sa_registry', 'account_number', 'address_proof', 'address_proof_image', 'bank_account_number', 'bank_branch_name', 'bank_holder_name', 'bank_ifsc_code', 'city', 'country', 'created_at', 'email', 'fund_manager', 'group_name', 'hashed_password', 'id', 'id_proof', 'id_proof_image', 'isActive', 'is_self_trading', 'is_service_account', 'leverage', 'margin', 'metadata', 'money_requests', 'name', 'net_profit', 'orders', 'otps', 'phone_number', 'pincode', 'referred_by_id', 'reffered_code', 'registry', 'rock_orders', 'security_answer', 'security_question', 'state', 'status', 'updated_at', 'user_favorites', 'user_type', 'wallet_balance', 'wallet_transactions']
2025-07-03 22:46:44,896 - INFO - orders - Using order model: user_orders for user 4 (user_type: live)
2025-07-03 22:46:44,896 - INFO - orders - Request to close order 3677195413 for user 4 (user_type: live) with price 0.89215. Frontend provided type: BUY, company: AUDCAD, status: CLOSED, frontend_status: CLOSED.
2025-07-03 22:46:44,902 - INFO - orders - User group: Standard, sending_orders setting: rock
2025-07-03 22:46:44,914 - INFO - orders - Live user 4 from group 'default' ('sending_orders' is NOT 'barclays'). Processing close locally.
2025-07-03 22:46:44,931 - INFO - orders - Existing entry commission for order 3677195413: 0.0
2025-07-03 22:46:44,931 - INFO - orders - Commission calculation for order 3677195413: entry=0.0, exit=0.100000000000, total=0.10
2025-07-03 22:46:44,931 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of -0.219230000000000000000000 CAD to USD for PnL on Close (user_id: 4, position: 3677195413)
2025-07-03 22:46:44,931 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CADUSD
2025-07-03 22:46:44,933 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-03 22:46:44,933 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CADUSD, trying inverse
2025-07-03 22:46:44,933 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCAD
2025-07-03 22:46:44,934 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('1.3571700000'), 'o': Decimal('1.3571300000')}
2025-07-03 22:46:44,935 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 1.3571700000
2025-07-03 22:46:44,935 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: -0.219230000000000000000000 CAD / 1.3571700000 = -0.1615346640435612340384771252 USD
2025-07-03 22:46:44,959 - INFO - orders - [DEBUG] DB commit completed for order 3677195413. Checking DB state...
2025-07-03 22:46:44,964 - INFO - orders - [DEBUG] After commit & refresh: order_id=3677195413, order_status=CLOSED, close_price=0.89215000, net_profit=-0.26000000, commission=0.10000000, close_id=7503183635, updated_at=2025-07-03 22:46:44
2025-07-03 22:46:44,964 - INFO - orders - AFTER COMMIT: User 4 wallet_balance=6609.01000000, margin=19.72000000
2025-07-03 22:46:44,965 - INFO - orders - Setting user data cache for user 4 with wallet_balance=6609.01000000, margin=19.72000000
2025-07-03 22:46:44,966 - INFO - orders - User data cache updated for user 4
2025-07-03 22:46:44,966 - INFO - orders - Starting update_user_static_orders for user 4, user_type live
2025-07-03 22:46:44,966 - INFO - orders - Using order model: UserOrder
2025-07-03 22:46:44,970 - INFO - orders - Fetched 3 open orders for user 4
2025-07-03 22:46:44,973 - INFO - orders - Fetched 0 pending orders for user 4
2025-07-03 22:46:44,974 - INFO - orders - Updated static orders cache for user 4 with 3 open orders and 0 pending orders
2025-07-03 22:46:44,974 - INFO - orders - Publishing order update for user 4
2025-07-03 22:46:44,976 - INFO - orders - Publishing user data update for user 4
2025-07-03 22:46:44,977 - INFO - orders - Publishing market data trigger
2025-07-03 22:46:45,548 - INFO - orders - Order close request received - Order ID: 6752035784, User ID: 4, Close Price: 0.89239
2025-07-03 22:46:45,549 - INFO - orders - user_to_operate_on: <app.database.models.User object at 0x00000167ED4116D0>, type: <class 'app.database.models.User'>, user_type: live, attrs: ['__abstract__', '__class__', '__delattr__', '__dict__', '__dir__', '__doc__', '__eq__', '__firstlineno__', '__format__', '__ge__', '__getattribute__', '__getstate__', '__gt__', '__hash__', '__init__', '__init_subclass__', '__le__', '__lt__', '__mapper__', '__module__', '__ne__', '__new__', '__reduce__', '__reduce_ex__', '__repr__', '__setattr__', '__sizeof__', '__static_attributes__', '__str__', '__subclasshook__', '__table__', '__table_args__', '__tablename__', '__weakref__', '_sa_class_manager', '_sa_instance_state', '_sa_registry', 'account_number', 'address_proof', 'address_proof_image', 'bank_account_number', 'bank_branch_name', 'bank_holder_name', 'bank_ifsc_code', 'city', 'country', 'created_at', 'email', 'fund_manager', 'group_name', 'hashed_password', 'id', 'id_proof', 'id_proof_image', 'isActive', 'is_self_trading', 'is_service_account', 'leverage', 'margin', 'metadata', 'money_requests', 'name', 'net_profit', 'orders', 'otps', 'phone_number', 'pincode', 'referred_by_id', 'reffered_code', 'registry', 'rock_orders', 'security_answer', 'security_question', 'state', 'status', 'updated_at', 'user_favorites', 'user_type', 'wallet_balance', 'wallet_transactions']
2025-07-03 22:46:45,549 - INFO - orders - Using order model: user_orders for user 4 (user_type: live)
2025-07-03 22:46:45,549 - INFO - orders - Request to close order 6752035784 for user 4 (user_type: live) with price 0.89239. Frontend provided type: SELL, company: AUDCAD, status: CLOSED, frontend_status: CLOSED.
2025-07-03 22:46:45,567 - INFO - orders - User group: Standard, sending_orders setting: rock
2025-07-03 22:46:45,580 - INFO - orders - Live user 4 from group 'default' ('sending_orders' is NOT 'barclays'). Processing close locally.
2025-07-03 22:46:45,618 - INFO - orders - Existing entry commission for order 6752035784: 0.0
2025-07-03 22:46:45,619 - INFO - orders - Commission calculation for order 6752035784: entry=0.0, exit=0.100000000000, total=0.10
2025-07-03 22:46:45,619 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of -0.140000000000000000000000 CAD to USD for PnL on Close (user_id: 4, position: 6752035784)
2025-07-03 22:46:45,619 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CADUSD
2025-07-03 22:46:45,622 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-03 22:46:45,622 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CADUSD, trying inverse
2025-07-03 22:46:45,622 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCAD
2025-07-03 22:46:45,625 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('1.3571700000'), 'o': Decimal('1.3571300000')}
2025-07-03 22:46:45,626 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 1.3571700000
2025-07-03 22:46:45,626 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: -0.140000000000000000000000 CAD / 1.3571700000 = -0.1031558316202097010691365120 USD
2025-07-03 22:46:45,669 - INFO - orders - [DEBUG] DB commit completed for order 6752035784. Checking DB state...
2025-07-03 22:46:45,681 - INFO - orders - [DEBUG] After commit & refresh: order_id=6752035784, order_status=CLOSED, close_price=0.89239000, net_profit=-0.20000000, commission=0.10000000, close_id=1665031477, updated_at=2025-07-03 22:46:45
2025-07-03 22:46:45,681 - INFO - orders - AFTER COMMIT: User 4 wallet_balance=6608.81000000, margin=13.14000000
2025-07-03 22:46:45,681 - INFO - orders - Setting user data cache for user 4 with wallet_balance=6608.81000000, margin=13.14000000
2025-07-03 22:46:45,684 - INFO - orders - User data cache updated for user 4
2025-07-03 22:46:45,684 - INFO - orders - Starting update_user_static_orders for user 4, user_type live
2025-07-03 22:46:45,684 - INFO - orders - Using order model: UserOrder
2025-07-03 22:46:45,693 - INFO - orders - Fetched 2 open orders for user 4
2025-07-03 22:46:45,699 - INFO - orders - Fetched 0 pending orders for user 4
2025-07-03 22:46:45,701 - INFO - orders - Updated static orders cache for user 4 with 2 open orders and 0 pending orders
2025-07-03 22:46:45,702 - INFO - orders - Publishing order update for user 4
2025-07-03 22:46:45,704 - INFO - orders - Publishing user data update for user 4
2025-07-03 22:46:45,706 - INFO - orders - Publishing market data trigger
2025-07-03 22:46:46,263 - INFO - orders - Order close request received - Order ID: 7445140659, User ID: 4, Close Price: 0.89238
2025-07-03 22:46:46,263 - INFO - orders - user_to_operate_on: <app.database.models.User object at 0x00000167ED411590>, type: <class 'app.database.models.User'>, user_type: live, attrs: ['__abstract__', '__class__', '__delattr__', '__dict__', '__dir__', '__doc__', '__eq__', '__firstlineno__', '__format__', '__ge__', '__getattribute__', '__getstate__', '__gt__', '__hash__', '__init__', '__init_subclass__', '__le__', '__lt__', '__mapper__', '__module__', '__ne__', '__new__', '__reduce__', '__reduce_ex__', '__repr__', '__setattr__', '__sizeof__', '__static_attributes__', '__str__', '__subclasshook__', '__table__', '__table_args__', '__tablename__', '__weakref__', '_sa_class_manager', '_sa_instance_state', '_sa_registry', 'account_number', 'address_proof', 'address_proof_image', 'bank_account_number', 'bank_branch_name', 'bank_holder_name', 'bank_ifsc_code', 'city', 'country', 'created_at', 'email', 'fund_manager', 'group_name', 'hashed_password', 'id', 'id_proof', 'id_proof_image', 'isActive', 'is_self_trading', 'is_service_account', 'leverage', 'margin', 'metadata', 'money_requests', 'name', 'net_profit', 'orders', 'otps', 'phone_number', 'pincode', 'referred_by_id', 'reffered_code', 'registry', 'rock_orders', 'security_answer', 'security_question', 'state', 'status', 'updated_at', 'user_favorites', 'user_type', 'wallet_balance', 'wallet_transactions']
2025-07-03 22:46:46,263 - INFO - orders - Using order model: user_orders for user 4 (user_type: live)
2025-07-03 22:46:46,263 - INFO - orders - Request to close order 7445140659 for user 4 (user_type: live) with price 0.89238. Frontend provided type: SELL, company: AUDCAD, status: CLOSED, frontend_status: CLOSED.
2025-07-03 22:46:46,275 - INFO - orders - User group: Standard, sending_orders setting: rock
2025-07-03 22:46:46,288 - INFO - orders - Live user 4 from group 'default' ('sending_orders' is NOT 'barclays'). Processing close locally.
2025-07-03 22:46:46,314 - INFO - orders - Existing entry commission for order 7445140659: 0.0
2025-07-03 22:46:46,314 - INFO - orders - Commission calculation for order 7445140659: entry=0.0, exit=0.100000000000, total=0.10
2025-07-03 22:46:46,314 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of -0.110000000000000000000000 CAD to USD for PnL on Close (user_id: 4, position: 7445140659)
2025-07-03 22:46:46,314 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CADUSD
2025-07-03 22:46:46,316 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-03 22:46:46,316 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CADUSD, trying inverse
2025-07-03 22:46:46,316 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCAD
2025-07-03 22:46:46,320 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('1.3571800000'), 'o': Decimal('1.3571000000')}
2025-07-03 22:46:46,320 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 1.3571800000
2025-07-03 22:46:46,321 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: -0.110000000000000000000000 CAD / 1.3571800000 = -0.08105041335710812125141838223 USD
2025-07-03 22:46:46,653 - INFO - orders - [DEBUG] DB commit completed for order 7445140659. Checking DB state...
2025-07-03 22:46:46,657 - INFO - orders - [DEBUG] After commit & refresh: order_id=7445140659, order_status=CLOSED, close_price=0.89238000, net_profit=-0.18000000, commission=0.10000000, close_id=9380829754, updated_at=2025-07-03 22:46:46
2025-07-03 22:46:46,658 - INFO - orders - AFTER COMMIT: User 4 wallet_balance=6608.63000000, margin=13.14000000
2025-07-03 22:46:46,658 - INFO - orders - Setting user data cache for user 4 with wallet_balance=6608.63000000, margin=13.14000000
2025-07-03 22:46:46,659 - INFO - orders - User data cache updated for user 4
2025-07-03 22:46:46,659 - INFO - orders - Starting update_user_static_orders for user 4, user_type live
2025-07-03 22:46:46,660 - INFO - orders - Using order model: UserOrder
2025-07-03 22:46:46,666 - INFO - orders - Fetched 1 open orders for user 4
2025-07-03 22:46:46,669 - INFO - orders - Fetched 0 pending orders for user 4
2025-07-03 22:46:46,671 - INFO - orders - Updated static orders cache for user 4 with 1 open orders and 0 pending orders
2025-07-03 22:46:46,671 - INFO - orders - Publishing order update for user 4
2025-07-03 22:46:46,673 - INFO - orders - Publishing user data update for user 4
2025-07-03 22:46:46,676 - INFO - orders - Publishing market data trigger
2025-07-03 22:46:47,224 - INFO - orders - Order close request received - Order ID: 6672455064, User ID: 4, Close Price: 0.89215
2025-07-03 22:46:47,224 - INFO - orders - user_to_operate_on: <app.database.models.User object at 0x00000167ED410CD0>, type: <class 'app.database.models.User'>, user_type: live, attrs: ['__abstract__', '__class__', '__delattr__', '__dict__', '__dir__', '__doc__', '__eq__', '__firstlineno__', '__format__', '__ge__', '__getattribute__', '__getstate__', '__gt__', '__hash__', '__init__', '__init_subclass__', '__le__', '__lt__', '__mapper__', '__module__', '__ne__', '__new__', '__reduce__', '__reduce_ex__', '__repr__', '__setattr__', '__sizeof__', '__static_attributes__', '__str__', '__subclasshook__', '__table__', '__table_args__', '__tablename__', '__weakref__', '_sa_class_manager', '_sa_instance_state', '_sa_registry', 'account_number', 'address_proof', 'address_proof_image', 'bank_account_number', 'bank_branch_name', 'bank_holder_name', 'bank_ifsc_code', 'city', 'country', 'created_at', 'email', 'fund_manager', 'group_name', 'hashed_password', 'id', 'id_proof', 'id_proof_image', 'isActive', 'is_self_trading', 'is_service_account', 'leverage', 'margin', 'metadata', 'money_requests', 'name', 'net_profit', 'orders', 'otps', 'phone_number', 'pincode', 'referred_by_id', 'reffered_code', 'registry', 'rock_orders', 'security_answer', 'security_question', 'state', 'status', 'updated_at', 'user_favorites', 'user_type', 'wallet_balance', 'wallet_transactions']
2025-07-03 22:46:47,225 - INFO - orders - Using order model: user_orders for user 4 (user_type: live)
2025-07-03 22:46:47,225 - INFO - orders - Request to close order 6672455064 for user 4 (user_type: live) with price 0.89215. Frontend provided type: BUY, company: AUDCAD, status: CLOSED, frontend_status: CLOSED.
2025-07-03 22:46:47,250 - INFO - orders - User group: Standard, sending_orders setting: rock
2025-07-03 22:46:47,274 - INFO - orders - Live user 4 from group 'default' ('sending_orders' is NOT 'barclays'). Processing close locally.
2025-07-03 22:46:47,293 - INFO - orders - Existing entry commission for order 6672455064: 0.0
2025-07-03 22:46:47,293 - INFO - orders - Commission calculation for order 6672455064: entry=0.0, exit=0.100000000000, total=0.10
2025-07-03 22:46:47,293 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of -0.209230000000000000000000 CAD to USD for PnL on Close (user_id: 4, position: 6672455064)
2025-07-03 22:46:47,293 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CADUSD
2025-07-03 22:46:47,295 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-03 22:46:47,295 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CADUSD, trying inverse
2025-07-03 22:46:47,295 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCAD
2025-07-03 22:46:47,297 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('1.3571800000'), 'o': Decimal('1.3571000000')}
2025-07-03 22:46:47,297 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 1.3571800000
2025-07-03 22:46:47,297 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: -0.209230000000000000000000 CAD / 1.3571800000 = -0.1541652544246157473584933465 USD
2025-07-03 22:46:47,325 - INFO - orders - [DEBUG] DB commit completed for order 6672455064. Checking DB state...
2025-07-03 22:46:47,332 - INFO - orders - [DEBUG] After commit & refresh: order_id=6672455064, order_status=CLOSED, close_price=0.89215000, net_profit=-0.25000000, commission=0.10000000, close_id=3775643139, updated_at=2025-07-03 22:46:47
2025-07-03 22:46:47,332 - INFO - orders - AFTER COMMIT: User 4 wallet_balance=6608.38000000, margin=6.57000000
2025-07-03 22:46:47,332 - INFO - orders - Setting user data cache for user 4 with wallet_balance=6608.38000000, margin=6.57000000
2025-07-03 22:46:47,334 - INFO - orders - User data cache updated for user 4
2025-07-03 22:46:47,334 - INFO - orders - Starting update_user_static_orders for user 4, user_type live
2025-07-03 22:46:47,334 - INFO - orders - Using order model: UserOrder
2025-07-03 22:46:47,341 - INFO - orders - Fetched 0 open orders for user 4
2025-07-03 22:46:47,346 - INFO - orders - Fetched 0 pending orders for user 4
2025-07-03 22:46:47,347 - INFO - orders - Updated static orders cache for user 4 with 0 open orders and 0 pending orders
2025-07-03 22:46:47,348 - INFO - orders - Publishing order update for user 4
2025-07-03 22:46:47,352 - INFO - orders - Publishing user data update for user 4
2025-07-03 22:46:47,353 - INFO - orders - Publishing market data trigger
2025-07-03 22:47:26,252 - INFO - orders - Order placement request received - User: 4, Symbol: AUDCAD, Type: BUY
2025-07-03 22:47:26,643 - INFO - orders - [MARGIN_CALC] Market data for AUDCAD: {'b': '0.8923000000', 'o': '0.8922500000'}
2025-07-03 22:47:26,644 - WARNING - orders - [MARGIN_CALC] Missing ask price for AUDCAD, using bid price with spread: bid=0.8923000000, ask=0.89238923000000
2025-07-03 22:47:26,644 - INFO - orders - [MARGIN_CALC] Using prices for AUDCAD: bid=0.8923000000, ask=0.89238923000000
2025-07-03 22:47:26,646 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 8.92 CAD to USD for margin_calculation (user_id: 4, position: None)
2025-07-03 22:47:26,646 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CADUSD
2025-07-03 22:47:26,652 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-03 22:47:26,652 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CADUSD, trying inverse
2025-07-03 22:47:26,653 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCAD
2025-07-03 22:47:26,656 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('1.3570700000'), 'o': Decimal('1.3570100000')}
2025-07-03 22:47:26,657 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 1.3570700000
2025-07-03 22:47:26,657 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 8.92 CAD / 1.3570700000 = 6.572984444428069296351698881 USD
2025-07-03 22:47:26,657 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: AUDCAD, Type: BUY, Qty: 0.01, Price: 0.89238923000000, Margin: 6.572984444428069296351698881, Commission: 0.00
2025-07-03 22:47:26,703 - INFO - orders - [PERF] Order processing: 0.4505s
2025-07-03 22:47:26,704 - DEBUG - orders - [DEBUG][create_user_order] Received order_data: {'order_id': '4451713161', 'order_status': 'OPEN', 'order_user_id': 4, 'order_company_name': 'AUDCAD', 'order_type': 'BUY', 'order_price': Decimal('0.89238923000000'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('892.39'), 'margin': Decimal('6.572984444428069296351698881'), 'commission': Decimal('0.00'), 'status': None, 'stop_loss': None, 'take_profit': None, 'stoploss_id': None, 'takeprofit_id': None, 'close_id': None}
2025-07-03 22:47:26,705 - DEBUG - orders - [DEBUG][create_user_order] Created OrderActionHistory record for order_id: 4451713161
2025-07-03 22:47:26,791 - INFO - orders - [PERF] Order creation: 0.0875s
2025-07-03 22:47:26,792 - INFO - orders - [PERF] TOTAL place_order: 0.5399s
2025-07-03 22:47:26,839 - app.api.v1.endpoints.orders - INFO - User 4: Updated static orders cache after order change - 1 open orders, 0 pending orders
2025-07-03 22:47:26,839 - ERROR - orders - Error updating portfolio: calculate_user_portfolio() missing 1 required positional argument: 'redis_client'
2025-07-03 22:47:29,456 - INFO - orders - Order placement request received - User: 4, Symbol: AUDCAD, Type: SELL
2025-07-03 22:47:29,854 - INFO - orders - [MARGIN_CALC] Market data for AUDCAD: {'b': '0.8922900000', 'o': '0.8922700000'}
2025-07-03 22:47:29,854 - WARNING - orders - [MARGIN_CALC] Missing ask price for AUDCAD, using bid price with spread: bid=0.8922900000, ask=0.89237922900000
2025-07-03 22:47:29,855 - INFO - orders - [MARGIN_CALC] Using prices for AUDCAD: bid=0.8922900000, ask=0.89237922900000
2025-07-03 22:47:29,856 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 8.92 CAD to USD for margin_calculation (user_id: 4, position: None)
2025-07-03 22:47:29,856 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CADUSD
2025-07-03 22:47:29,859 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-03 22:47:29,860 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CADUSD, trying inverse
2025-07-03 22:47:29,860 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCAD
2025-07-03 22:47:29,862 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('1.3570600000'), 'o': Decimal('1.3570400000')}
2025-07-03 22:47:29,862 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 1.3570600000
2025-07-03 22:47:29,863 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 8.92 CAD / 1.3570600000 = 6.573032879902141393895627312 USD
2025-07-03 22:47:29,863 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: AUDCAD, Type: SELL, Qty: 0.01, Price: 0.8922900000, Margin: 6.573032879902141393895627312, Commission: 0.00
2025-07-03 22:47:29,884 - INFO - orders - [PERF] Order processing: 0.4248s
2025-07-03 22:47:29,884 - DEBUG - orders - [DEBUG][create_user_order] Received order_data: {'order_id': '3278505407', 'order_status': 'OPEN', 'order_user_id': 4, 'order_company_name': 'AUDCAD', 'order_type': 'SELL', 'order_price': Decimal('0.8922900000'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('892.29'), 'margin': Decimal('6.573032879902141393895627312'), 'commission': Decimal('0.00'), 'status': None, 'stop_loss': None, 'take_profit': None, 'stoploss_id': None, 'takeprofit_id': None, 'close_id': None}
2025-07-03 22:47:29,885 - DEBUG - orders - [DEBUG][create_user_order] Created OrderActionHistory record for order_id: 3278505407
2025-07-03 22:47:29,912 - INFO - orders - [PERF] Order creation: 0.0278s
2025-07-03 22:47:29,912 - INFO - orders - [PERF] TOTAL place_order: 0.4570s
2025-07-03 22:47:29,929 - app.api.v1.endpoints.orders - INFO - User 4: Updated static orders cache after order change - 2 open orders, 0 pending orders
2025-07-03 22:47:29,929 - ERROR - orders - Error updating portfolio: calculate_user_portfolio() missing 1 required positional argument: 'redis_client'
2025-07-03 22:47:37,533 - INFO - orders - Order placement request received - User: 4, Symbol: AUDCAD, Type: SELL
2025-07-03 22:47:37,832 - INFO - orders - [MARGIN_CALC] Market data for AUDCAD: {'b': '0.8922900000', 'o': '0.8922700000'}
2025-07-03 22:47:37,832 - WARNING - orders - [MARGIN_CALC] Missing ask price for AUDCAD, using bid price with spread: bid=0.8922900000, ask=0.89237922900000
2025-07-03 22:47:37,832 - INFO - orders - [MARGIN_CALC] Using prices for AUDCAD: bid=0.8922900000, ask=0.89237922900000
2025-07-03 22:47:37,834 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 8.92 CAD to USD for margin_calculation (user_id: 4, position: None)
2025-07-03 22:47:37,834 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CADUSD
2025-07-03 22:47:37,836 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-03 22:47:37,836 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CADUSD, trying inverse
2025-07-03 22:47:37,836 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCAD
2025-07-03 22:47:37,837 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('1.3570600000'), 'o': Decimal('1.3570400000')}
2025-07-03 22:47:37,837 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 1.3570600000
2025-07-03 22:47:37,838 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 8.92 CAD / 1.3570600000 = 6.573032879902141393895627312 USD
2025-07-03 22:47:37,838 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: AUDCAD, Type: SELL, Qty: 0.01, Price: 0.8922900000, Margin: 6.573032879902141393895627312, Commission: 0.00
2025-07-03 22:47:37,856 - INFO - orders - [PERF] Order processing: 0.3224s
2025-07-03 22:47:37,856 - DEBUG - orders - [DEBUG][create_user_order] Received order_data: {'order_id': '7996277422', 'order_status': 'OPEN', 'order_user_id': 4, 'order_company_name': 'AUDCAD', 'order_type': 'SELL', 'order_price': Decimal('0.8922900000'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('892.29'), 'margin': Decimal('6.573032879902141393895627312'), 'commission': Decimal('0.00'), 'status': None, 'stop_loss': None, 'take_profit': None, 'stoploss_id': None, 'takeprofit_id': None, 'close_id': None}
2025-07-03 22:47:37,857 - DEBUG - orders - [DEBUG][create_user_order] Created OrderActionHistory record for order_id: 7996277422
2025-07-03 22:47:37,873 - INFO - orders - [PERF] Order creation: 0.0165s
2025-07-03 22:47:37,873 - INFO - orders - [PERF] TOTAL place_order: 0.3404s
2025-07-03 22:47:37,887 - app.api.v1.endpoints.orders - INFO - User 4: Updated static orders cache after order change - 3 open orders, 0 pending orders
2025-07-03 22:47:37,887 - ERROR - orders - Error updating portfolio: calculate_user_portfolio() missing 1 required positional argument: 'redis_client'
2025-07-03 22:48:31,808 - INFO - orders - Order close request received - Order ID: 7996277422, User ID: 4, Close Price: 0.89247
2025-07-03 22:48:31,809 - INFO - orders - user_to_operate_on: <app.database.models.User object at 0x00000167ED14C550>, type: <class 'app.database.models.User'>, user_type: live, attrs: ['__abstract__', '__class__', '__delattr__', '__dict__', '__dir__', '__doc__', '__eq__', '__firstlineno__', '__format__', '__ge__', '__getattribute__', '__getstate__', '__gt__', '__hash__', '__init__', '__init_subclass__', '__le__', '__lt__', '__mapper__', '__module__', '__ne__', '__new__', '__reduce__', '__reduce_ex__', '__repr__', '__setattr__', '__sizeof__', '__static_attributes__', '__str__', '__subclasshook__', '__table__', '__table_args__', '__tablename__', '__weakref__', '_sa_class_manager', '_sa_instance_state', '_sa_registry', 'account_number', 'address_proof', 'address_proof_image', 'bank_account_number', 'bank_branch_name', 'bank_holder_name', 'bank_ifsc_code', 'city', 'country', 'created_at', 'email', 'fund_manager', 'group_name', 'hashed_password', 'id', 'id_proof', 'id_proof_image', 'isActive', 'is_self_trading', 'is_service_account', 'leverage', 'margin', 'metadata', 'money_requests', 'name', 'net_profit', 'orders', 'otps', 'phone_number', 'pincode', 'referred_by_id', 'reffered_code', 'registry', 'rock_orders', 'security_answer', 'security_question', 'state', 'status', 'updated_at', 'user_favorites', 'user_type', 'wallet_balance', 'wallet_transactions']
2025-07-03 22:48:31,809 - INFO - orders - Using order model: user_orders for user 4 (user_type: live)
2025-07-03 22:48:31,809 - INFO - orders - Request to close order 7996277422 for user 4 (user_type: live) with price 0.89247. Frontend provided type: SELL, company: AUDCAD, status: CLOSED, frontend_status: CLOSED.
2025-07-03 22:48:31,816 - INFO - orders - User group: Standard, sending_orders setting: rock
2025-07-03 22:48:31,825 - INFO - orders - Live user 4 from group 'default' ('sending_orders' is NOT 'barclays'). Processing close locally.
2025-07-03 22:48:31,839 - INFO - orders - Existing entry commission for order 7996277422: 0.0
2025-07-03 22:48:31,839 - INFO - orders - Commission calculation for order 7996277422: entry=0.0, exit=0.100000000000, total=0.10
2025-07-03 22:48:31,839 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of -0.180000000000000000000000 CAD to USD for PnL on Close (user_id: 4, position: 7996277422)
2025-07-03 22:48:31,839 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CADUSD
2025-07-03 22:48:31,840 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-03 22:48:31,840 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CADUSD, trying inverse
2025-07-03 22:48:31,840 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCAD
2025-07-03 22:48:31,841 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('1.3570500000'), 'o': Decimal('1.3570300000')}
2025-07-03 22:48:31,841 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 1.3570500000
2025-07-03 22:48:31,842 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: -0.180000000000000000000000 CAD / 1.3570500000 = -0.1326406543605615121034597104 USD
2025-07-03 22:48:31,869 - INFO - orders - [DEBUG] DB commit completed for order 7996277422. Checking DB state...
2025-07-03 22:48:31,875 - INFO - orders - [DEBUG] After commit & refresh: order_id=7996277422, order_status=CLOSED, close_price=0.89247000, net_profit=-0.23000000, commission=0.10000000, close_id=9448385100, updated_at=2025-07-03 22:48:31
2025-07-03 22:48:31,875 - INFO - orders - AFTER COMMIT: User 4 wallet_balance=6608.15000000, margin=0E-8
2025-07-03 22:48:31,875 - INFO - orders - Setting user data cache for user 4 with wallet_balance=6608.15000000, margin=0E-8
2025-07-03 22:48:31,877 - INFO - orders - User data cache updated for user 4
2025-07-03 22:48:31,877 - INFO - orders - Starting update_user_static_orders for user 4, user_type live
2025-07-03 22:48:31,877 - INFO - orders - Using order model: UserOrder
2025-07-03 22:48:31,882 - INFO - orders - Fetched 2 open orders for user 4
2025-07-03 22:48:31,886 - INFO - orders - Fetched 0 pending orders for user 4
2025-07-03 22:48:31,887 - INFO - orders - Updated static orders cache for user 4 with 2 open orders and 0 pending orders
2025-07-03 22:48:31,887 - INFO - orders - Publishing order update for user 4
2025-07-03 22:48:31,890 - INFO - orders - Publishing user data update for user 4
2025-07-03 22:48:31,892 - INFO - orders - Publishing market data trigger
2025-07-03 22:48:32,448 - INFO - orders - Order close request received - Order ID: 3278505407, User ID: 4, Close Price: 0.89247
2025-07-03 22:48:32,449 - INFO - orders - user_to_operate_on: <app.database.models.User object at 0x00000167ED14C550>, type: <class 'app.database.models.User'>, user_type: live, attrs: ['__abstract__', '__class__', '__delattr__', '__dict__', '__dir__', '__doc__', '__eq__', '__firstlineno__', '__format__', '__ge__', '__getattribute__', '__getstate__', '__gt__', '__hash__', '__init__', '__init_subclass__', '__le__', '__lt__', '__mapper__', '__module__', '__ne__', '__new__', '__reduce__', '__reduce_ex__', '__repr__', '__setattr__', '__sizeof__', '__static_attributes__', '__str__', '__subclasshook__', '__table__', '__table_args__', '__tablename__', '__weakref__', '_sa_class_manager', '_sa_instance_state', '_sa_registry', 'account_number', 'address_proof', 'address_proof_image', 'bank_account_number', 'bank_branch_name', 'bank_holder_name', 'bank_ifsc_code', 'city', 'country', 'created_at', 'email', 'fund_manager', 'group_name', 'hashed_password', 'id', 'id_proof', 'id_proof_image', 'isActive', 'is_self_trading', 'is_service_account', 'leverage', 'margin', 'metadata', 'money_requests', 'name', 'net_profit', 'orders', 'otps', 'phone_number', 'pincode', 'referred_by_id', 'reffered_code', 'registry', 'rock_orders', 'security_answer', 'security_question', 'state', 'status', 'updated_at', 'user_favorites', 'user_type', 'wallet_balance', 'wallet_transactions']
2025-07-03 22:48:32,449 - INFO - orders - Using order model: user_orders for user 4 (user_type: live)
2025-07-03 22:48:32,449 - INFO - orders - Request to close order 3278505407 for user 4 (user_type: live) with price 0.89247. Frontend provided type: SELL, company: AUDCAD, status: CLOSED, frontend_status: CLOSED.
2025-07-03 22:48:32,456 - INFO - orders - User group: Standard, sending_orders setting: rock
2025-07-03 22:48:32,467 - INFO - orders - Live user 4 from group 'default' ('sending_orders' is NOT 'barclays'). Processing close locally.
2025-07-03 22:48:32,488 - INFO - orders - Existing entry commission for order 3278505407: 0.0
2025-07-03 22:48:32,488 - INFO - orders - Commission calculation for order 3278505407: entry=0.0, exit=0.100000000000, total=0.10
2025-07-03 22:48:32,488 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of -0.180000000000000000000000 CAD to USD for PnL on Close (user_id: 4, position: 3278505407)
2025-07-03 22:48:32,488 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CADUSD
2025-07-03 22:48:32,490 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-03 22:48:32,490 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CADUSD, trying inverse
2025-07-03 22:48:32,490 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCAD
2025-07-03 22:48:32,491 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('1.3570500000'), 'o': Decimal('1.3570300000')}
2025-07-03 22:48:32,491 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 1.3570500000
2025-07-03 22:48:32,491 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: -0.180000000000000000000000 CAD / 1.3570500000 = -0.1326406543605615121034597104 USD
2025-07-03 22:48:32,515 - INFO - orders - [DEBUG] DB commit completed for order 3278505407. Checking DB state...
2025-07-03 22:48:32,519 - INFO - orders - [DEBUG] After commit & refresh: order_id=3278505407, order_status=CLOSED, close_price=0.89247000, net_profit=-0.23000000, commission=0.10000000, close_id=4785648397, updated_at=2025-07-03 22:48:32
2025-07-03 22:48:32,520 - INFO - orders - AFTER COMMIT: User 4 wallet_balance=6607.92000000, margin=0E-8
2025-07-03 22:48:32,520 - INFO - orders - Setting user data cache for user 4 with wallet_balance=6607.92000000, margin=0E-8
2025-07-03 22:48:32,521 - INFO - orders - User data cache updated for user 4
2025-07-03 22:48:32,521 - INFO - orders - Starting update_user_static_orders for user 4, user_type live
2025-07-03 22:48:32,521 - INFO - orders - Using order model: UserOrder
2025-07-03 22:48:32,524 - INFO - orders - Fetched 1 open orders for user 4
2025-07-03 22:48:32,528 - INFO - orders - Fetched 0 pending orders for user 4
2025-07-03 22:48:32,529 - INFO - orders - Updated static orders cache for user 4 with 1 open orders and 0 pending orders
2025-07-03 22:48:32,529 - INFO - orders - Publishing order update for user 4
2025-07-03 22:48:32,531 - INFO - orders - Publishing user data update for user 4
2025-07-03 22:48:32,533 - INFO - orders - Publishing market data trigger
2025-07-03 22:48:33,074 - INFO - orders - Order close request received - Order ID: 4451713161, User ID: 4, Close Price: 0.89224
2025-07-03 22:48:33,074 - INFO - orders - user_to_operate_on: <app.database.models.User object at 0x00000167ED14DE50>, type: <class 'app.database.models.User'>, user_type: live, attrs: ['__abstract__', '__class__', '__delattr__', '__dict__', '__dir__', '__doc__', '__eq__', '__firstlineno__', '__format__', '__ge__', '__getattribute__', '__getstate__', '__gt__', '__hash__', '__init__', '__init_subclass__', '__le__', '__lt__', '__mapper__', '__module__', '__ne__', '__new__', '__reduce__', '__reduce_ex__', '__repr__', '__setattr__', '__sizeof__', '__static_attributes__', '__str__', '__subclasshook__', '__table__', '__table_args__', '__tablename__', '__weakref__', '_sa_class_manager', '_sa_instance_state', '_sa_registry', 'account_number', 'address_proof', 'address_proof_image', 'bank_account_number', 'bank_branch_name', 'bank_holder_name', 'bank_ifsc_code', 'city', 'country', 'created_at', 'email', 'fund_manager', 'group_name', 'hashed_password', 'id', 'id_proof', 'id_proof_image', 'isActive', 'is_self_trading', 'is_service_account', 'leverage', 'margin', 'metadata', 'money_requests', 'name', 'net_profit', 'orders', 'otps', 'phone_number', 'pincode', 'referred_by_id', 'reffered_code', 'registry', 'rock_orders', 'security_answer', 'security_question', 'state', 'status', 'updated_at', 'user_favorites', 'user_type', 'wallet_balance', 'wallet_transactions']
2025-07-03 22:48:33,074 - INFO - orders - Using order model: user_orders for user 4 (user_type: live)
2025-07-03 22:48:33,074 - INFO - orders - Request to close order 4451713161 for user 4 (user_type: live) with price 0.89224. Frontend provided type: BUY, company: AUDCAD, status: CLOSED, frontend_status: CLOSED.
2025-07-03 22:48:33,079 - INFO - orders - User group: Standard, sending_orders setting: rock
2025-07-03 22:48:33,089 - INFO - orders - Live user 4 from group 'default' ('sending_orders' is NOT 'barclays'). Processing close locally.
2025-07-03 22:48:33,110 - INFO - orders - Existing entry commission for order 4451713161: 0.0
2025-07-03 22:48:33,110 - INFO - orders - Commission calculation for order 4451713161: entry=0.0, exit=0.100000000000, total=0.10
2025-07-03 22:48:33,110 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of -0.149230000000000000000000 CAD to USD for PnL on Close (user_id: 4, position: 4451713161)
2025-07-03 22:48:33,110 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CADUSD
2025-07-03 22:48:33,112 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-03 22:48:33,112 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CADUSD, trying inverse
2025-07-03 22:48:33,113 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCAD
2025-07-03 22:48:33,114 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('1.3570500000'), 'o': Decimal('1.3570300000')}
2025-07-03 22:48:33,114 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 1.3570500000
2025-07-03 22:48:33,114 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: -0.149230000000000000000000 CAD / 1.3570500000 = -0.1099664713901477469511071810 USD
2025-07-03 22:48:33,139 - INFO - orders - [DEBUG] DB commit completed for order 4451713161. Checking DB state...
2025-07-03 22:48:33,143 - INFO - orders - [DEBUG] After commit & refresh: order_id=4451713161, order_status=CLOSED, close_price=0.89224000, net_profit=-0.21000000, commission=0.10000000, close_id=2021691936, updated_at=2025-07-03 22:48:33
2025-07-03 22:48:33,143 - INFO - orders - AFTER COMMIT: User 4 wallet_balance=6607.71000000, margin=0E-8
2025-07-03 22:48:33,143 - INFO - orders - Setting user data cache for user 4 with wallet_balance=6607.71000000, margin=0E-8
2025-07-03 22:48:33,145 - INFO - orders - User data cache updated for user 4
2025-07-03 22:48:33,145 - INFO - orders - Starting update_user_static_orders for user 4, user_type live
2025-07-03 22:48:33,145 - INFO - orders - Using order model: UserOrder
2025-07-03 22:48:33,148 - INFO - orders - Fetched 0 open orders for user 4
2025-07-03 22:48:33,151 - INFO - orders - Fetched 0 pending orders for user 4
2025-07-03 22:48:33,152 - INFO - orders - Updated static orders cache for user 4 with 0 open orders and 0 pending orders
2025-07-03 22:48:33,152 - INFO - orders - Publishing order update for user 4
2025-07-03 22:48:33,155 - INFO - orders - Publishing user data update for user 4
2025-07-03 22:48:33,156 - INFO - orders - Publishing market data trigger
2025-07-03 22:50:27,968 - app.api.v1.endpoints.orders - INFO - [get_closed_orders] user_type: live
2025-07-03 22:50:47,942 - INFO - orders - Order placement request received - User: 4, Symbol: AUDJPY, Type: BUY
2025-07-03 22:50:48,364 - INFO - orders - [MARGIN_CALC] Market data for AUDJPY: {'b': '94.8910000000', 'o': '94.8850000000'}
2025-07-03 22:50:48,364 - WARNING - orders - [MARGIN_CALC] Missing ask price for AUDJPY, using bid price with spread: bid=94.8910000000, ask=94.90048910000000
2025-07-03 22:50:48,365 - INFO - orders - [MARGIN_CALC] Using prices for AUDJPY: bid=94.8910000000, ask=94.90048910000000
2025-07-03 22:50:48,366 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 949.00 JPY to USD for margin_calculation (user_id: 4, position: None)
2025-07-03 22:50:48,366 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: JPYUSD
2025-07-03 22:50:48,367 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-03 22:50:48,367 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for JPYUSD, trying inverse
2025-07-03 22:50:48,367 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDJPY
2025-07-03 22:50:48,368 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('144.3250000000'), 'o': Decimal('144.3200000000')}
2025-07-03 22:50:48,368 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 144.3250000000
2025-07-03 22:50:48,369 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 949.00 JPY / 144.3250000000 = 6.575437380911138056469773082 USD
2025-07-03 22:50:48,369 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: AUDJPY, Type: BUY, Qty: 0.01, Price: 94.90048910000000, Margin: 6.575437380911138056469773082, Commission: 0.10
2025-07-03 22:50:48,391 - INFO - orders - [PERF] Order processing: 0.4483s
2025-07-03 22:50:48,391 - DEBUG - orders - [DEBUG][create_user_order] Received order_data: {'order_id': '7671392586', 'order_status': 'OPEN', 'order_user_id': 4, 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_price': Decimal('94.90048910000000'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('94900.49'), 'margin': Decimal('6.575437380911138056469773082'), 'commission': Decimal('0.10'), 'status': None, 'stop_loss': None, 'take_profit': None, 'stoploss_id': None, 'takeprofit_id': None, 'close_id': None}
2025-07-03 22:50:48,392 - DEBUG - orders - [DEBUG][create_user_order] Created OrderActionHistory record for order_id: 7671392586
2025-07-03 22:50:48,406 - INFO - orders - [PERF] Order creation: 0.0145s
2025-07-03 22:50:48,407 - INFO - orders - [PERF] TOTAL place_order: 0.4649s
2025-07-03 22:50:48,417 - app.api.v1.endpoints.orders - INFO - User 4: Updated static orders cache after order change - 1 open orders, 0 pending orders
2025-07-03 22:50:48,418 - ERROR - orders - Error updating portfolio: calculate_user_portfolio() missing 1 required positional argument: 'redis_client'
2025-07-03 22:50:53,103 - INFO - orders - Order placement request received - User: 4, Symbol: AUDJPY, Type: SELL
2025-07-03 22:50:53,403 - INFO - orders - [MARGIN_CALC] Market data for AUDJPY: {'b': '94.8850000000', 'o': '94.8780000000'}
2025-07-03 22:50:53,404 - WARNING - orders - [MARGIN_CALC] Missing ask price for AUDJPY, using bid price with spread: bid=94.8850000000, ask=94.89448850000000
2025-07-03 22:50:53,404 - INFO - orders - [MARGIN_CALC] Using prices for AUDJPY: bid=94.8850000000, ask=94.89448850000000
2025-07-03 22:50:53,405 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 948.85 JPY to USD for margin_calculation (user_id: 4, position: None)
2025-07-03 22:50:53,406 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: JPYUSD
2025-07-03 22:50:53,407 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-03 22:50:53,407 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for JPYUSD, trying inverse
2025-07-03 22:50:53,407 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDJPY
2025-07-03 22:50:53,408 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('144.3250000000'), 'o': Decimal('144.3200000000')}
2025-07-03 22:50:53,409 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 144.3250000000
2025-07-03 22:50:53,409 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 948.85 JPY / 144.3250000000 = 6.574398059934176338125757838 USD
2025-07-03 22:50:53,409 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: AUDJPY, Type: SELL, Qty: 0.01, Price: 94.8850000000, Margin: 6.574398059934176338125757838, Commission: 0.10
2025-07-03 22:50:53,424 - INFO - orders - [PERF] Order processing: 0.3193s
2025-07-03 22:50:53,425 - DEBUG - orders - [DEBUG][create_user_order] Received order_data: {'order_id': '4911534332', 'order_status': 'OPEN', 'order_user_id': 4, 'order_company_name': 'AUDJPY', 'order_type': 'SELL', 'order_price': Decimal('94.8850000000'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('94885.00'), 'margin': Decimal('6.574398059934176338125757838'), 'commission': Decimal('0.10'), 'status': None, 'stop_loss': None, 'take_profit': None, 'stoploss_id': None, 'takeprofit_id': None, 'close_id': None}
2025-07-03 22:50:53,425 - DEBUG - orders - [DEBUG][create_user_order] Created OrderActionHistory record for order_id: 4911534332
2025-07-03 22:50:53,437 - INFO - orders - [PERF] Order creation: 0.0129s
2025-07-03 22:50:53,438 - INFO - orders - [PERF] TOTAL place_order: 0.3346s
2025-07-03 22:50:53,449 - app.api.v1.endpoints.orders - INFO - User 4: Updated static orders cache after order change - 2 open orders, 0 pending orders
2025-07-03 22:50:53,449 - ERROR - orders - Error updating portfolio: calculate_user_portfolio() missing 1 required positional argument: 'redis_client'
2025-07-03 22:52:02,123 - INFO - orders - Application starting up - Orders logging initialized
2025-07-03 22:52:02,124 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-03 22:52:19,726 - INFO - orders - Application starting up - Orders logging initialized
2025-07-03 22:52:19,726 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-03 22:52:28,077 - INFO - orders - Application starting up - Orders logging initialized
2025-07-03 22:52:28,079 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-03 22:53:01,109 - INFO - orders - Application starting up - Orders logging initialized
2025-07-03 22:53:01,109 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-03 22:53:46,984 - INFO - orders - Order close request received - Order ID: 7671392586, User ID: 4, Close Price: 94.836
2025-07-03 22:53:46,984 - INFO - orders - user_to_operate_on: <app.database.models.User object at 0x000001B742E9E710>, type: <class 'app.database.models.User'>, user_type: live, attrs: ['__abstract__', '__class__', '__delattr__', '__dict__', '__dir__', '__doc__', '__eq__', '__firstlineno__', '__format__', '__ge__', '__getattribute__', '__getstate__', '__gt__', '__hash__', '__init__', '__init_subclass__', '__le__', '__lt__', '__mapper__', '__module__', '__ne__', '__new__', '__reduce__', '__reduce_ex__', '__repr__', '__setattr__', '__sizeof__', '__static_attributes__', '__str__', '__subclasshook__', '__table__', '__table_args__', '__tablename__', '__weakref__', '_sa_class_manager', '_sa_instance_state', '_sa_registry', 'account_number', 'address_proof', 'address_proof_image', 'bank_account_number', 'bank_branch_name', 'bank_holder_name', 'bank_ifsc_code', 'city', 'country', 'created_at', 'email', 'fund_manager', 'group_name', 'hashed_password', 'id', 'id_proof', 'id_proof_image', 'isActive', 'is_self_trading', 'is_service_account', 'leverage', 'margin', 'metadata', 'money_requests', 'name', 'net_profit', 'orders', 'otps', 'phone_number', 'pincode', 'referred_by_id', 'reffered_code', 'registry', 'rock_orders', 'security_answer', 'security_question', 'state', 'status', 'updated_at', 'user_favorites', 'user_type', 'wallet_balance', 'wallet_transactions']
2025-07-03 22:53:46,984 - INFO - orders - Using order model: user_orders for user 4 (user_type: live)
2025-07-03 22:53:46,984 - INFO - orders - Request to close order 7671392586 for user 4 (user_type: live) with price 94.836. Frontend provided type: BUY, company: AUDJPY, status: CLOSED, frontend_status: CLOSED.
2025-07-03 22:53:46,987 - INFO - orders - User group: Standard, sending_orders setting: rock
2025-07-03 22:53:46,991 - INFO - orders - Live user 4 from group 'default' ('sending_orders' is NOT 'barclays'). Processing close locally.
2025-07-03 22:53:47,002 - INFO - orders - Existing entry commission for order 7671392586: 0.10000000
2025-07-03 22:53:47,002 - INFO - orders - Commission calculation for order 7671392586: entry=0.10000000, exit=0.100000000000, total=0.20
2025-07-03 22:53:47,002 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of -64.489100000000000000000000 JPY to USD for PnL on Close (user_id: 4, position: 7671392586)
2025-07-03 22:53:47,002 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: JPYUSD
2025-07-03 22:53:47,003 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-03 22:53:47,003 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for JPYUSD, trying inverse
2025-07-03 22:53:47,003 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDJPY
2025-07-03 22:53:47,003 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('144.3110000000'), 'o': Decimal('144.3090000000')}
2025-07-03 22:53:47,003 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 144.3110000000
2025-07-03 22:53:47,003 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: -64.489100000000000000000000 JPY / 144.3110000000 = -0.4468758445302159918509330543 USD
2025-07-03 22:53:47,019 - INFO - orders - [DEBUG] DB commit completed for order 7671392586. Checking DB state...
2025-07-03 22:53:47,023 - INFO - orders - [DEBUG] After commit & refresh: order_id=7671392586, order_status=CLOSED, close_price=94.83600000, net_profit=-0.65000000, commission=0.20000000, close_id=2923107157, updated_at=2025-07-03 22:53:47
2025-07-03 22:53:47,023 - INFO - orders - AFTER COMMIT: User 4 wallet_balance=6607.06000000, margin=6.57000000
2025-07-03 22:53:47,023 - INFO - orders - Setting user data cache for user 4 with wallet_balance=6607.06000000, margin=6.57000000
2025-07-03 22:53:47,024 - INFO - orders - User data cache updated for user 4
2025-07-03 22:53:47,024 - INFO - orders - Starting update_user_static_orders for user 4, user_type live
2025-07-03 22:53:47,024 - INFO - orders - Using order model: UserOrder
2025-07-03 22:53:47,026 - INFO - orders - Fetched 1 open orders for user 4
2025-07-03 22:53:47,027 - INFO - orders - Fetched 0 pending orders for user 4
2025-07-03 22:53:47,028 - INFO - orders - Updated static orders cache for user 4 with 1 open orders and 0 pending orders
2025-07-03 22:53:47,028 - INFO - orders - Publishing order update for user 4
2025-07-03 22:53:47,028 - INFO - orders - Publishing user data update for user 4
2025-07-03 22:53:47,029 - INFO - orders - Publishing market data trigger
2025-07-03 22:53:49,302 - INFO - orders - Order close request received - Order ID: 4911534332, User ID: 4, Close Price: 94.875
2025-07-03 22:53:49,302 - INFO - orders - user_to_operate_on: <app.database.models.User object at 0x000001B742E9D6D0>, type: <class 'app.database.models.User'>, user_type: live, attrs: ['__abstract__', '__class__', '__delattr__', '__dict__', '__dir__', '__doc__', '__eq__', '__firstlineno__', '__format__', '__ge__', '__getattribute__', '__getstate__', '__gt__', '__hash__', '__init__', '__init_subclass__', '__le__', '__lt__', '__mapper__', '__module__', '__ne__', '__new__', '__reduce__', '__reduce_ex__', '__repr__', '__setattr__', '__sizeof__', '__static_attributes__', '__str__', '__subclasshook__', '__table__', '__table_args__', '__tablename__', '__weakref__', '_sa_class_manager', '_sa_instance_state', '_sa_registry', 'account_number', 'address_proof', 'address_proof_image', 'bank_account_number', 'bank_branch_name', 'bank_holder_name', 'bank_ifsc_code', 'city', 'country', 'created_at', 'email', 'fund_manager', 'group_name', 'hashed_password', 'id', 'id_proof', 'id_proof_image', 'isActive', 'is_self_trading', 'is_service_account', 'leverage', 'margin', 'metadata', 'money_requests', 'name', 'net_profit', 'orders', 'otps', 'phone_number', 'pincode', 'referred_by_id', 'reffered_code', 'registry', 'rock_orders', 'security_answer', 'security_question', 'state', 'status', 'updated_at', 'user_favorites', 'user_type', 'wallet_balance', 'wallet_transactions']
2025-07-03 22:53:49,302 - INFO - orders - Using order model: user_orders for user 4 (user_type: live)
2025-07-03 22:53:49,303 - INFO - orders - Request to close order 4911534332 for user 4 (user_type: live) with price 94.875. Frontend provided type: SELL, company: AUDJPY, status: CLOSED, frontend_status: CLOSED.
2025-07-03 22:53:49,307 - INFO - orders - User group: Standard, sending_orders setting: rock
2025-07-03 22:53:49,320 - INFO - orders - Live user 4 from group 'default' ('sending_orders' is NOT 'barclays'). Processing close locally.
2025-07-03 22:53:49,344 - INFO - orders - Existing entry commission for order 4911534332: 0.10000000
2025-07-03 22:53:49,344 - INFO - orders - Commission calculation for order 4911534332: entry=0.10000000, exit=0.100000000000, total=0.20
2025-07-03 22:53:49,345 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 10.000000000000000000000000 JPY to USD for PnL on Close (user_id: 4, position: 4911534332)
2025-07-03 22:53:49,345 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: JPYUSD
2025-07-03 22:53:49,346 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-03 22:53:49,346 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for JPYUSD, trying inverse
2025-07-03 22:53:49,346 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDJPY
2025-07-03 22:53:49,347 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('144.3110000000'), 'o': Decimal('144.3080000000')}
2025-07-03 22:53:49,348 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 144.3110000000
2025-07-03 22:53:49,348 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 10.000000000000000000000000 JPY / 144.3110000000 = 0.06929478695317751245573795483 USD
2025-07-03 22:53:49,374 - INFO - orders - [DEBUG] DB commit completed for order 4911534332. Checking DB state...
2025-07-03 22:53:49,380 - INFO - orders - [DEBUG] After commit & refresh: order_id=4911534332, order_status=CLOSED, close_price=94.87500000, net_profit=-0.13000000, commission=0.20000000, close_id=5400214328, updated_at=2025-07-03 22:53:49
2025-07-03 22:53:49,381 - INFO - orders - AFTER COMMIT: User 4 wallet_balance=6606.93000000, margin=0E-8
2025-07-03 22:53:49,381 - INFO - orders - Setting user data cache for user 4 with wallet_balance=6606.93000000, margin=0E-8
2025-07-03 22:53:49,382 - INFO - orders - User data cache updated for user 4
2025-07-03 22:53:49,383 - INFO - orders - Starting update_user_static_orders for user 4, user_type live
2025-07-03 22:53:49,383 - INFO - orders - Using order model: UserOrder
2025-07-03 22:53:49,388 - INFO - orders - Fetched 0 open orders for user 4
2025-07-03 22:53:49,392 - INFO - orders - Fetched 0 pending orders for user 4
2025-07-03 22:53:49,394 - INFO - orders - Updated static orders cache for user 4 with 0 open orders and 0 pending orders
2025-07-03 22:53:49,394 - INFO - orders - Publishing order update for user 4
2025-07-03 22:53:49,397 - INFO - orders - Publishing user data update for user 4
2025-07-03 22:53:49,400 - INFO - orders - Publishing market data trigger
2025-07-03 22:53:51,640 - INFO - orders - Order placement request received - User: 4, Symbol: AUDJPY, Type: BUY
2025-07-03 22:53:52,027 - INFO - orders - [MARGIN_CALC] Market data for AUDJPY: {'b': '94.8680000000', 'o': '94.8590000000'}
2025-07-03 22:53:52,027 - WARNING - orders - [MARGIN_CALC] Missing ask price for AUDJPY, using bid price with spread: bid=94.8680000000, ask=94.87748680000000
2025-07-03 22:53:52,028 - INFO - orders - [MARGIN_CALC] Using prices for AUDJPY: bid=94.8680000000, ask=94.87748680000000
2025-07-03 22:53:52,042 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 948.77 JPY to USD for margin_calculation (user_id: 4, position: None)
2025-07-03 22:53:52,042 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: JPYUSD
2025-07-03 22:53:52,055 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-03 22:53:52,056 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for JPYUSD, trying inverse
2025-07-03 22:53:52,056 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDJPY
2025-07-03 22:53:52,065 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('144.3210000000'), 'o': Decimal('144.3160000000')}
2025-07-03 22:53:52,066 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 144.3210000000
2025-07-03 22:53:52,066 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 948.77 JPY / 144.3210000000 = 6.574025956028575190027785284 USD
2025-07-03 22:53:52,066 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: AUDJPY, Type: BUY, Qty: 0.01, Price: 94.87748680000000, Margin: 6.574025956028575190027785284, Commission: 0.10
2025-07-03 22:53:52,212 - INFO - orders - [PERF] Order processing: 0.5699s
2025-07-03 22:53:52,212 - DEBUG - orders - [DEBUG][create_user_order] Received order_data: {'order_id': '5466803491', 'order_status': 'OPEN', 'order_user_id': 4, 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_price': Decimal('94.87748680000000'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('94877.49'), 'margin': Decimal('6.574025956028575190027785284'), 'commission': Decimal('0.10'), 'status': None, 'stop_loss': None, 'take_profit': None, 'stoploss_id': None, 'takeprofit_id': None, 'close_id': None}
2025-07-03 22:53:52,213 - DEBUG - orders - [DEBUG][create_user_order] Created OrderActionHistory record for order_id: 5466803491
2025-07-03 22:53:52,272 - INFO - orders - [PERF] Order creation: 0.0595s
2025-07-03 22:53:52,272 - INFO - orders - Publishing order update for user 4
2025-07-03 22:53:52,278 - INFO - orders - Publishing user data update for user 4
2025-07-03 22:53:52,285 - INFO - orders - Publishing market data trigger
2025-07-03 22:53:52,293 - INFO - orders - [PERF] TOTAL place_order: 0.6537s
2025-07-03 22:53:52,344 - app.api.v1.endpoints.orders - INFO - User 4: Updated static orders cache after order change - 1 open orders, 0 pending orders
2025-07-03 22:53:52,344 - ERROR - orders - Error updating portfolio: calculate_user_portfolio() missing 1 required positional argument: 'redis_client'
2025-07-03 22:53:58,410 - INFO - orders - Order placement request received - User: 4, Symbol: AUDJPY, Type: SELL
2025-07-03 22:53:58,791 - INFO - orders - [MARGIN_CALC] Market data for AUDJPY: {'b': '94.8630000000', 'o': '94.8560000000'}
2025-07-03 22:53:58,792 - WARNING - orders - [MARGIN_CALC] Missing ask price for AUDJPY, using bid price with spread: bid=94.8630000000, ask=94.87248630000000
2025-07-03 22:53:58,792 - INFO - orders - [MARGIN_CALC] Using prices for AUDJPY: bid=94.8630000000, ask=94.87248630000000
2025-07-03 22:53:58,794 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 948.63 JPY to USD for margin_calculation (user_id: 4, position: None)
2025-07-03 22:53:58,795 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: JPYUSD
2025-07-03 22:53:58,797 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-03 22:53:58,797 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for JPYUSD, trying inverse
2025-07-03 22:53:58,797 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDJPY
2025-07-03 22:53:58,799 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('144.3200000000'), 'o': Decimal('144.3160000000')}
2025-07-03 22:53:58,800 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 144.3200000000
2025-07-03 22:53:58,800 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 948.63 JPY / 144.3200000000 = 6.573101441241685144124168514 USD
2025-07-03 22:53:58,800 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: AUDJPY, Type: SELL, Qty: 0.01, Price: 94.8630000000, Margin: 6.573101441241685144124168514, Commission: 0.10
2025-07-03 22:53:58,819 - INFO - orders - [PERF] Order processing: 0.4089s
2025-07-03 22:53:58,820 - DEBUG - orders - [DEBUG][create_user_order] Received order_data: {'order_id': '8040156763', 'order_status': 'OPEN', 'order_user_id': 4, 'order_company_name': 'AUDJPY', 'order_type': 'SELL', 'order_price': Decimal('94.8630000000'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('94863.00'), 'margin': Decimal('6.573101441241685144124168514'), 'commission': Decimal('0.10'), 'status': None, 'stop_loss': None, 'take_profit': None, 'stoploss_id': None, 'takeprofit_id': None, 'close_id': None}
2025-07-03 22:53:58,820 - DEBUG - orders - [DEBUG][create_user_order] Created OrderActionHistory record for order_id: 8040156763
2025-07-03 22:53:58,842 - INFO - orders - [PERF] Order creation: 0.0223s
2025-07-03 22:53:58,842 - INFO - orders - Publishing order update for user 4
2025-07-03 22:53:58,844 - INFO - orders - Publishing user data update for user 4
2025-07-03 22:53:58,845 - INFO - orders - Publishing market data trigger
2025-07-03 22:53:58,848 - INFO - orders - [PERF] TOTAL place_order: 0.4385s
2025-07-03 22:53:58,921 - app.api.v1.endpoints.orders - INFO - User 4: Updated static orders cache after order change - 2 open orders, 0 pending orders
2025-07-03 22:53:58,922 - ERROR - orders - Error updating portfolio: calculate_user_portfolio() missing 1 required positional argument: 'redis_client'
2025-07-03 22:54:01,064 - INFO - orders - Order placement request received - User: 4, Symbol: AUDJPY, Type: BUY
2025-07-03 22:54:01,526 - INFO - orders - [MARGIN_CALC] Market data for AUDJPY: {'b': '94.8640000000', 'o': '94.8560000000'}
2025-07-03 22:54:01,527 - WARNING - orders - [MARGIN_CALC] Missing ask price for AUDJPY, using bid price with spread: bid=94.8640000000, ask=94.87348640000000
2025-07-03 22:54:01,527 - INFO - orders - [MARGIN_CALC] Using prices for AUDJPY: bid=94.8640000000, ask=94.87348640000000
2025-07-03 22:54:01,532 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 948.73 JPY to USD for margin_calculation (user_id: 4, position: None)
2025-07-03 22:54:01,532 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: JPYUSD
2025-07-03 22:54:01,538 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-03 22:54:01,538 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for JPYUSD, trying inverse
2025-07-03 22:54:01,538 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDJPY
2025-07-03 22:54:01,546 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('144.3160000000'), 'o': Decimal('144.3120000000')}
2025-07-03 22:54:01,546 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 144.3160000000
2025-07-03 22:54:01,546 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 948.73 JPY / 144.3160000000 = 6.573976551456525956927852768 USD
2025-07-03 22:54:01,546 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: AUDJPY, Type: BUY, Qty: 0.01, Price: 94.87348640000000, Margin: 6.573976551456525956927852768, Commission: 0.10
2025-07-03 22:54:01,642 - INFO - orders - [PERF] Order processing: 0.5744s
2025-07-03 22:54:01,642 - DEBUG - orders - [DEBUG][create_user_order] Received order_data: {'order_id': '1255619511', 'order_status': 'OPEN', 'order_user_id': 4, 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_price': Decimal('94.87348640000000'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('94873.49'), 'margin': Decimal('6.573976551456525956927852768'), 'commission': Decimal('0.10'), 'status': None, 'stop_loss': None, 'take_profit': None, 'stoploss_id': None, 'takeprofit_id': None, 'close_id': None}
2025-07-03 22:54:01,643 - DEBUG - orders - [DEBUG][create_user_order] Created OrderActionHistory record for order_id: 1255619511
2025-07-03 22:54:01,683 - INFO - orders - [PERF] Order creation: 0.0406s
2025-07-03 22:54:01,683 - INFO - orders - Publishing order update for user 4
2025-07-03 22:54:01,687 - INFO - orders - Publishing user data update for user 4
2025-07-03 22:54:01,692 - INFO - orders - Publishing market data trigger
2025-07-03 22:54:01,699 - INFO - orders - [PERF] TOTAL place_order: 0.6352s
2025-07-03 22:54:01,767 - app.api.v1.endpoints.orders - INFO - User 4: Updated static orders cache after order change - 3 open orders, 0 pending orders
2025-07-03 22:54:01,767 - ERROR - orders - Error updating portfolio: calculate_user_portfolio() missing 1 required positional argument: 'redis_client'
2025-07-03 22:54:05,073 - INFO - orders - Order placement request received - User: 4, Symbol: AUDJPY, Type: SELL
2025-07-03 22:54:05,409 - INFO - orders - [MARGIN_CALC] Market data for AUDJPY: {'b': '94.8630000000', 'o': '94.8560000000'}
2025-07-03 22:54:05,410 - WARNING - orders - [MARGIN_CALC] Missing ask price for AUDJPY, using bid price with spread: bid=94.8630000000, ask=94.87248630000000
2025-07-03 22:54:05,410 - INFO - orders - [MARGIN_CALC] Using prices for AUDJPY: bid=94.8630000000, ask=94.87248630000000
2025-07-03 22:54:05,411 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 948.63 JPY to USD for margin_calculation (user_id: 4, position: None)
2025-07-03 22:54:05,411 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: JPYUSD
2025-07-03 22:54:05,413 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-03 22:54:05,413 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for JPYUSD, trying inverse
2025-07-03 22:54:05,413 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDJPY
2025-07-03 22:54:05,415 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('144.3160000000'), 'o': Decimal('144.3120000000')}
2025-07-03 22:54:05,415 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 144.3160000000
2025-07-03 22:54:05,415 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 948.63 JPY / 144.3160000000 = 6.573283627594999861415227695 USD
2025-07-03 22:54:05,415 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: AUDJPY, Type: SELL, Qty: 0.01, Price: 94.8630000000, Margin: 6.573283627594999861415227695, Commission: 0.10
2025-07-03 22:54:05,433 - INFO - orders - [PERF] Order processing: 0.3583s
2025-07-03 22:54:05,434 - DEBUG - orders - [DEBUG][create_user_order] Received order_data: {'order_id': '9536495452', 'order_status': 'OPEN', 'order_user_id': 4, 'order_company_name': 'AUDJPY', 'order_type': 'SELL', 'order_price': Decimal('94.8630000000'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('94863.00'), 'margin': Decimal('6.573283627594999861415227695'), 'commission': Decimal('0.10'), 'status': None, 'stop_loss': None, 'take_profit': None, 'stoploss_id': None, 'takeprofit_id': None, 'close_id': None}
2025-07-03 22:54:05,434 - DEBUG - orders - [DEBUG][create_user_order] Created OrderActionHistory record for order_id: 9536495452
2025-07-03 22:54:05,457 - INFO - orders - [PERF] Order creation: 0.0232s
2025-07-03 22:54:05,457 - INFO - orders - Publishing order update for user 4
2025-07-03 22:54:05,461 - INFO - orders - Publishing user data update for user 4
2025-07-03 22:54:05,464 - INFO - orders - Publishing market data trigger
2025-07-03 22:54:05,469 - INFO - orders - [PERF] TOTAL place_order: 0.3967s
2025-07-03 22:54:05,505 - app.api.v1.endpoints.orders - INFO - User 4: Updated static orders cache after order change - 4 open orders, 0 pending orders
2025-07-03 22:54:05,505 - ERROR - orders - Error updating portfolio: calculate_user_portfolio() missing 1 required positional argument: 'redis_client'
2025-07-03 22:54:07,173 - INFO - orders - Order placement request received - User: 4, Symbol: AUDJPY, Type: SELL
2025-07-03 22:54:07,562 - INFO - orders - [MARGIN_CALC] Market data for AUDJPY: {'b': '94.8630000000', 'o': '94.8560000000'}
2025-07-03 22:54:07,563 - WARNING - orders - [MARGIN_CALC] Missing ask price for AUDJPY, using bid price with spread: bid=94.8630000000, ask=94.87248630000000
2025-07-03 22:54:07,563 - INFO - orders - [MARGIN_CALC] Using prices for AUDJPY: bid=94.8630000000, ask=94.87248630000000
2025-07-03 22:54:07,566 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 948.63 JPY to USD for margin_calculation (user_id: 4, position: None)
2025-07-03 22:54:07,566 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: JPYUSD
2025-07-03 22:54:07,567 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-03 22:54:07,568 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for JPYUSD, trying inverse
2025-07-03 22:54:07,568 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDJPY
2025-07-03 22:54:07,570 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('144.3160000000'), 'o': Decimal('144.3100000000')}
2025-07-03 22:54:07,570 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 144.3160000000
2025-07-03 22:54:07,570 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 948.63 JPY / 144.3160000000 = 6.573283627594999861415227695 USD
2025-07-03 22:54:07,571 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: AUDJPY, Type: SELL, Qty: 0.01, Price: 94.8630000000, Margin: 6.573283627594999861415227695, Commission: 0.10
2025-07-03 22:54:07,600 - INFO - orders - [PERF] Order processing: 0.4252s
2025-07-03 22:54:07,601 - DEBUG - orders - [DEBUG][create_user_order] Received order_data: {'order_id': '7392384883', 'order_status': 'OPEN', 'order_user_id': 4, 'order_company_name': 'AUDJPY', 'order_type': 'SELL', 'order_price': Decimal('94.8630000000'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('94863.00'), 'margin': Decimal('6.573283627594999861415227695'), 'commission': Decimal('0.10'), 'status': None, 'stop_loss': None, 'take_profit': None, 'stoploss_id': None, 'takeprofit_id': None, 'close_id': None}
2025-07-03 22:54:07,601 - DEBUG - orders - [DEBUG][create_user_order] Created OrderActionHistory record for order_id: 7392384883
2025-07-03 22:54:07,620 - INFO - orders - [PERF] Order creation: 0.0197s
2025-07-03 22:54:07,621 - INFO - orders - Publishing order update for user 4
2025-07-03 22:54:07,622 - INFO - orders - Publishing user data update for user 4
2025-07-03 22:54:07,624 - INFO - orders - Publishing market data trigger
2025-07-03 22:54:07,626 - INFO - orders - [PERF] TOTAL place_order: 0.4531s
2025-07-03 22:54:07,662 - app.api.v1.endpoints.orders - INFO - User 4: Updated static orders cache after order change - 5 open orders, 0 pending orders
2025-07-03 22:54:07,662 - ERROR - orders - Error updating portfolio: calculate_user_portfolio() missing 1 required positional argument: 'redis_client'
2025-07-03 22:54:08,903 - INFO - orders - Order placement request received - User: 4, Symbol: AUDJPY, Type: SELL
2025-07-03 22:54:09,301 - INFO - orders - [MARGIN_CALC] Market data for AUDJPY: {'b': '94.8600000000', 'o': '94.8540000000'}
2025-07-03 22:54:09,301 - WARNING - orders - [MARGIN_CALC] Missing ask price for AUDJPY, using bid price with spread: bid=94.8600000000, ask=94.86948600000000
2025-07-03 22:54:09,301 - INFO - orders - [MARGIN_CALC] Using prices for AUDJPY: bid=94.8600000000, ask=94.86948600000000
2025-07-03 22:54:09,303 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 948.60 JPY to USD for margin_calculation (user_id: 4, position: None)
2025-07-03 22:54:09,303 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: JPYUSD
2025-07-03 22:54:09,304 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-03 22:54:09,304 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for JPYUSD, trying inverse
2025-07-03 22:54:09,305 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDJPY
2025-07-03 22:54:09,307 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('144.3160000000'), 'o': Decimal('144.3100000000')}
2025-07-03 22:54:09,307 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 144.3160000000
2025-07-03 22:54:09,307 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 948.60 JPY / 144.3160000000 = 6.573075750436542032761440173 USD
2025-07-03 22:54:09,308 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: AUDJPY, Type: SELL, Qty: 0.01, Price: 94.8600000000, Margin: 6.573075750436542032761440173, Commission: 0.10
2025-07-03 22:54:09,330 - INFO - orders - [PERF] Order processing: 0.4236s
2025-07-03 22:54:09,331 - DEBUG - orders - [DEBUG][create_user_order] Received order_data: {'order_id': '5787413738', 'order_status': 'OPEN', 'order_user_id': 4, 'order_company_name': 'AUDJPY', 'order_type': 'SELL', 'order_price': Decimal('94.8600000000'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('94860.00'), 'margin': Decimal('6.573075750436542032761440173'), 'commission': Decimal('0.10'), 'status': None, 'stop_loss': None, 'take_profit': None, 'stoploss_id': None, 'takeprofit_id': None, 'close_id': None}
2025-07-03 22:54:09,331 - DEBUG - orders - [DEBUG][create_user_order] Created OrderActionHistory record for order_id: 5787413738
2025-07-03 22:54:09,347 - INFO - orders - [PERF] Order creation: 0.0167s
2025-07-03 22:54:09,347 - INFO - orders - Publishing order update for user 4
2025-07-03 22:54:09,350 - INFO - orders - Publishing user data update for user 4
2025-07-03 22:54:09,353 - INFO - orders - Publishing market data trigger
2025-07-03 22:54:09,355 - INFO - orders - [PERF] TOTAL place_order: 0.4524s
2025-07-03 22:54:09,388 - app.api.v1.endpoints.orders - INFO - User 4: Updated static orders cache after order change - 6 open orders, 0 pending orders
2025-07-03 22:54:09,388 - ERROR - orders - Error updating portfolio: calculate_user_portfolio() missing 1 required positional argument: 'redis_client'
2025-07-03 22:54:10,736 - INFO - orders - Order placement request received - User: 4, Symbol: AUDJPY, Type: SELL
2025-07-03 22:54:11,062 - INFO - orders - [MARGIN_CALC] Market data for AUDJPY: {'b': '94.8610000000', 'o': '94.8540000000'}
2025-07-03 22:54:11,062 - WARNING - orders - [MARGIN_CALC] Missing ask price for AUDJPY, using bid price with spread: bid=94.8610000000, ask=94.87048610000000
2025-07-03 22:54:11,063 - INFO - orders - [MARGIN_CALC] Using prices for AUDJPY: bid=94.8610000000, ask=94.87048610000000
2025-07-03 22:54:11,067 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 948.61 JPY to USD for margin_calculation (user_id: 4, position: None)
2025-07-03 22:54:11,067 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: JPYUSD
2025-07-03 22:54:11,072 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-03 22:54:11,073 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for JPYUSD, trying inverse
2025-07-03 22:54:11,073 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDJPY
2025-07-03 22:54:11,075 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('144.3210000000'), 'o': Decimal('144.3160000000')}
2025-07-03 22:54:11,075 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 144.3210000000
2025-07-03 22:54:11,075 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 948.61 JPY / 144.3210000000 = 6.572917316260280901601291565 USD
2025-07-03 22:54:11,075 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: AUDJPY, Type: SELL, Qty: 0.01, Price: 94.8610000000, Margin: 6.572917316260280901601291565, Commission: 0.10
2025-07-03 22:54:11,100 - INFO - orders - [PERF] Order processing: 0.3615s
2025-07-03 22:54:11,100 - DEBUG - orders - [DEBUG][create_user_order] Received order_data: {'order_id': '7626051743', 'order_status': 'OPEN', 'order_user_id': 4, 'order_company_name': 'AUDJPY', 'order_type': 'SELL', 'order_price': Decimal('94.8610000000'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('94861.00'), 'margin': Decimal('6.572917316260280901601291565'), 'commission': Decimal('0.10'), 'status': None, 'stop_loss': None, 'take_profit': None, 'stoploss_id': None, 'takeprofit_id': None, 'close_id': None}
2025-07-03 22:54:11,101 - DEBUG - orders - [DEBUG][create_user_order] Created OrderActionHistory record for order_id: 7626051743
2025-07-03 22:54:11,120 - INFO - orders - [PERF] Order creation: 0.0195s
2025-07-03 22:54:11,120 - INFO - orders - Publishing order update for user 4
2025-07-03 22:54:11,123 - INFO - orders - Publishing user data update for user 4
2025-07-03 22:54:11,127 - INFO - orders - Publishing market data trigger
2025-07-03 22:54:11,128 - INFO - orders - [PERF] TOTAL place_order: 0.3923s
2025-07-03 22:54:11,175 - app.api.v1.endpoints.orders - INFO - User 4: Updated static orders cache after order change - 7 open orders, 0 pending orders
2025-07-03 22:54:11,176 - ERROR - orders - Error updating portfolio: calculate_user_portfolio() missing 1 required positional argument: 'redis_client'
2025-07-03 22:54:12,759 - INFO - orders - Order placement request received - User: 4, Symbol: AUDJPY, Type: SELL
2025-07-03 22:54:13,107 - INFO - orders - [MARGIN_CALC] Market data for AUDJPY: {'b': '94.8600000000', 'o': '94.8540000000'}
2025-07-03 22:54:13,107 - WARNING - orders - [MARGIN_CALC] Missing ask price for AUDJPY, using bid price with spread: bid=94.8600000000, ask=94.86948600000000
2025-07-03 22:54:13,107 - INFO - orders - [MARGIN_CALC] Using prices for AUDJPY: bid=94.8600000000, ask=94.86948600000000
2025-07-03 22:54:13,110 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 948.60 JPY to USD for margin_calculation (user_id: 4, position: None)
2025-07-03 22:54:13,110 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: JPYUSD
2025-07-03 22:54:13,116 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-03 22:54:13,116 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for JPYUSD, trying inverse
2025-07-03 22:54:13,116 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDJPY
2025-07-03 22:54:13,120 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('144.3160000000'), 'o': Decimal('144.3100000000')}
2025-07-03 22:54:13,120 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 144.3160000000
2025-07-03 22:54:13,120 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 948.60 JPY / 144.3160000000 = 6.573075750436542032761440173 USD
2025-07-03 22:54:13,120 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: AUDJPY, Type: SELL, Qty: 0.01, Price: 94.8600000000, Margin: 6.573075750436542032761440173, Commission: 0.10
2025-07-03 22:54:13,518 - INFO - orders - [PERF] Order processing: 0.7524s
2025-07-03 22:54:13,518 - DEBUG - orders - [DEBUG][create_user_order] Received order_data: {'order_id': '5502568362', 'order_status': 'OPEN', 'order_user_id': 4, 'order_company_name': 'AUDJPY', 'order_type': 'SELL', 'order_price': Decimal('94.8600000000'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('94860.00'), 'margin': Decimal('6.573075750436542032761440173'), 'commission': Decimal('0.10'), 'status': None, 'stop_loss': None, 'take_profit': None, 'stoploss_id': None, 'takeprofit_id': None, 'close_id': None}
2025-07-03 22:54:13,519 - DEBUG - orders - [DEBUG][create_user_order] Created OrderActionHistory record for order_id: 5502568362
2025-07-03 22:54:13,556 - INFO - orders - [PERF] Order creation: 0.0378s
2025-07-03 22:54:13,556 - INFO - orders - Publishing order update for user 4
2025-07-03 22:54:13,560 - INFO - orders - Publishing user data update for user 4
2025-07-03 22:54:13,564 - INFO - orders - Publishing market data trigger
2025-07-03 22:54:13,570 - INFO - orders - [PERF] TOTAL place_order: 0.8117s
2025-07-03 22:54:13,593 - app.api.v1.endpoints.orders - INFO - User 4: Updated static orders cache after order change - 8 open orders, 0 pending orders
2025-07-03 22:54:13,594 - ERROR - orders - Error updating portfolio: calculate_user_portfolio() missing 1 required positional argument: 'redis_client'
2025-07-03 22:54:15,442 - INFO - orders - Order placement request received - User: 4, Symbol: AUDJPY, Type: SELL
2025-07-03 22:54:15,772 - INFO - orders - [MARGIN_CALC] Market data for AUDJPY: {'b': '94.8610000000', 'o': '94.8540000000'}
2025-07-03 22:54:15,773 - WARNING - orders - [MARGIN_CALC] Missing ask price for AUDJPY, using bid price with spread: bid=94.8610000000, ask=94.87048610000000
2025-07-03 22:54:15,773 - INFO - orders - [MARGIN_CALC] Using prices for AUDJPY: bid=94.8610000000, ask=94.87048610000000
2025-07-03 22:54:15,778 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 948.61 JPY to USD for margin_calculation (user_id: 4, position: None)
2025-07-03 22:54:15,778 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: JPYUSD
2025-07-03 22:54:15,780 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-03 22:54:15,780 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for JPYUSD, trying inverse
2025-07-03 22:54:15,780 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDJPY
2025-07-03 22:54:15,782 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('144.3160000000'), 'o': Decimal('144.3100000000')}
2025-07-03 22:54:15,782 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 144.3160000000
2025-07-03 22:54:15,782 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 948.61 JPY / 144.3160000000 = 6.573145042822694642312702680 USD
2025-07-03 22:54:15,782 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: AUDJPY, Type: SELL, Qty: 0.01, Price: 94.8610000000, Margin: 6.573145042822694642312702680, Commission: 0.10
2025-07-03 22:54:15,809 - INFO - orders - [PERF] Order processing: 0.3638s
2025-07-03 22:54:15,810 - DEBUG - orders - [DEBUG][create_user_order] Received order_data: {'order_id': '6088808702', 'order_status': 'OPEN', 'order_user_id': 4, 'order_company_name': 'AUDJPY', 'order_type': 'SELL', 'order_price': Decimal('94.8610000000'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('94861.00'), 'margin': Decimal('6.573145042822694642312702680'), 'commission': Decimal('0.10'), 'status': None, 'stop_loss': None, 'take_profit': None, 'stoploss_id': None, 'takeprofit_id': None, 'close_id': None}
2025-07-03 22:54:15,810 - DEBUG - orders - [DEBUG][create_user_order] Created OrderActionHistory record for order_id: 6088808702
2025-07-03 22:54:15,838 - INFO - orders - [PERF] Order creation: 0.0281s
2025-07-03 22:54:15,838 - INFO - orders - Publishing order update for user 4
2025-07-03 22:54:15,841 - INFO - orders - Publishing user data update for user 4
2025-07-03 22:54:15,845 - INFO - orders - Publishing market data trigger
2025-07-03 22:54:15,851 - INFO - orders - [PERF] TOTAL place_order: 0.4097s
2025-07-03 22:54:15,883 - app.api.v1.endpoints.orders - INFO - User 4: Updated static orders cache after order change - 9 open orders, 0 pending orders
2025-07-03 22:54:15,883 - ERROR - orders - Error updating portfolio: calculate_user_portfolio() missing 1 required positional argument: 'redis_client'
2025-07-03 22:56:00,621 - INFO - orders - Application starting up - Orders logging initialized
2025-07-03 22:56:00,621 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-03 22:56:28,372 - INFO - orders - Application starting up - Orders logging initialized
2025-07-03 22:56:28,373 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-03 22:56:53,314 - INFO - orders - Application starting up - Orders logging initialized
2025-07-03 22:56:53,314 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-03 22:57:14,130 - INFO - orders - Application starting up - Orders logging initialized
2025-07-03 22:57:14,130 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-03 22:57:30,349 - INFO - orders - Application starting up - Orders logging initialized
2025-07-03 22:57:30,349 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-03 22:57:56,577 - INFO - orders - Application starting up - Orders logging initialized
2025-07-03 22:57:56,577 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-03 22:58:21,582 - INFO - orders - Application starting up - Orders logging initialized
2025-07-03 22:58:21,583 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-03 22:58:26,088 - INFO - orders - Application starting up - Orders logging initialized
2025-07-03 22:58:26,088 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-03 22:58:33,833 - INFO - orders - Application starting up - Orders logging initialized
2025-07-03 22:58:33,833 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-03 22:58:40,027 - INFO - orders - Application starting up - Orders logging initialized
2025-07-03 22:58:40,027 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-03 23:00:29,229 - INFO - orders - Application starting up - Orders logging initialized
2025-07-03 23:00:29,229 - INFO - orders - SL/TP Epsilon accuracy configured: 0.00001
2025-07-03 23:00:41,514 - INFO - orders - Order close request received - Order ID: 6088808702, User ID: 4, Close Price: 94.852
2025-07-03 23:00:41,515 - INFO - orders - user_to_operate_on: <app.database.models.User object at 0x000001D9C48CF9D0>, type: <class 'app.database.models.User'>, user_type: live, attrs: ['__abstract__', '__class__', '__delattr__', '__dict__', '__dir__', '__doc__', '__eq__', '__firstlineno__', '__format__', '__ge__', '__getattribute__', '__getstate__', '__gt__', '__hash__', '__init__', '__init_subclass__', '__le__', '__lt__', '__mapper__', '__module__', '__ne__', '__new__', '__reduce__', '__reduce_ex__', '__repr__', '__setattr__', '__sizeof__', '__static_attributes__', '__str__', '__subclasshook__', '__table__', '__table_args__', '__tablename__', '__weakref__', '_sa_class_manager', '_sa_instance_state', '_sa_registry', 'account_number', 'address_proof', 'address_proof_image', 'bank_account_number', 'bank_branch_name', 'bank_holder_name', 'bank_ifsc_code', 'city', 'country', 'created_at', 'email', 'fund_manager', 'group_name', 'hashed_password', 'id', 'id_proof', 'id_proof_image', 'isActive', 'is_self_trading', 'is_service_account', 'leverage', 'margin', 'metadata', 'money_requests', 'name', 'net_profit', 'orders', 'otps', 'phone_number', 'pincode', 'referred_by_id', 'reffered_code', 'registry', 'rock_orders', 'security_answer', 'security_question', 'state', 'status', 'updated_at', 'user_favorites', 'user_type', 'wallet_balance', 'wallet_transactions']
2025-07-03 23:00:41,515 - INFO - orders - Using order model: user_orders for user 4 (user_type: live)
2025-07-03 23:00:41,515 - INFO - orders - Request to close order 6088808702 for user 4 (user_type: live) with price 94.852. Frontend provided type: SELL, company: AUDJPY, status: CLOSED, frontend_status: CLOSED.
2025-07-03 23:00:41,518 - INFO - orders - User group: Standard, sending_orders setting: rock
2025-07-03 23:00:41,521 - INFO - orders - Live user 4 from group 'default' ('sending_orders' is NOT 'barclays'). Processing close locally.
2025-07-03 23:00:41,539 - INFO - orders - Existing entry commission for order 6088808702: 0.10000000
2025-07-03 23:00:41,539 - INFO - orders - Commission calculation for order 6088808702: entry=0.10000000, exit=0.100000000000, total=0.20
2025-07-03 23:00:41,539 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 9.000000000000000000000000 JPY to USD for PnL on Close (user_id: 4, position: 6088808702)
2025-07-03 23:00:41,539 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: JPYUSD
2025-07-03 23:00:41,540 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-03 23:00:41,540 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for JPYUSD, trying inverse
2025-07-03 23:00:41,540 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDJPY
2025-07-03 23:00:41,540 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('144.3460000000'), 'o': Decimal('144.3410000000')}
2025-07-03 23:00:41,540 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 144.3460000000
2025-07-03 23:00:41,540 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 9.000000000000000000000000 JPY / 144.3460000000 = 0.06235018635777922491790558796 USD
2025-07-03 23:00:41,555 - INFO - orders - [DEBUG] DB commit completed for order 6088808702. Checking DB state...
2025-07-03 23:00:41,559 - INFO - orders - [DEBUG] After commit & refresh: order_id=6088808702, order_status=CLOSED, close_price=94.85200000, net_profit=-0.14000000, commission=0.20000000, close_id=8949831469, updated_at=2025-07-03 23:00:41
2025-07-03 23:00:41,559 - INFO - orders - AFTER COMMIT: User 4 wallet_balance=6606.79000000, margin=39.44000000
2025-07-03 23:00:41,559 - INFO - orders - Setting user data cache for user 4 with wallet_balance=6606.79000000, margin=39.44000000
2025-07-03 23:00:41,559 - INFO - orders - User data cache updated for user 4
2025-07-03 23:00:41,560 - INFO - orders - Starting update_user_static_orders for user 4, user_type live
2025-07-03 23:00:41,560 - INFO - orders - Using order model: UserOrder
2025-07-03 23:00:41,561 - INFO - orders - Fetched 8 open orders for user 4
2025-07-03 23:00:41,563 - INFO - orders - Fetched 0 pending orders for user 4
2025-07-03 23:00:41,563 - INFO - orders - Updated static orders cache for user 4 with 8 open orders and 0 pending orders
2025-07-03 23:00:41,564 - INFO - orders - Publishing order update for user 4
2025-07-03 23:00:41,564 - INFO - orders - Publishing user data update for user 4
2025-07-03 23:00:41,565 - INFO - orders - Publishing market data trigger
2025-07-03 23:00:42,205 - INFO - orders - Order close request received - Order ID: 5502568362, User ID: 4, Close Price: 94.852
2025-07-03 23:00:42,206 - INFO - orders - user_to_operate_on: <app.database.models.User object at 0x000001D9C48CF9D0>, type: <class 'app.database.models.User'>, user_type: live, attrs: ['__abstract__', '__class__', '__delattr__', '__dict__', '__dir__', '__doc__', '__eq__', '__firstlineno__', '__format__', '__ge__', '__getattribute__', '__getstate__', '__gt__', '__hash__', '__init__', '__init_subclass__', '__le__', '__lt__', '__mapper__', '__module__', '__ne__', '__new__', '__reduce__', '__reduce_ex__', '__repr__', '__setattr__', '__sizeof__', '__static_attributes__', '__str__', '__subclasshook__', '__table__', '__table_args__', '__tablename__', '__weakref__', '_sa_class_manager', '_sa_instance_state', '_sa_registry', 'account_number', 'address_proof', 'address_proof_image', 'bank_account_number', 'bank_branch_name', 'bank_holder_name', 'bank_ifsc_code', 'city', 'country', 'created_at', 'email', 'fund_manager', 'group_name', 'hashed_password', 'id', 'id_proof', 'id_proof_image', 'isActive', 'is_self_trading', 'is_service_account', 'leverage', 'margin', 'metadata', 'money_requests', 'name', 'net_profit', 'orders', 'otps', 'phone_number', 'pincode', 'referred_by_id', 'reffered_code', 'registry', 'rock_orders', 'security_answer', 'security_question', 'state', 'status', 'updated_at', 'user_favorites', 'user_type', 'wallet_balance', 'wallet_transactions']
2025-07-03 23:00:42,206 - INFO - orders - Using order model: user_orders for user 4 (user_type: live)
2025-07-03 23:00:42,207 - INFO - orders - Request to close order 5502568362 for user 4 (user_type: live) with price 94.852. Frontend provided type: SELL, company: AUDJPY, status: CLOSED, frontend_status: CLOSED.
2025-07-03 23:00:42,216 - INFO - orders - User group: Standard, sending_orders setting: rock
2025-07-03 23:00:42,231 - INFO - orders - Live user 4 from group 'default' ('sending_orders' is NOT 'barclays'). Processing close locally.
2025-07-03 23:00:42,266 - INFO - orders - Existing entry commission for order 5502568362: 0.10000000
2025-07-03 23:00:42,266 - INFO - orders - Commission calculation for order 5502568362: entry=0.10000000, exit=0.100000000000, total=0.20
2025-07-03 23:00:42,267 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 8.000000000000000000000000 JPY to USD for PnL on Close (user_id: 4, position: 5502568362)
2025-07-03 23:00:42,267 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: JPYUSD
2025-07-03 23:00:42,268 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-03 23:00:42,268 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for JPYUSD, trying inverse
2025-07-03 23:00:42,269 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDJPY
2025-07-03 23:00:42,271 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('144.3460000000'), 'o': Decimal('144.3410000000')}
2025-07-03 23:00:42,271 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 144.3460000000
2025-07-03 23:00:42,271 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 8.000000000000000000000000 JPY / 144.3460000000 = 0.05542238787358153326036052263 USD
2025-07-03 23:00:42,309 - INFO - orders - [DEBUG] DB commit completed for order 5502568362. Checking DB state...
2025-07-03 23:00:42,315 - INFO - orders - [DEBUG] After commit & refresh: order_id=5502568362, order_status=CLOSED, close_price=94.85200000, net_profit=-0.14000000, commission=0.20000000, close_id=3253406376, updated_at=2025-07-03 23:00:42
2025-07-03 23:00:42,315 - INFO - orders - AFTER COMMIT: User 4 wallet_balance=6606.65000000, margin=32.87000000
2025-07-03 23:00:42,316 - INFO - orders - Setting user data cache for user 4 with wallet_balance=6606.65000000, margin=32.87000000
2025-07-03 23:00:42,318 - INFO - orders - User data cache updated for user 4
2025-07-03 23:00:42,319 - INFO - orders - Starting update_user_static_orders for user 4, user_type live
2025-07-03 23:00:42,319 - INFO - orders - Using order model: UserOrder
2025-07-03 23:00:42,325 - INFO - orders - Fetched 7 open orders for user 4
2025-07-03 23:00:42,330 - INFO - orders - Fetched 0 pending orders for user 4
2025-07-03 23:00:42,334 - INFO - orders - Updated static orders cache for user 4 with 7 open orders and 0 pending orders
2025-07-03 23:00:42,334 - INFO - orders - Publishing order update for user 4
2025-07-03 23:00:42,336 - INFO - orders - Publishing user data update for user 4
2025-07-03 23:00:42,340 - INFO - orders - Publishing market data trigger
2025-07-03 23:00:43,033 - INFO - orders - Order close request received - Order ID: 7626051743, User ID: 4, Close Price: 94.852
2025-07-03 23:00:43,034 - INFO - orders - user_to_operate_on: <app.database.models.User object at 0x000001D9C48CE0D0>, type: <class 'app.database.models.User'>, user_type: live, attrs: ['__abstract__', '__class__', '__delattr__', '__dict__', '__dir__', '__doc__', '__eq__', '__firstlineno__', '__format__', '__ge__', '__getattribute__', '__getstate__', '__gt__', '__hash__', '__init__', '__init_subclass__', '__le__', '__lt__', '__mapper__', '__module__', '__ne__', '__new__', '__reduce__', '__reduce_ex__', '__repr__', '__setattr__', '__sizeof__', '__static_attributes__', '__str__', '__subclasshook__', '__table__', '__table_args__', '__tablename__', '__weakref__', '_sa_class_manager', '_sa_instance_state', '_sa_registry', 'account_number', 'address_proof', 'address_proof_image', 'bank_account_number', 'bank_branch_name', 'bank_holder_name', 'bank_ifsc_code', 'city', 'country', 'created_at', 'email', 'fund_manager', 'group_name', 'hashed_password', 'id', 'id_proof', 'id_proof_image', 'isActive', 'is_self_trading', 'is_service_account', 'leverage', 'margin', 'metadata', 'money_requests', 'name', 'net_profit', 'orders', 'otps', 'phone_number', 'pincode', 'referred_by_id', 'reffered_code', 'registry', 'rock_orders', 'security_answer', 'security_question', 'state', 'status', 'updated_at', 'user_favorites', 'user_type', 'wallet_balance', 'wallet_transactions']
2025-07-03 23:00:43,034 - INFO - orders - Using order model: user_orders for user 4 (user_type: live)
2025-07-03 23:00:43,035 - INFO - orders - Request to close order 7626051743 for user 4 (user_type: live) with price 94.852. Frontend provided type: SELL, company: AUDJPY, status: CLOSED, frontend_status: CLOSED.
2025-07-03 23:00:43,053 - INFO - orders - User group: Standard, sending_orders setting: rock
2025-07-03 23:00:43,071 - INFO - orders - Live user 4 from group 'default' ('sending_orders' is NOT 'barclays'). Processing close locally.
2025-07-03 23:00:43,110 - INFO - orders - Existing entry commission for order 7626051743: 0.10000000
2025-07-03 23:00:43,110 - INFO - orders - Commission calculation for order 7626051743: entry=0.10000000, exit=0.100000000000, total=0.20
2025-07-03 23:00:43,111 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 9.000000000000000000000000 JPY to USD for PnL on Close (user_id: 4, position: 7626051743)
2025-07-03 23:00:43,111 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: JPYUSD
2025-07-03 23:00:43,113 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-03 23:00:43,113 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for JPYUSD, trying inverse
2025-07-03 23:00:43,113 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDJPY
2025-07-03 23:00:43,116 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('144.3460000000'), 'o': Decimal('144.3410000000')}
2025-07-03 23:00:43,116 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 144.3460000000
2025-07-03 23:00:43,116 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 9.000000000000000000000000 JPY / 144.3460000000 = 0.06235018635777922491790558796 USD
2025-07-03 23:00:43,154 - INFO - orders - [DEBUG] DB commit completed for order 7626051743. Checking DB state...
2025-07-03 23:00:43,162 - INFO - orders - [DEBUG] After commit & refresh: order_id=7626051743, order_status=CLOSED, close_price=94.85200000, net_profit=-0.14000000, commission=0.20000000, close_id=2742878802, updated_at=2025-07-03 23:00:43
2025-07-03 23:00:43,163 - INFO - orders - AFTER COMMIT: User 4 wallet_balance=6606.51000000, margin=26.30000000
2025-07-03 23:00:43,163 - INFO - orders - Setting user data cache for user 4 with wallet_balance=6606.51000000, margin=26.30000000
2025-07-03 23:00:43,166 - INFO - orders - User data cache updated for user 4
2025-07-03 23:00:43,166 - INFO - orders - Starting update_user_static_orders for user 4, user_type live
2025-07-03 23:00:43,166 - INFO - orders - Using order model: UserOrder
2025-07-03 23:00:43,174 - INFO - orders - Fetched 6 open orders for user 4
2025-07-03 23:00:43,179 - INFO - orders - Fetched 0 pending orders for user 4
2025-07-03 23:00:43,181 - INFO - orders - Updated static orders cache for user 4 with 6 open orders and 0 pending orders
2025-07-03 23:00:43,182 - INFO - orders - Publishing order update for user 4
2025-07-03 23:00:43,184 - INFO - orders - Publishing user data update for user 4
2025-07-03 23:00:43,186 - INFO - orders - Publishing market data trigger
2025-07-03 23:00:43,723 - INFO - orders - Order close request received - Order ID: 5787413738, User ID: 4, Close Price: 94.852
2025-07-03 23:00:43,723 - INFO - orders - user_to_operate_on: <app.database.models.User object at 0x000001D9C48CE0D0>, type: <class 'app.database.models.User'>, user_type: live, attrs: ['__abstract__', '__class__', '__delattr__', '__dict__', '__dir__', '__doc__', '__eq__', '__firstlineno__', '__format__', '__ge__', '__getattribute__', '__getstate__', '__gt__', '__hash__', '__init__', '__init_subclass__', '__le__', '__lt__', '__mapper__', '__module__', '__ne__', '__new__', '__reduce__', '__reduce_ex__', '__repr__', '__setattr__', '__sizeof__', '__static_attributes__', '__str__', '__subclasshook__', '__table__', '__table_args__', '__tablename__', '__weakref__', '_sa_class_manager', '_sa_instance_state', '_sa_registry', 'account_number', 'address_proof', 'address_proof_image', 'bank_account_number', 'bank_branch_name', 'bank_holder_name', 'bank_ifsc_code', 'city', 'country', 'created_at', 'email', 'fund_manager', 'group_name', 'hashed_password', 'id', 'id_proof', 'id_proof_image', 'isActive', 'is_self_trading', 'is_service_account', 'leverage', 'margin', 'metadata', 'money_requests', 'name', 'net_profit', 'orders', 'otps', 'phone_number', 'pincode', 'referred_by_id', 'reffered_code', 'registry', 'rock_orders', 'security_answer', 'security_question', 'state', 'status', 'updated_at', 'user_favorites', 'user_type', 'wallet_balance', 'wallet_transactions']
2025-07-03 23:00:43,723 - INFO - orders - Using order model: user_orders for user 4 (user_type: live)
2025-07-03 23:00:43,723 - INFO - orders - Request to close order 5787413738 for user 4 (user_type: live) with price 94.852. Frontend provided type: SELL, company: AUDJPY, status: CLOSED, frontend_status: CLOSED.
2025-07-03 23:00:43,727 - INFO - orders - User group: Standard, sending_orders setting: rock
2025-07-03 23:00:43,738 - INFO - orders - Live user 4 from group 'default' ('sending_orders' is NOT 'barclays'). Processing close locally.
2025-07-03 23:00:44,054 - INFO - orders - Existing entry commission for order 5787413738: 0.10000000
2025-07-03 23:00:44,054 - INFO - orders - Commission calculation for order 5787413738: entry=0.10000000, exit=0.100000000000, total=0.20
2025-07-03 23:00:44,054 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 8.000000000000000000000000 JPY to USD for PnL on Close (user_id: 4, position: 5787413738)
2025-07-03 23:00:44,054 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: JPYUSD
2025-07-03 23:00:44,055 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-03 23:00:44,056 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for JPYUSD, trying inverse
2025-07-03 23:00:44,066 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDJPY
2025-07-03 23:00:44,071 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('144.3460000000'), 'o': Decimal('144.3410000000')}
2025-07-03 23:00:44,071 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 144.3460000000
2025-07-03 23:00:44,071 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 8.000000000000000000000000 JPY / 144.3460000000 = 0.05542238787358153326036052263 USD
2025-07-03 23:00:44,091 - INFO - orders - [DEBUG] DB commit completed for order 5787413738. Checking DB state...
2025-07-03 23:00:44,096 - INFO - orders - [DEBUG] After commit & refresh: order_id=5787413738, order_status=CLOSED, close_price=94.85200000, net_profit=-0.14000000, commission=0.20000000, close_id=3592824424, updated_at=2025-07-03 23:00:44
2025-07-03 23:00:44,096 - INFO - orders - AFTER COMMIT: User 4 wallet_balance=6606.37000000, margin=19.72000000
2025-07-03 23:00:44,097 - INFO - orders - Setting user data cache for user 4 with wallet_balance=6606.37000000, margin=19.72000000
2025-07-03 23:00:44,098 - INFO - orders - User data cache updated for user 4
2025-07-03 23:00:44,098 - INFO - orders - Starting update_user_static_orders for user 4, user_type live
2025-07-03 23:00:44,098 - INFO - orders - Using order model: UserOrder
2025-07-03 23:00:44,102 - INFO - orders - Fetched 5 open orders for user 4
2025-07-03 23:00:44,106 - INFO - orders - Fetched 0 pending orders for user 4
2025-07-03 23:00:44,107 - INFO - orders - Updated static orders cache for user 4 with 5 open orders and 0 pending orders
2025-07-03 23:00:44,107 - INFO - orders - Publishing order update for user 4
2025-07-03 23:00:44,108 - INFO - orders - Publishing user data update for user 4
2025-07-03 23:00:44,110 - INFO - orders - Publishing market data trigger
2025-07-03 23:00:44,681 - INFO - orders - Order close request received - Order ID: 7392384883, User ID: 4, Close Price: 94.852
2025-07-03 23:00:44,681 - INFO - orders - user_to_operate_on: <app.database.models.User object at 0x000001D9C48CE0D0>, type: <class 'app.database.models.User'>, user_type: live, attrs: ['__abstract__', '__class__', '__delattr__', '__dict__', '__dir__', '__doc__', '__eq__', '__firstlineno__', '__format__', '__ge__', '__getattribute__', '__getstate__', '__gt__', '__hash__', '__init__', '__init_subclass__', '__le__', '__lt__', '__mapper__', '__module__', '__ne__', '__new__', '__reduce__', '__reduce_ex__', '__repr__', '__setattr__', '__sizeof__', '__static_attributes__', '__str__', '__subclasshook__', '__table__', '__table_args__', '__tablename__', '__weakref__', '_sa_class_manager', '_sa_instance_state', '_sa_registry', 'account_number', 'address_proof', 'address_proof_image', 'bank_account_number', 'bank_branch_name', 'bank_holder_name', 'bank_ifsc_code', 'city', 'country', 'created_at', 'email', 'fund_manager', 'group_name', 'hashed_password', 'id', 'id_proof', 'id_proof_image', 'isActive', 'is_self_trading', 'is_service_account', 'leverage', 'margin', 'metadata', 'money_requests', 'name', 'net_profit', 'orders', 'otps', 'phone_number', 'pincode', 'referred_by_id', 'reffered_code', 'registry', 'rock_orders', 'security_answer', 'security_question', 'state', 'status', 'updated_at', 'user_favorites', 'user_type', 'wallet_balance', 'wallet_transactions']
2025-07-03 23:00:44,682 - INFO - orders - Using order model: user_orders for user 4 (user_type: live)
2025-07-03 23:00:44,682 - INFO - orders - Request to close order 7392384883 for user 4 (user_type: live) with price 94.852. Frontend provided type: SELL, company: AUDJPY, status: CLOSED, frontend_status: CLOSED.
2025-07-03 23:00:44,692 - INFO - orders - User group: Standard, sending_orders setting: rock
2025-07-03 23:00:44,708 - INFO - orders - Live user 4 from group 'default' ('sending_orders' is NOT 'barclays'). Processing close locally.
2025-07-03 23:00:44,739 - INFO - orders - Existing entry commission for order 7392384883: 0.10000000
2025-07-03 23:00:44,739 - INFO - orders - Commission calculation for order 7392384883: entry=0.10000000, exit=0.100000000000, total=0.20
2025-07-03 23:00:44,739 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 11.000000000000000000000000 JPY to USD for PnL on Close (user_id: 4, position: 7392384883)
2025-07-03 23:00:44,739 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: JPYUSD
2025-07-03 23:00:44,741 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-03 23:00:44,741 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for JPYUSD, trying inverse
2025-07-03 23:00:44,741 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDJPY
2025-07-03 23:00:44,744 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('144.3460000000'), 'o': Decimal('144.3410000000')}
2025-07-03 23:00:44,745 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 144.3460000000
2025-07-03 23:00:44,745 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 11.000000000000000000000000 JPY / 144.3460000000 = 0.07620578332617460823299571862 USD
2025-07-03 23:00:44,782 - INFO - orders - [DEBUG] DB commit completed for order 7392384883. Checking DB state...
2025-07-03 23:00:44,788 - INFO - orders - [DEBUG] After commit & refresh: order_id=7392384883, order_status=CLOSED, close_price=94.85200000, net_profit=-0.12000000, commission=0.20000000, close_id=1545959829, updated_at=2025-07-03 23:00:44
2025-07-03 23:00:44,789 - INFO - orders - AFTER COMMIT: User 4 wallet_balance=6606.25000000, margin=13.15000000
2025-07-03 23:00:44,789 - INFO - orders - Setting user data cache for user 4 with wallet_balance=6606.25000000, margin=13.15000000
2025-07-03 23:00:44,792 - INFO - orders - User data cache updated for user 4
2025-07-03 23:00:44,793 - INFO - orders - Starting update_user_static_orders for user 4, user_type live
2025-07-03 23:00:44,793 - INFO - orders - Using order model: UserOrder
2025-07-03 23:00:44,803 - INFO - orders - Fetched 4 open orders for user 4
2025-07-03 23:00:44,810 - INFO - orders - Fetched 0 pending orders for user 4
2025-07-03 23:00:44,814 - INFO - orders - Updated static orders cache for user 4 with 4 open orders and 0 pending orders
2025-07-03 23:00:44,814 - INFO - orders - Publishing order update for user 4
2025-07-03 23:00:44,817 - INFO - orders - Publishing user data update for user 4
2025-07-03 23:00:44,822 - INFO - orders - Publishing market data trigger
2025-07-03 23:00:45,492 - INFO - orders - Order close request received - Order ID: 9536495452, User ID: 4, Close Price: 94.852
2025-07-03 23:00:45,492 - INFO - orders - user_to_operate_on: <app.database.models.User object at 0x000001D9C48CF250>, type: <class 'app.database.models.User'>, user_type: live, attrs: ['__abstract__', '__class__', '__delattr__', '__dict__', '__dir__', '__doc__', '__eq__', '__firstlineno__', '__format__', '__ge__', '__getattribute__', '__getstate__', '__gt__', '__hash__', '__init__', '__init_subclass__', '__le__', '__lt__', '__mapper__', '__module__', '__ne__', '__new__', '__reduce__', '__reduce_ex__', '__repr__', '__setattr__', '__sizeof__', '__static_attributes__', '__str__', '__subclasshook__', '__table__', '__table_args__', '__tablename__', '__weakref__', '_sa_class_manager', '_sa_instance_state', '_sa_registry', 'account_number', 'address_proof', 'address_proof_image', 'bank_account_number', 'bank_branch_name', 'bank_holder_name', 'bank_ifsc_code', 'city', 'country', 'created_at', 'email', 'fund_manager', 'group_name', 'hashed_password', 'id', 'id_proof', 'id_proof_image', 'isActive', 'is_self_trading', 'is_service_account', 'leverage', 'margin', 'metadata', 'money_requests', 'name', 'net_profit', 'orders', 'otps', 'phone_number', 'pincode', 'referred_by_id', 'reffered_code', 'registry', 'rock_orders', 'security_answer', 'security_question', 'state', 'status', 'updated_at', 'user_favorites', 'user_type', 'wallet_balance', 'wallet_transactions']
2025-07-03 23:00:45,493 - INFO - orders - Using order model: user_orders for user 4 (user_type: live)
2025-07-03 23:00:45,493 - INFO - orders - Request to close order 9536495452 for user 4 (user_type: live) with price 94.852. Frontend provided type: SELL, company: AUDJPY, status: CLOSED, frontend_status: CLOSED.
2025-07-03 23:00:45,511 - INFO - orders - User group: Standard, sending_orders setting: rock
2025-07-03 23:00:45,528 - INFO - orders - Live user 4 from group 'default' ('sending_orders' is NOT 'barclays'). Processing close locally.
2025-07-03 23:00:45,569 - INFO - orders - Existing entry commission for order 9536495452: 0.10000000
2025-07-03 23:00:45,569 - INFO - orders - Commission calculation for order 9536495452: entry=0.10000000, exit=0.100000000000, total=0.20
2025-07-03 23:00:45,570 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 11.000000000000000000000000 JPY to USD for PnL on Close (user_id: 4, position: 9536495452)
2025-07-03 23:00:45,570 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: JPYUSD
2025-07-03 23:00:45,571 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-03 23:00:45,571 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for JPYUSD, trying inverse
2025-07-03 23:00:45,571 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDJPY
2025-07-03 23:00:45,573 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('144.3420000000'), 'o': Decimal('144.3350000000')}
2025-07-03 23:00:45,573 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 144.3420000000
2025-07-03 23:00:45,573 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 11.000000000000000000000000 JPY / 144.3420000000 = 0.07620789513793629019966468526 USD
2025-07-03 23:00:45,612 - INFO - orders - [DEBUG] DB commit completed for order 9536495452. Checking DB state...
2025-07-03 23:00:45,619 - INFO - orders - [DEBUG] After commit & refresh: order_id=9536495452, order_status=CLOSED, close_price=94.85200000, net_profit=-0.12000000, commission=0.20000000, close_id=2585052045, updated_at=2025-07-03 23:00:45
2025-07-03 23:00:45,619 - INFO - orders - AFTER COMMIT: User 4 wallet_balance=6606.13000000, margin=13.15000000
2025-07-03 23:00:45,620 - INFO - orders - Setting user data cache for user 4 with wallet_balance=6606.13000000, margin=13.15000000
2025-07-03 23:00:45,622 - INFO - orders - User data cache updated for user 4
2025-07-03 23:00:45,622 - INFO - orders - Starting update_user_static_orders for user 4, user_type live
2025-07-03 23:00:45,622 - INFO - orders - Using order model: UserOrder
2025-07-03 23:00:45,627 - INFO - orders - Fetched 3 open orders for user 4
2025-07-03 23:00:45,631 - INFO - orders - Fetched 0 pending orders for user 4
2025-07-03 23:00:45,633 - INFO - orders - Updated static orders cache for user 4 with 3 open orders and 0 pending orders
2025-07-03 23:00:45,633 - INFO - orders - Publishing order update for user 4
2025-07-03 23:00:45,634 - INFO - orders - Publishing user data update for user 4
2025-07-03 23:00:45,636 - INFO - orders - Publishing market data trigger
2025-07-03 23:00:46,505 - INFO - orders - Order close request received - Order ID: 1255619511, User ID: 4, Close Price: 94.819
2025-07-03 23:00:46,505 - INFO - orders - user_to_operate_on: <app.database.models.User object at 0x000001D9C48CE990>, type: <class 'app.database.models.User'>, user_type: live, attrs: ['__abstract__', '__class__', '__delattr__', '__dict__', '__dir__', '__doc__', '__eq__', '__firstlineno__', '__format__', '__ge__', '__getattribute__', '__getstate__', '__gt__', '__hash__', '__init__', '__init_subclass__', '__le__', '__lt__', '__mapper__', '__module__', '__ne__', '__new__', '__reduce__', '__reduce_ex__', '__repr__', '__setattr__', '__sizeof__', '__static_attributes__', '__str__', '__subclasshook__', '__table__', '__table_args__', '__tablename__', '__weakref__', '_sa_class_manager', '_sa_instance_state', '_sa_registry', 'account_number', 'address_proof', 'address_proof_image', 'bank_account_number', 'bank_branch_name', 'bank_holder_name', 'bank_ifsc_code', 'city', 'country', 'created_at', 'email', 'fund_manager', 'group_name', 'hashed_password', 'id', 'id_proof', 'id_proof_image', 'isActive', 'is_self_trading', 'is_service_account', 'leverage', 'margin', 'metadata', 'money_requests', 'name', 'net_profit', 'orders', 'otps', 'phone_number', 'pincode', 'referred_by_id', 'reffered_code', 'registry', 'rock_orders', 'security_answer', 'security_question', 'state', 'status', 'updated_at', 'user_favorites', 'user_type', 'wallet_balance', 'wallet_transactions']
2025-07-03 23:00:46,506 - INFO - orders - Using order model: user_orders for user 4 (user_type: live)
2025-07-03 23:00:46,506 - INFO - orders - Request to close order 1255619511 for user 4 (user_type: live) with price 94.819. Frontend provided type: BUY, company: AUDJPY, status: CLOSED, frontend_status: CLOSED.
2025-07-03 23:00:46,513 - INFO - orders - User group: Standard, sending_orders setting: rock
2025-07-03 23:00:46,521 - INFO - orders - Live user 4 from group 'default' ('sending_orders' is NOT 'barclays'). Processing close locally.
2025-07-03 23:00:46,541 - INFO - orders - Existing entry commission for order 1255619511: 0.10000000
2025-07-03 23:00:46,542 - INFO - orders - Commission calculation for order 1255619511: entry=0.10000000, exit=0.100000000000, total=0.20
2025-07-03 23:00:46,542 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of -54.486400000000000000000000 JPY to USD for PnL on Close (user_id: 4, position: 1255619511)
2025-07-03 23:00:46,542 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: JPYUSD
2025-07-03 23:00:46,543 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-03 23:00:46,543 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for JPYUSD, trying inverse
2025-07-03 23:00:46,543 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDJPY
2025-07-03 23:00:46,544 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('144.3420000000'), 'o': Decimal('144.3350000000')}
2025-07-03 23:00:46,545 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 144.3420000000
2025-07-03 23:00:46,545 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: -54.486400000000000000000000 JPY / 144.3420000000 = -0.3774812597857865347577281734 USD
2025-07-03 23:00:46,562 - INFO - orders - [DEBUG] DB commit completed for order 1255619511. Checking DB state...
2025-07-03 23:00:46,568 - INFO - orders - [DEBUG] After commit & refresh: order_id=1255619511, order_status=CLOSED, close_price=94.81900000, net_profit=-0.58000000, commission=0.20000000, close_id=3196620689, updated_at=2025-07-03 23:00:46
2025-07-03 23:00:46,569 - INFO - orders - AFTER COMMIT: User 4 wallet_balance=6605.55000000, margin=6.57000000
2025-07-03 23:00:46,569 - INFO - orders - Setting user data cache for user 4 with wallet_balance=6605.55000000, margin=6.57000000
2025-07-03 23:00:46,570 - INFO - orders - User data cache updated for user 4
2025-07-03 23:00:46,570 - INFO - orders - Starting update_user_static_orders for user 4, user_type live
2025-07-03 23:00:46,570 - INFO - orders - Using order model: UserOrder
2025-07-03 23:00:46,574 - INFO - orders - Fetched 2 open orders for user 4
2025-07-03 23:00:46,577 - INFO - orders - Fetched 0 pending orders for user 4
2025-07-03 23:00:46,578 - INFO - orders - Updated static orders cache for user 4 with 2 open orders and 0 pending orders
2025-07-03 23:00:46,578 - INFO - orders - Publishing order update for user 4
2025-07-03 23:00:46,580 - INFO - orders - Publishing user data update for user 4
2025-07-03 23:00:46,582 - INFO - orders - Publishing market data trigger
2025-07-03 23:00:47,176 - INFO - orders - Order close request received - Order ID: 8040156763, User ID: 4, Close Price: 94.853
2025-07-03 23:00:47,176 - INFO - orders - user_to_operate_on: <app.database.models.User object at 0x000001D9C48CE350>, type: <class 'app.database.models.User'>, user_type: live, attrs: ['__abstract__', '__class__', '__delattr__', '__dict__', '__dir__', '__doc__', '__eq__', '__firstlineno__', '__format__', '__ge__', '__getattribute__', '__getstate__', '__gt__', '__hash__', '__init__', '__init_subclass__', '__le__', '__lt__', '__mapper__', '__module__', '__ne__', '__new__', '__reduce__', '__reduce_ex__', '__repr__', '__setattr__', '__sizeof__', '__static_attributes__', '__str__', '__subclasshook__', '__table__', '__table_args__', '__tablename__', '__weakref__', '_sa_class_manager', '_sa_instance_state', '_sa_registry', 'account_number', 'address_proof', 'address_proof_image', 'bank_account_number', 'bank_branch_name', 'bank_holder_name', 'bank_ifsc_code', 'city', 'country', 'created_at', 'email', 'fund_manager', 'group_name', 'hashed_password', 'id', 'id_proof', 'id_proof_image', 'isActive', 'is_self_trading', 'is_service_account', 'leverage', 'margin', 'metadata', 'money_requests', 'name', 'net_profit', 'orders', 'otps', 'phone_number', 'pincode', 'referred_by_id', 'reffered_code', 'registry', 'rock_orders', 'security_answer', 'security_question', 'state', 'status', 'updated_at', 'user_favorites', 'user_type', 'wallet_balance', 'wallet_transactions']
2025-07-03 23:00:47,176 - INFO - orders - Using order model: user_orders for user 4 (user_type: live)
2025-07-03 23:00:47,176 - INFO - orders - Request to close order 8040156763 for user 4 (user_type: live) with price 94.853. Frontend provided type: SELL, company: AUDJPY, status: CLOSED, frontend_status: CLOSED.
2025-07-03 23:00:47,191 - INFO - orders - User group: Standard, sending_orders setting: rock
2025-07-03 23:00:47,204 - INFO - orders - Live user 4 from group 'default' ('sending_orders' is NOT 'barclays'). Processing close locally.
2025-07-03 23:00:47,230 - INFO - orders - Existing entry commission for order 8040156763: 0.10000000
2025-07-03 23:00:47,230 - INFO - orders - Commission calculation for order 8040156763: entry=0.10000000, exit=0.100000000000, total=0.20
2025-07-03 23:00:47,230 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 10.000000000000000000000000 JPY to USD for PnL on Close (user_id: 4, position: 8040156763)
2025-07-03 23:00:47,230 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: JPYUSD
2025-07-03 23:00:47,232 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-03 23:00:47,233 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for JPYUSD, trying inverse
2025-07-03 23:00:47,233 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDJPY
2025-07-03 23:00:47,235 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('144.3420000000'), 'o': Decimal('144.3350000000')}
2025-07-03 23:00:47,235 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 144.3420000000
2025-07-03 23:00:47,236 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 10.000000000000000000000000 JPY / 144.3420000000 = 0.06927990467085117290878607751 USD
2025-07-03 23:00:47,273 - INFO - orders - [DEBUG] DB commit completed for order 8040156763. Checking DB state...
2025-07-03 23:00:47,278 - INFO - orders - [DEBUG] After commit & refresh: order_id=8040156763, order_status=CLOSED, close_price=94.85300000, net_profit=-0.13000000, commission=0.20000000, close_id=5157756901, updated_at=2025-07-03 23:00:47
2025-07-03 23:00:47,278 - INFO - orders - AFTER COMMIT: User 4 wallet_balance=6605.42000000, margin=6.57000000
2025-07-03 23:00:47,278 - INFO - orders - Setting user data cache for user 4 with wallet_balance=6605.42000000, margin=6.57000000
2025-07-03 23:00:47,281 - INFO - orders - User data cache updated for user 4
2025-07-03 23:00:47,281 - INFO - orders - Starting update_user_static_orders for user 4, user_type live
2025-07-03 23:00:47,281 - INFO - orders - Using order model: UserOrder
2025-07-03 23:00:47,284 - INFO - orders - Fetched 1 open orders for user 4
2025-07-03 23:00:47,287 - INFO - orders - Fetched 0 pending orders for user 4
2025-07-03 23:00:47,289 - INFO - orders - Updated static orders cache for user 4 with 1 open orders and 0 pending orders
2025-07-03 23:00:47,289 - INFO - orders - Publishing order update for user 4
2025-07-03 23:00:47,291 - INFO - orders - Publishing user data update for user 4
2025-07-03 23:00:47,292 - INFO - orders - Publishing market data trigger
2025-07-03 23:00:47,836 - INFO - orders - Order close request received - Order ID: 5466803491, User ID: 4, Close Price: 94.818
2025-07-03 23:00:47,836 - INFO - orders - user_to_operate_on: <app.database.models.User object at 0x000001D9C48CE490>, type: <class 'app.database.models.User'>, user_type: live, attrs: ['__abstract__', '__class__', '__delattr__', '__dict__', '__dir__', '__doc__', '__eq__', '__firstlineno__', '__format__', '__ge__', '__getattribute__', '__getstate__', '__gt__', '__hash__', '__init__', '__init_subclass__', '__le__', '__lt__', '__mapper__', '__module__', '__ne__', '__new__', '__reduce__', '__reduce_ex__', '__repr__', '__setattr__', '__sizeof__', '__static_attributes__', '__str__', '__subclasshook__', '__table__', '__table_args__', '__tablename__', '__weakref__', '_sa_class_manager', '_sa_instance_state', '_sa_registry', 'account_number', 'address_proof', 'address_proof_image', 'bank_account_number', 'bank_branch_name', 'bank_holder_name', 'bank_ifsc_code', 'city', 'country', 'created_at', 'email', 'fund_manager', 'group_name', 'hashed_password', 'id', 'id_proof', 'id_proof_image', 'isActive', 'is_self_trading', 'is_service_account', 'leverage', 'margin', 'metadata', 'money_requests', 'name', 'net_profit', 'orders', 'otps', 'phone_number', 'pincode', 'referred_by_id', 'reffered_code', 'registry', 'rock_orders', 'security_answer', 'security_question', 'state', 'status', 'updated_at', 'user_favorites', 'user_type', 'wallet_balance', 'wallet_transactions']
2025-07-03 23:00:47,836 - INFO - orders - Using order model: user_orders for user 4 (user_type: live)
2025-07-03 23:00:47,836 - INFO - orders - Request to close order 5466803491 for user 4 (user_type: live) with price 94.818. Frontend provided type: BUY, company: AUDJPY, status: CLOSED, frontend_status: CLOSED.
2025-07-03 23:00:47,848 - INFO - orders - User group: Standard, sending_orders setting: rock
2025-07-03 23:00:47,861 - INFO - orders - Live user 4 from group 'default' ('sending_orders' is NOT 'barclays'). Processing close locally.
2025-07-03 23:00:47,887 - INFO - orders - Existing entry commission for order 5466803491: 0.10000000
2025-07-03 23:00:47,888 - INFO - orders - Commission calculation for order 5466803491: entry=0.10000000, exit=0.100000000000, total=0.20
2025-07-03 23:00:47,888 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of -59.486800000000000000000000 JPY to USD for PnL on Close (user_id: 4, position: 5466803491)
2025-07-03 23:00:47,888 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: JPYUSD
2025-07-03 23:00:47,890 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-03 23:00:47,890 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for JPYUSD, trying inverse
2025-07-03 23:00:47,890 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDJPY
2025-07-03 23:00:47,892 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('144.3460000000'), 'o': Decimal('144.3410000000')}
2025-07-03 23:00:47,892 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 144.3460000000
2025-07-03 23:00:47,893 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: -59.486800000000000000000000 JPY / 144.3460000000 = -0.4121125628697712440940517922 USD
2025-07-03 23:00:47,929 - INFO - orders - [DEBUG] DB commit completed for order 5466803491. Checking DB state...
2025-07-03 23:00:47,939 - INFO - orders - [DEBUG] After commit & refresh: order_id=5466803491, order_status=CLOSED, close_price=94.81800000, net_profit=-0.61000000, commission=0.20000000, close_id=5652926591, updated_at=2025-07-03 23:00:47
2025-07-03 23:00:47,939 - INFO - orders - AFTER COMMIT: User 4 wallet_balance=6604.81000000, margin=0E-8
2025-07-03 23:00:47,939 - INFO - orders - Setting user data cache for user 4 with wallet_balance=6604.81000000, margin=0E-8
2025-07-03 23:00:47,941 - INFO - orders - User data cache updated for user 4
2025-07-03 23:00:47,941 - INFO - orders - Starting update_user_static_orders for user 4, user_type live
2025-07-03 23:00:47,941 - INFO - orders - Using order model: UserOrder
2025-07-03 23:00:48,334 - INFO - orders - Fetched 0 open orders for user 4
2025-07-03 23:00:48,341 - INFO - orders - Fetched 0 pending orders for user 4
2025-07-03 23:00:48,344 - INFO - orders - Updated static orders cache for user 4 with 0 open orders and 0 pending orders
2025-07-03 23:00:48,344 - INFO - orders - Publishing order update for user 4
2025-07-03 23:00:48,346 - INFO - orders - Publishing user data update for user 4
2025-07-03 23:00:48,350 - INFO - orders - Publishing market data trigger
2025-07-03 23:00:53,326 - INFO - orders - Order placement request received - User: 4, Symbol: AUDJPY, Type: BUY
2025-07-03 23:00:53,666 - INFO - orders - [MARGIN_CALC] Market data for AUDJPY: {'b': '94.8360000000', 'o': '94.8330000000'}
2025-07-03 23:00:53,666 - WARNING - orders - [MARGIN_CALC] Missing ask price for AUDJPY, using bid price with spread: bid=94.8360000000, ask=94.84548360000000
2025-07-03 23:00:53,666 - INFO - orders - [MARGIN_CALC] Using prices for AUDJPY: bid=94.8360000000, ask=94.84548360000000
2025-07-03 23:00:53,668 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 948.45 JPY to USD for margin_calculation (user_id: 4, position: None)
2025-07-03 23:00:53,668 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: JPYUSD
2025-07-03 23:00:53,669 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-03 23:00:53,670 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for JPYUSD, trying inverse
2025-07-03 23:00:53,670 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDJPY
2025-07-03 23:00:53,672 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('144.3470000000'), 'o': Decimal('144.3410000000')}
2025-07-03 23:00:53,672 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 144.3470000000
2025-07-03 23:00:53,673 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 948.45 JPY / 144.3470000000 = 6.570624952371715380298863156 USD
2025-07-03 23:00:53,673 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: AUDJPY, Type: BUY, Qty: 0.01, Price: 94.84548360000000, Margin: 6.570624952371715380298863156, Commission: 0.10
2025-07-03 23:00:53,697 - INFO - orders - [PERF] Order processing: 0.3696s
2025-07-03 23:00:53,698 - DEBUG - orders - [DEBUG][create_user_order] Received order_data: {'order_id': '8183308982', 'order_status': 'OPEN', 'order_user_id': 4, 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_price': Decimal('94.84548360000000'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('94845.48'), 'margin': Decimal('6.570624952371715380298863156'), 'commission': Decimal('0.10'), 'status': None, 'stop_loss': None, 'take_profit': None, 'stoploss_id': None, 'takeprofit_id': None, 'close_id': None}
2025-07-03 23:00:53,699 - DEBUG - orders - [DEBUG][create_user_order] Created OrderActionHistory record for order_id: 8183308982
2025-07-03 23:00:53,727 - INFO - orders - [PERF] Order creation: 0.0294s
2025-07-03 23:00:53,728 - INFO - orders - Publishing order update for user 4
2025-07-03 23:00:53,730 - INFO - orders - Publishing user data update for user 4
2025-07-03 23:00:53,733 - INFO - orders - Publishing market data trigger
2025-07-03 23:00:53,736 - INFO - orders - [PERF] TOTAL place_order: 0.4108s
2025-07-03 23:00:53,781 - app.api.v1.endpoints.orders - INFO - User 4: Updated static orders cache after order change - 1 open orders, 0 pending orders
2025-07-03 23:00:53,781 - ERROR - orders - Error updating portfolio: calculate_user_portfolio() missing 1 required positional argument: 'redis_client'
2025-07-03 23:00:55,478 - INFO - orders - Order placement request received - User: 4, Symbol: AUDJPY, Type: SELL
2025-07-03 23:00:55,816 - INFO - orders - [MARGIN_CALC] Market data for AUDJPY: {'b': '94.8370000000', 'o': '94.8330000000'}
2025-07-03 23:00:55,816 - WARNING - orders - [MARGIN_CALC] Missing ask price for AUDJPY, using bid price with spread: bid=94.8370000000, ask=94.84648370000000
2025-07-03 23:00:55,816 - INFO - orders - [MARGIN_CALC] Using prices for AUDJPY: bid=94.8370000000, ask=94.84648370000000
2025-07-03 23:00:55,818 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 948.37 JPY to USD for margin_calculation (user_id: 4, position: None)
2025-07-03 23:00:55,818 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: JPYUSD
2025-07-03 23:00:55,820 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-03 23:00:55,820 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for JPYUSD, trying inverse
2025-07-03 23:00:55,820 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDJPY
2025-07-03 23:00:55,822 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('144.3460000000'), 'o': Decimal('144.3430000000')}
2025-07-03 23:00:55,822 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 144.3460000000
2025-07-03 23:00:55,822 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 948.37 JPY / 144.3460000000 = 6.570116248458564837266013606 USD
2025-07-03 23:00:55,822 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: AUDJPY, Type: SELL, Qty: 0.01, Price: 94.8370000000, Margin: 6.570116248458564837266013606, Commission: 0.10
2025-07-03 23:00:55,835 - INFO - orders - [PERF] Order processing: 0.3551s
2025-07-03 23:00:55,835 - DEBUG - orders - [DEBUG][create_user_order] Received order_data: {'order_id': '9229420927', 'order_status': 'OPEN', 'order_user_id': 4, 'order_company_name': 'AUDJPY', 'order_type': 'SELL', 'order_price': Decimal('94.8370000000'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('94837.00'), 'margin': Decimal('6.570116248458564837266013606'), 'commission': Decimal('0.10'), 'status': None, 'stop_loss': None, 'take_profit': None, 'stoploss_id': None, 'takeprofit_id': None, 'close_id': None}
2025-07-03 23:00:55,836 - DEBUG - orders - [DEBUG][create_user_order] Created OrderActionHistory record for order_id: 9229420927
2025-07-03 23:00:55,851 - INFO - orders - [PERF] Order creation: 0.0161s
2025-07-03 23:00:55,852 - INFO - orders - Publishing order update for user 4
2025-07-03 23:00:55,855 - INFO - orders - Publishing user data update for user 4
2025-07-03 23:00:55,857 - INFO - orders - Publishing market data trigger
2025-07-03 23:00:55,861 - INFO - orders - [PERF] TOTAL place_order: 0.3839s
2025-07-03 23:00:55,889 - app.api.v1.endpoints.orders - INFO - User 4: Updated static orders cache after order change - 2 open orders, 0 pending orders
2025-07-03 23:00:55,889 - ERROR - orders - Error updating portfolio: calculate_user_portfolio() missing 1 required positional argument: 'redis_client'
2025-07-03 23:00:57,091 - INFO - orders - Order placement request received - User: 4, Symbol: AUDJPY, Type: SELL
2025-07-03 23:00:57,460 - INFO - orders - [MARGIN_CALC] Market data for AUDJPY: {'b': '94.8370000000', 'o': '94.8330000000'}
2025-07-03 23:00:57,461 - WARNING - orders - [MARGIN_CALC] Missing ask price for AUDJPY, using bid price with spread: bid=94.8370000000, ask=94.84648370000000
2025-07-03 23:00:57,461 - INFO - orders - [MARGIN_CALC] Using prices for AUDJPY: bid=94.8370000000, ask=94.84648370000000
2025-07-03 23:00:57,463 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 948.37 JPY to USD for margin_calculation (user_id: 4, position: None)
2025-07-03 23:00:57,464 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: JPYUSD
2025-07-03 23:00:57,465 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-03 23:00:57,465 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for JPYUSD, trying inverse
2025-07-03 23:00:57,465 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDJPY
2025-07-03 23:00:57,467 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('144.3470000000'), 'o': Decimal('144.3420000000')}
2025-07-03 23:00:57,467 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 144.3470000000
2025-07-03 23:00:57,467 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 948.37 JPY / 144.3470000000 = 6.570070732332504312524680111 USD
2025-07-03 23:00:57,467 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: AUDJPY, Type: SELL, Qty: 0.01, Price: 94.8370000000, Margin: 6.570070732332504312524680111, Commission: 0.10
2025-07-03 23:00:57,493 - INFO - orders - [PERF] Order processing: 0.3999s
2025-07-03 23:00:57,493 - DEBUG - orders - [DEBUG][create_user_order] Received order_data: {'order_id': '2498586638', 'order_status': 'OPEN', 'order_user_id': 4, 'order_company_name': 'AUDJPY', 'order_type': 'SELL', 'order_price': Decimal('94.8370000000'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('94837.00'), 'margin': Decimal('6.570070732332504312524680111'), 'commission': Decimal('0.10'), 'status': None, 'stop_loss': None, 'take_profit': None, 'stoploss_id': None, 'takeprofit_id': None, 'close_id': None}
2025-07-03 23:00:57,494 - DEBUG - orders - [DEBUG][create_user_order] Created OrderActionHistory record for order_id: 2498586638
2025-07-03 23:00:57,517 - INFO - orders - [PERF] Order creation: 0.0242s
2025-07-03 23:00:57,518 - INFO - orders - Publishing order update for user 4
2025-07-03 23:00:57,520 - INFO - orders - Publishing user data update for user 4
2025-07-03 23:00:57,522 - INFO - orders - Publishing market data trigger
2025-07-03 23:00:57,523 - INFO - orders - [PERF] TOTAL place_order: 0.4326s
2025-07-03 23:00:57,572 - app.api.v1.endpoints.orders - INFO - User 4: Updated static orders cache after order change - 3 open orders, 0 pending orders
2025-07-03 23:00:57,573 - ERROR - orders - Error updating portfolio: calculate_user_portfolio() missing 1 required positional argument: 'redis_client'
2025-07-03 23:01:00,920 - INFO - orders - Order placement request received - User: 4, Symbol: AUDJPY, Type: BUY
2025-07-03 23:01:01,347 - INFO - orders - [MARGIN_CALC] Market data for AUDJPY: {'b': '94.8240000000', 'o': '94.8180000000'}
2025-07-03 23:01:01,347 - WARNING - orders - [MARGIN_CALC] Missing ask price for AUDJPY, using bid price with spread: bid=94.8240000000, ask=94.83348240000000
2025-07-03 23:01:01,348 - INFO - orders - [MARGIN_CALC] Using prices for AUDJPY: bid=94.8240000000, ask=94.83348240000000
2025-07-03 23:01:01,355 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 948.33 JPY to USD for margin_calculation (user_id: 4, position: None)
2025-07-03 23:01:01,356 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: JPYUSD
2025-07-03 23:01:01,358 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-07-03 23:01:01,358 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for JPYUSD, trying inverse
2025-07-03 23:01:01,358 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDJPY
2025-07-03 23:01:01,362 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('144.3460000000'), 'o': Decimal('144.3440000000')}
2025-07-03 23:01:01,362 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 144.3460000000
2025-07-03 23:01:01,363 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 948.33 JPY / 144.3460000000 = 6.569839136519196929599711804 USD
2025-07-03 23:01:01,363 - INFO - orders - [MARGIN_CALC_OPTIMIZED] Symbol: AUDJPY, Type: BUY, Qty: 0.01, Price: 94.83348240000000, Margin: 6.569839136519196929599711804, Commission: 0.10
2025-07-03 23:01:01,395 - INFO - orders - [PERF] Order processing: 0.4738s
2025-07-03 23:01:01,396 - DEBUG - orders - [DEBUG][create_user_order] Received order_data: {'order_id': '7865509477', 'order_status': 'OPEN', 'order_user_id': 4, 'order_company_name': 'AUDJPY', 'order_type': 'BUY', 'order_price': Decimal('94.83348240000000'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('94833.48'), 'margin': Decimal('6.569839136519196929599711804'), 'commission': Decimal('0.10'), 'status': None, 'stop_loss': None, 'take_profit': None, 'stoploss_id': None, 'takeprofit_id': None, 'close_id': None}
2025-07-03 23:01:01,396 - DEBUG - orders - [DEBUG][create_user_order] Created OrderActionHistory record for order_id: 7865509477
2025-07-03 23:01:01,473 - INFO - orders - [PERF] Order creation: 0.0775s
2025-07-03 23:01:01,473 - INFO - orders - Publishing order update for user 4
2025-07-03 23:01:01,477 - INFO - orders - Publishing user data update for user 4
2025-07-03 23:01:01,480 - INFO - orders - Publishing market data trigger
2025-07-03 23:01:01,486 - INFO - orders - [PERF] TOTAL place_order: 0.5658s
2025-07-03 23:01:01,516 - app.api.v1.endpoints.orders - INFO - User 4: Updated static orders cache after order change - 4 open orders, 0 pending orders
2025-07-03 23:01:01,516 - ERROR - orders - Error updating portfolio: calculate_user_portfolio() missing 1 required positional argument: 'redis_client'
