2025-06-23 11:34:52,491 - INFO - orders - Application starting up - Orders logging initialized
2025-06-23 11:34:54,699 - INFO - orders - Found 0 pending order keys in Redis
2025-06-23 11:34:54,859 - INFO - orders - [SLTP_CHECK] Checking order 4078720520: symbol=AUDUSD, type=BUY, stop_loss=0.64525000, take_profit=None, user_id=1
2025-06-23 11:34:54,873 - WARNING - orders - No price data found for AUDUSD
2025-06-23 11:34:54,873 - WARNING - orders - [SLTP_CHECK] No price found for AUDUSD when checking SL/TP for order 4078720520
2025-06-23 11:34:54,873 - INFO - orders - [SLTP_CHECK] Checking order 9941796348: symbol=AUDUSD, type=BUY, stop_loss=0.64502000, take_profit=None, user_id=1
2025-06-23 11:34:54,884 - WARNING - orders - No price data found for AUDUSD
2025-06-23 11:34:54,884 - WARNING - orders - [SLTP_CHECK] No price found for AUDUSD when checking SL/TP for order 9941796348
2025-06-23 11:34:54,884 - DEBUG - orders - Completed SL/TP check cycle for 0 live orders and 2 demo orders
2025-06-23 11:34:59,900 - INFO - orders - Found 0 pending order keys in Redis
2025-06-23 11:34:59,913 - INFO - orders - [SLTP_CHECK] Checking order 4078720520: symbol=AUDUSD, type=BUY, stop_loss=0.64525000, take_profit=None, user_id=1
2025-06-23 11:34:59,926 - WARNING - orders - No price data found for AUDUSD
2025-06-23 11:34:59,926 - WARNING - orders - [SLTP_CHECK] No price found for AUDUSD when checking SL/TP for order 4078720520
2025-06-23 11:34:59,926 - INFO - orders - [SLTP_CHECK] Checking order 9941796348: symbol=AUDUSD, type=BUY, stop_loss=0.64502000, take_profit=None, user_id=1
2025-06-23 11:34:59,944 - WARNING - orders - No price data found for AUDUSD
2025-06-23 11:34:59,944 - WARNING - orders - [SLTP_CHECK] No price found for AUDUSD when checking SL/TP for order 9941796348
2025-06-23 11:34:59,944 - DEBUG - orders - Completed SL/TP check cycle for 0 live orders and 2 demo orders
2025-06-23 11:35:04,949 - INFO - orders - Found 0 pending order keys in Redis
2025-06-23 11:35:04,960 - INFO - orders - [SLTP_CHECK] Checking order 4078720520: symbol=AUDUSD, type=BUY, stop_loss=0.64525000, take_profit=None, user_id=1
2025-06-23 11:35:04,973 - WARNING - orders - No price data found for AUDUSD
2025-06-23 11:35:04,973 - WARNING - orders - [SLTP_CHECK] No price found for AUDUSD when checking SL/TP for order 4078720520
2025-06-23 11:35:04,973 - INFO - orders - [SLTP_CHECK] Checking order 9941796348: symbol=AUDUSD, type=BUY, stop_loss=0.64502000, take_profit=None, user_id=1
2025-06-23 11:35:04,984 - WARNING - orders - No price data found for AUDUSD
2025-06-23 11:35:04,984 - WARNING - orders - [SLTP_CHECK] No price found for AUDUSD when checking SL/TP for order 9941796348
2025-06-23 11:35:04,984 - DEBUG - orders - Completed SL/TP check cycle for 0 live orders and 2 demo orders
2025-06-23 11:35:10,001 - INFO - orders - Found 0 pending order keys in Redis
2025-06-23 11:35:10,008 - INFO - orders - [SLTP_CHECK] Checking order 4078720520: symbol=AUDUSD, type=BUY, stop_loss=0.64525000, take_profit=None, user_id=1
2025-06-23 11:35:10,018 - WARNING - orders - No price data found for AUDUSD
2025-06-23 11:35:10,019 - WARNING - orders - [SLTP_CHECK] No price found for AUDUSD when checking SL/TP for order 4078720520
2025-06-23 11:35:10,019 - INFO - orders - [SLTP_CHECK] Checking order 9941796348: symbol=AUDUSD, type=BUY, stop_loss=0.64502000, take_profit=None, user_id=1
2025-06-23 11:35:10,030 - WARNING - orders - No price data found for AUDUSD
2025-06-23 11:35:10,030 - WARNING - orders - [SLTP_CHECK] No price found for AUDUSD when checking SL/TP for order 9941796348
2025-06-23 11:35:10,030 - DEBUG - orders - Completed SL/TP check cycle for 0 live orders and 2 demo orders
2025-06-23 11:35:15,044 - INFO - orders - Found 0 pending order keys in Redis
2025-06-23 11:35:15,052 - INFO - orders - [SLTP_CHECK] Checking order 4078720520: symbol=AUDUSD, type=BUY, stop_loss=0.64525000, take_profit=None, user_id=1
2025-06-23 11:35:15,060 - WARNING - orders - No price data found for AUDUSD
2025-06-23 11:35:15,060 - WARNING - orders - [SLTP_CHECK] No price found for AUDUSD when checking SL/TP for order 4078720520
2025-06-23 11:35:15,061 - INFO - orders - [SLTP_CHECK] Checking order 9941796348: symbol=AUDUSD, type=BUY, stop_loss=0.64502000, take_profit=None, user_id=1
2025-06-23 11:35:15,074 - WARNING - orders - No price data found for AUDUSD
2025-06-23 11:35:15,074 - WARNING - orders - [SLTP_CHECK] No price found for AUDUSD when checking SL/TP for order 9941796348
2025-06-23 11:35:15,074 - DEBUG - orders - Completed SL/TP check cycle for 0 live orders and 2 demo orders
2025-06-23 11:35:20,084 - INFO - orders - Found 0 pending order keys in Redis
2025-06-23 11:35:20,091 - INFO - orders - [SLTP_CHECK] Checking order 4078720520: symbol=AUDUSD, type=BUY, stop_loss=0.64525000, take_profit=None, user_id=1
2025-06-23 11:35:20,097 - WARNING - orders - No price data found for AUDUSD
2025-06-23 11:35:20,097 - WARNING - orders - [SLTP_CHECK] No price found for AUDUSD when checking SL/TP for order 4078720520
2025-06-23 11:35:20,097 - INFO - orders - [SLTP_CHECK] Checking order 9941796348: symbol=AUDUSD, type=BUY, stop_loss=0.64502000, take_profit=None, user_id=1
2025-06-23 11:35:20,102 - WARNING - orders - No price data found for AUDUSD
2025-06-23 11:35:20,102 - WARNING - orders - [SLTP_CHECK] No price found for AUDUSD when checking SL/TP for order 9941796348
2025-06-23 11:35:20,102 - DEBUG - orders - Completed SL/TP check cycle for 0 live orders and 2 demo orders
2025-06-23 11:35:25,112 - INFO - orders - Found 0 pending order keys in Redis
2025-06-23 11:35:25,125 - INFO - orders - [SLTP_CHECK] Checking order 4078720520: symbol=AUDUSD, type=BUY, stop_loss=0.64525000, take_profit=None, user_id=1
2025-06-23 11:35:25,136 - WARNING - orders - No price data found for AUDUSD
2025-06-23 11:35:25,136 - WARNING - orders - [SLTP_CHECK] No price found for AUDUSD when checking SL/TP for order 4078720520
2025-06-23 11:35:25,136 - INFO - orders - [SLTP_CHECK] Checking order 9941796348: symbol=AUDUSD, type=BUY, stop_loss=0.64502000, take_profit=None, user_id=1
2025-06-23 11:35:25,145 - WARNING - orders - No price data found for AUDUSD
2025-06-23 11:35:25,146 - WARNING - orders - [SLTP_CHECK] No price found for AUDUSD when checking SL/TP for order 9941796348
2025-06-23 11:35:25,146 - DEBUG - orders - Completed SL/TP check cycle for 0 live orders and 2 demo orders
2025-06-23 11:35:30,155 - INFO - orders - Found 0 pending order keys in Redis
2025-06-23 11:35:30,166 - INFO - orders - [SLTP_CHECK] Checking order 4078720520: symbol=AUDUSD, type=BUY, stop_loss=0.64525000, take_profit=None, user_id=1
2025-06-23 11:35:30,182 - WARNING - orders - No price data found for AUDUSD
2025-06-23 11:35:30,182 - WARNING - orders - [SLTP_CHECK] No price found for AUDUSD when checking SL/TP for order 4078720520
2025-06-23 11:35:30,182 - INFO - orders - [SLTP_CHECK] Checking order 9941796348: symbol=AUDUSD, type=BUY, stop_loss=0.64502000, take_profit=None, user_id=1
2025-06-23 11:35:30,198 - WARNING - orders - No price data found for AUDUSD
2025-06-23 11:35:30,198 - WARNING - orders - [SLTP_CHECK] No price found for AUDUSD when checking SL/TP for order 9941796348
2025-06-23 11:35:30,198 - DEBUG - orders - Completed SL/TP check cycle for 0 live orders and 2 demo orders
2025-06-23 11:35:35,210 - INFO - orders - Found 0 pending order keys in Redis
2025-06-23 11:35:35,219 - INFO - orders - [SLTP_CHECK] Checking order 4078720520: symbol=AUDUSD, type=BUY, stop_loss=0.64525000, take_profit=None, user_id=1
2025-06-23 11:35:35,229 - WARNING - orders - No price data found for AUDUSD
2025-06-23 11:35:35,229 - WARNING - orders - [SLTP_CHECK] No price found for AUDUSD when checking SL/TP for order 4078720520
2025-06-23 11:35:35,230 - INFO - orders - [SLTP_CHECK] Checking order 9941796348: symbol=AUDUSD, type=BUY, stop_loss=0.64502000, take_profit=None, user_id=1
2025-06-23 11:35:35,239 - WARNING - orders - No price data found for AUDUSD
2025-06-23 11:35:35,239 - WARNING - orders - [SLTP_CHECK] No price found for AUDUSD when checking SL/TP for order 9941796348
2025-06-23 11:35:35,239 - DEBUG - orders - Completed SL/TP check cycle for 0 live orders and 2 demo orders
2025-06-23 11:35:40,249 - INFO - orders - Found 0 pending order keys in Redis
2025-06-23 11:35:40,259 - INFO - orders - [SLTP_CHECK] Checking order 4078720520: symbol=AUDUSD, type=BUY, stop_loss=0.64525000, take_profit=None, user_id=1
2025-06-23 11:35:40,276 - WARNING - orders - No price data found for AUDUSD
2025-06-23 11:35:40,277 - WARNING - orders - [SLTP_CHECK] No price found for AUDUSD when checking SL/TP for order 4078720520
2025-06-23 11:35:40,278 - INFO - orders - [SLTP_CHECK] Checking order 9941796348: symbol=AUDUSD, type=BUY, stop_loss=0.64502000, take_profit=None, user_id=1
2025-06-23 11:35:40,292 - WARNING - orders - No price data found for AUDUSD
2025-06-23 11:35:40,293 - WARNING - orders - [SLTP_CHECK] No price found for AUDUSD when checking SL/TP for order 9941796348
2025-06-23 11:35:40,293 - DEBUG - orders - Completed SL/TP check cycle for 0 live orders and 2 demo orders
2025-06-23 11:35:45,340 - INFO - orders - Found 0 pending order keys in Redis
2025-06-23 11:35:45,672 - INFO - orders - [SLTP_CHECK] Checking order 4078720520: symbol=AUDUSD, type=BUY, stop_loss=0.64525000, take_profit=None, user_id=1
2025-06-23 11:35:45,835 - WARNING - orders - No price data found for AUDUSD
2025-06-23 11:35:45,838 - WARNING - orders - [SLTP_CHECK] No price found for AUDUSD when checking SL/TP for order 4078720520
2025-06-23 11:35:45,841 - INFO - orders - [SLTP_CHECK] Checking order 9941796348: symbol=AUDUSD, type=BUY, stop_loss=0.64502000, take_profit=None, user_id=1
2025-06-23 11:35:46,022 - WARNING - orders - No price data found for AUDUSD
2025-06-23 11:35:46,022 - WARNING - orders - [SLTP_CHECK] No price found for AUDUSD when checking SL/TP for order 9941796348
2025-06-23 11:35:46,022 - DEBUG - orders - Completed SL/TP check cycle for 0 live orders and 2 demo orders
2025-06-23 11:35:46,872 - app.api.v1.endpoints.orders - INFO - [get_rejected_orders] user_type: demo
2025-06-23 11:35:51,309 - INFO - orders - Found 0 pending order keys in Redis
2025-06-23 11:35:51,325 - INFO - orders - [SLTP_CHECK] Checking order 4078720520: symbol=AUDUSD, type=BUY, stop_loss=0.64525000, take_profit=None, user_id=1
2025-06-23 11:35:51,384 - INFO - orders - [SLTP_DEBUG] Types: adjusted_sell_price_n=<class 'decimal.Decimal'>, stop_loss_n=<class 'decimal.Decimal'>, adjusted_buy_price_n=<class 'decimal.Decimal'>, take_profit_n=<class 'NoneType'>
2025-06-23 11:35:51,385 - INFO - orders - [SLTP_DEBUG] Values: adjusted_sell_price_n=0.64463, stop_loss_n=0.64525, adjusted_buy_price_n=0.64497, take_profit_n=None
2025-06-23 11:35:51,385 - INFO - orders - [SLTP_DEBUG] BUY SL: adjusted_sell_price_n=0.64463, stop_loss_n=0.64525, price_diff=0.00062, epsilon=0.00001
2025-06-23 11:35:51,386 - INFO - orders - [SLTP_DEBUG] BUY SL triggered: (adjusted_sell_price_n <= stop_loss_n)=True, (price_diff < epsilon)=False, sl_triggered=True
2025-06-23 11:35:51,386 - INFO - orders - [SLTP_CHECK] Order 4078720520 SL triggered: True, TP triggered: False
2025-06-23 11:35:51,386 - INFO - orders - [SLTP_TRIGGER] Triggering stop_loss for order 4078720520 (user 1, symbol AUDUSD, type BUY)
2025-06-23 11:35:51,448 - INFO - orders - [MARGIN_CONTRIB] Calculating total margin contribution for user 1, symbol AUDUSD, positions: 2
2025-06-23 11:35:51,465 - INFO - orders - [MARGIN_CONTRIB] User leverage: 100.00 (raw: 100.00)
2025-06-23 11:35:51,491 - INFO - orders - [SYMBOL_INFO] Retrieved external symbol info for AUDUSD: contract_size=100000.00000000, profit_currency=USD, digit=5.00000
2025-06-23 11:35:51,491 - INFO - orders - [MARGIN_CONTRIB] Position 1: type=BUY, quantity=0.01000000 (raw: 0.01000000), margin=6.46000000 (raw: 6.46000000)
2025-06-23 11:35:51,492 - INFO - orders - [MARGIN_CONTRIB] Position 1 margin per lot: 6.46000000 / 0.01000000 = 646 (rounded to 646.00000000)
2025-06-23 11:35:51,492 - INFO - orders - [MARGIN_CONTRIB] Position 2: type=BUY, quantity=0.01000000 (raw: 0.01000000), margin=6.45000000 (raw: 6.45000000)
2025-06-23 11:35:51,492 - INFO - orders - [MARGIN_CONTRIB] Position 2 margin per lot: 6.45000000 / 0.01000000 = 645 (rounded to 645.00000000)
2025-06-23 11:35:51,492 - INFO - orders - [MARGIN_CONTRIB] Total buy quantity: 0.02000000, Total sell quantity: 0.0, Net quantity: 0.02000000
2025-06-23 11:35:51,493 - INFO - orders - [MARGIN_CONTRIB] All margins per lot: [Decimal('646.00000000'), Decimal('645.00000000')], Highest margin per lot: 646.00000000
2025-06-23 11:35:51,494 - INFO - orders - [MARGIN_CONTRIB] Total margin calculation: 646.00000000 * 0.02000000 = 12.9200000000000000 (rounded to 12.92000000)
2025-06-23 11:35:51,494 - INFO - orders - [MARGIN_CONTRIB] Calculating total margin contribution for user 1, symbol AUDUSD, positions: 1
2025-06-23 11:35:51,502 - INFO - orders - [MARGIN_CONTRIB] User leverage: 100.00 (raw: 100.00)
2025-06-23 11:35:51,515 - INFO - orders - [SYMBOL_INFO] Retrieved external symbol info for AUDUSD: contract_size=100000.00000000, profit_currency=USD, digit=5.00000
2025-06-23 11:35:51,515 - INFO - orders - [MARGIN_CONTRIB] Position 1: type=BUY, quantity=0.01000000 (raw: 0.01000000), margin=6.45000000 (raw: 6.45000000)
2025-06-23 11:35:51,515 - INFO - orders - [MARGIN_CONTRIB] Position 1 margin per lot: 6.45000000 / 0.01000000 = 645 (rounded to 645.00000000)
2025-06-23 11:35:51,516 - INFO - orders - [MARGIN_CONTRIB] Total buy quantity: 0.01000000, Total sell quantity: 0.0, Net quantity: 0.01000000
2025-06-23 11:35:51,516 - INFO - orders - [MARGIN_CONTRIB] All margins per lot: [Decimal('645.00000000')], Highest margin per lot: 645.00000000
2025-06-23 11:35:51,516 - INFO - orders - [MARGIN_CONTRIB] Total margin calculation: 645.00000000 * 0.01000000 = 6.4500000000000000 (rounded to 6.45000000)
2025-06-23 11:35:51,570 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of -0.940000000000000000000000 USD to USD for PnL on Close (user_id: 1, position: 4078720520)
2025-06-23 11:35:51,570 - INFO - orders - [CURRENCY_CONVERT] Currency is already USD, no conversion needed
2025-06-23 11:35:51,669 - ERROR - orders - [SLTP_TRIGGER] Error processing SL/TP for order 4078720520: type object 'datetime.datetime' has no attribute 'datetime'
Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\app\services\pending_orders.py", line 951, in process_order_stoploss_takeprofit
    transaction_time = datetime.datetime.now(datetime.timezone.utc)
                       ^^^^^^^^^^^^^^^^^
AttributeError: type object 'datetime.datetime' has no attribute 'datetime'
2025-06-23 11:35:51,680 - INFO - orders - [SLTP_CHECK] Checking order 9941796348: symbol=AUDUSD, type=BUY, stop_loss=0.64502000, take_profit=None, user_id=1
2025-06-23 11:35:51,722 - INFO - orders - [SLTP_DEBUG] Types: adjusted_sell_price_n=<class 'decimal.Decimal'>, stop_loss_n=<class 'decimal.Decimal'>, adjusted_buy_price_n=<class 'decimal.Decimal'>, take_profit_n=<class 'NoneType'>
2025-06-23 11:35:51,722 - INFO - orders - [SLTP_DEBUG] Values: adjusted_sell_price_n=0.64463, stop_loss_n=0.64502, adjusted_buy_price_n=0.64497, take_profit_n=None
2025-06-23 11:35:51,722 - INFO - orders - [SLTP_DEBUG] BUY SL: adjusted_sell_price_n=0.64463, stop_loss_n=0.64502, price_diff=0.00039, epsilon=0.00001
2025-06-23 11:35:51,722 - INFO - orders - [SLTP_DEBUG] BUY SL triggered: (adjusted_sell_price_n <= stop_loss_n)=True, (price_diff < epsilon)=False, sl_triggered=True
2025-06-23 11:35:51,722 - INFO - orders - [SLTP_CHECK] Order 9941796348 SL triggered: True, TP triggered: False
2025-06-23 11:35:51,723 - INFO - orders - [SLTP_TRIGGER] Triggering stop_loss for order 9941796348 (user 1, symbol AUDUSD, type BUY)
2025-06-23 11:35:51,752 - INFO - orders - [MARGIN_CONTRIB] Calculating total margin contribution for user 1, symbol AUDUSD, positions: 1
2025-06-23 11:35:51,761 - INFO - orders - [MARGIN_CONTRIB] User leverage: 100.00 (raw: 100.00)
2025-06-23 11:35:51,794 - INFO - orders - [SYMBOL_INFO] Retrieved external symbol info for AUDUSD: contract_size=100000.00000000, profit_currency=USD, digit=5.00000
2025-06-23 11:35:51,794 - INFO - orders - [MARGIN_CONTRIB] Position 1: type=BUY, quantity=0.01000000 (raw: 0.01000000), margin=6.45000000 (raw: 6.45000000)
2025-06-23 11:35:51,794 - INFO - orders - [MARGIN_CONTRIB] Position 1 margin per lot: 6.45000000 / 0.01000000 = 645 (rounded to 645.00000000)
2025-06-23 11:35:51,798 - INFO - orders - [MARGIN_CONTRIB] Total buy quantity: 0.01000000, Total sell quantity: 0.0, Net quantity: 0.01000000
2025-06-23 11:35:51,799 - INFO - orders - [MARGIN_CONTRIB] All margins per lot: [Decimal('645.00000000')], Highest margin per lot: 645.00000000
2025-06-23 11:35:51,799 - INFO - orders - [MARGIN_CONTRIB] Total margin calculation: 645.00000000 * 0.01000000 = 6.4500000000000000 (rounded to 6.45000000)
2025-06-23 11:35:51,799 - INFO - orders - [MARGIN_CONTRIB] Calculating total margin contribution for user 1, symbol AUDUSD, positions: 0
2025-06-23 11:35:51,808 - INFO - orders - [MARGIN_CONTRIB] User leverage: 100.00 (raw: 100.00)
2025-06-23 11:35:51,825 - INFO - orders - [SYMBOL_INFO] Retrieved external symbol info for AUDUSD: contract_size=100000.00000000, profit_currency=USD, digit=5.00000
2025-06-23 11:35:51,827 - INFO - orders - [MARGIN_CONTRIB] Total buy quantity: 0.0, Total sell quantity: 0.0, Net quantity: 0.0
2025-06-23 11:35:51,828 - INFO - orders - [MARGIN_CONTRIB] All margins per lot: [], Highest margin per lot: 0.0
2025-06-23 11:35:51,828 - INFO - orders - [MARGIN_CONTRIB] Total margin calculation: 0.0 * 0.0 = 0.00 (rounded to 0E-8)
2025-06-23 11:35:51,916 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of -0.740000000000000000000000 USD to USD for PnL on Close (user_id: 1, position: 9941796348)
2025-06-23 11:35:51,916 - INFO - orders - [CURRENCY_CONVERT] Currency is already USD, no conversion needed
2025-06-23 11:35:52,222 - ERROR - orders - [SLTP_TRIGGER] Error processing SL/TP for order 9941796348: type object 'datetime.datetime' has no attribute 'datetime'
Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\app\services\pending_orders.py", line 951, in process_order_stoploss_takeprofit
    transaction_time = datetime.datetime.now(datetime.timezone.utc)
                       ^^^^^^^^^^^^^^^^^
AttributeError: type object 'datetime.datetime' has no attribute 'datetime'
2025-06-23 11:35:52,225 - DEBUG - orders - Completed SL/TP check cycle for 0 live orders and 2 demo orders
2025-06-23 11:35:52,608 - INFO - orders - [SLTP_FLOW] After refresh: order 4078720520 stop_loss=0.64525000, take_profit=None
2025-06-23 11:35:52,609 - INFO - orders - [SLTP_CHECK] Checking order 4078720520: symbol=AUDUSD, type=BUY, stop_loss=0.64525000, take_profit=None, user_id=1
2025-06-23 11:35:52,629 - INFO - orders - [SLTP_DEBUG] Types: adjusted_sell_price_n=<class 'decimal.Decimal'>, stop_loss_n=<class 'decimal.Decimal'>, adjusted_buy_price_n=<class 'decimal.Decimal'>, take_profit_n=<class 'NoneType'>
2025-06-23 11:35:52,630 - INFO - orders - [SLTP_DEBUG] Values: adjusted_sell_price_n=0.64463, stop_loss_n=0.64525, adjusted_buy_price_n=0.64497, take_profit_n=None
2025-06-23 11:35:52,630 - INFO - orders - [SLTP_DEBUG] BUY SL: adjusted_sell_price_n=0.64463, stop_loss_n=0.64525, price_diff=0.00062, epsilon=0.00001
2025-06-23 11:35:52,630 - INFO - orders - [SLTP_DEBUG] BUY SL triggered: (adjusted_sell_price_n <= stop_loss_n)=True, (price_diff < epsilon)=False, sl_triggered=True
2025-06-23 11:35:52,630 - INFO - orders - [SLTP_CHECK] Order 4078720520 SL triggered: True, TP triggered: False
2025-06-23 11:35:52,631 - INFO - orders - [SLTP_TRIGGER] Triggering stop_loss for order 4078720520 (user 1, symbol AUDUSD, type BUY)
2025-06-23 11:35:52,664 - INFO - orders - [MARGIN_CONTRIB] Calculating total margin contribution for user 1, symbol AUDUSD, positions: 2
2025-06-23 11:35:52,669 - INFO - orders - [MARGIN_CONTRIB] User leverage: 100.00 (raw: 100.00)
2025-06-23 11:35:52,690 - INFO - orders - [SYMBOL_INFO] Retrieved external symbol info for AUDUSD: contract_size=100000.00000000, profit_currency=USD, digit=5.00000
2025-06-23 11:35:52,692 - INFO - orders - [MARGIN_CONTRIB] Position 1: type=BUY, quantity=0.01000000 (raw: 0.01000000), margin=6.46000000 (raw: 6.46000000)
2025-06-23 11:35:52,692 - INFO - orders - [MARGIN_CONTRIB] Position 1 margin per lot: 6.46000000 / 0.01000000 = 646 (rounded to 646.00000000)
2025-06-23 11:35:52,693 - INFO - orders - [MARGIN_CONTRIB] Position 2: type=BUY, quantity=0.01000000 (raw: 0.01000000), margin=6.45000000 (raw: 6.45000000)
2025-06-23 11:35:52,693 - INFO - orders - [MARGIN_CONTRIB] Position 2 margin per lot: 6.45000000 / 0.01000000 = 645 (rounded to 645.00000000)
2025-06-23 11:35:52,695 - INFO - orders - [MARGIN_CONTRIB] Total buy quantity: 0.02000000, Total sell quantity: 0.0, Net quantity: 0.02000000
2025-06-23 11:35:52,695 - INFO - orders - [MARGIN_CONTRIB] All margins per lot: [Decimal('646.00000000'), Decimal('645.00000000')], Highest margin per lot: 646.00000000
2025-06-23 11:35:52,695 - INFO - orders - [MARGIN_CONTRIB] Total margin calculation: 646.00000000 * 0.02000000 = 12.9200000000000000 (rounded to 12.92000000)
2025-06-23 11:35:52,696 - INFO - orders - [MARGIN_CONTRIB] Calculating total margin contribution for user 1, symbol AUDUSD, positions: 1
2025-06-23 11:35:52,702 - INFO - orders - [MARGIN_CONTRIB] User leverage: 100.00 (raw: 100.00)
2025-06-23 11:35:52,741 - INFO - orders - [SYMBOL_INFO] Retrieved external symbol info for AUDUSD: contract_size=100000.00000000, profit_currency=USD, digit=5.00000
2025-06-23 11:35:52,741 - INFO - orders - [MARGIN_CONTRIB] Position 1: type=BUY, quantity=0.01000000 (raw: 0.01000000), margin=6.45000000 (raw: 6.45000000)
2025-06-23 11:35:52,741 - INFO - orders - [MARGIN_CONTRIB] Position 1 margin per lot: 6.45000000 / 0.01000000 = 645 (rounded to 645.00000000)
2025-06-23 11:35:52,743 - INFO - orders - [MARGIN_CONTRIB] Total buy quantity: 0.01000000, Total sell quantity: 0.0, Net quantity: 0.01000000
2025-06-23 11:35:52,743 - INFO - orders - [MARGIN_CONTRIB] All margins per lot: [Decimal('645.00000000')], Highest margin per lot: 645.00000000
2025-06-23 11:35:52,744 - INFO - orders - [MARGIN_CONTRIB] Total margin calculation: 645.00000000 * 0.01000000 = 6.4500000000000000 (rounded to 6.45000000)
2025-06-23 11:35:52,794 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of -0.940000000000000000000000 USD to USD for PnL on Close (user_id: 1, position: 4078720520)
2025-06-23 11:35:52,794 - INFO - orders - [CURRENCY_CONVERT] Currency is already USD, no conversion needed
2025-06-23 11:35:52,852 - ERROR - orders - [SLTP_TRIGGER] Error processing SL/TP for order 4078720520: type object 'datetime.datetime' has no attribute 'datetime'
Traceback (most recent call last):
  File "C:\Users\Dhanush\FASTAPI\app\services\pending_orders.py", line 951, in process_order_stoploss_takeprofit
    transaction_time = datetime.datetime.now(datetime.timezone.utc)
                       ^^^^^^^^^^^^^^^^^
AttributeError: type object 'datetime.datetime' has no attribute 'datetime'
2025-06-23 11:35:52,908 - INFO - orders - [SLTP_FLOW] Skipping order 9941796348 as it is not OPEN (status=CLOSED)
2025-06-23 11:35:57,239 - INFO - orders - Found 0 pending order keys in Redis
2025-06-23 11:35:57,274 - DEBUG - orders - Completed SL/TP check cycle for 0 live orders and 0 demo orders
2025-06-23 11:36:02,335 - INFO - orders - Found 0 pending order keys in Redis
2025-06-23 11:36:02,349 - DEBUG - orders - Completed SL/TP check cycle for 0 live orders and 0 demo orders
2025-06-23 11:36:07,369 - INFO - orders - Found 0 pending order keys in Redis
2025-06-23 11:36:07,379 - DEBUG - orders - Completed SL/TP check cycle for 0 live orders and 0 demo orders
2025-06-23 11:36:12,385 - INFO - orders - Found 0 pending order keys in Redis
2025-06-23 11:36:12,392 - DEBUG - orders - Completed SL/TP check cycle for 0 live orders and 0 demo orders
2025-06-23 11:36:17,405 - INFO - orders - Found 0 pending order keys in Redis
2025-06-23 11:36:17,415 - DEBUG - orders - Completed SL/TP check cycle for 0 live orders and 0 demo orders
2025-06-23 11:36:22,699 - INFO - orders - Found 0 pending order keys in Redis
2025-06-23 11:36:22,705 - DEBUG - orders - Completed SL/TP check cycle for 0 live orders and 0 demo orders
2025-06-23 11:36:27,724 - INFO - orders - Found 0 pending order keys in Redis
2025-06-23 11:36:27,746 - DEBUG - orders - Completed SL/TP check cycle for 0 live orders and 0 demo orders
2025-06-23 11:36:32,709 - app.api.v1.endpoints.orders - INFO - [get_rejected_orders] user_type: demo
2025-06-23 11:36:33,439 - INFO - orders - Found 0 pending order keys in Redis
2025-06-23 11:36:33,446 - DEBUG - orders - Completed SL/TP check cycle for 0 live orders and 0 demo orders
2025-06-23 11:36:38,468 - INFO - orders - Found 0 pending order keys in Redis
2025-06-23 11:36:38,502 - DEBUG - orders - Completed SL/TP check cycle for 0 live orders and 0 demo orders
2025-06-23 11:36:43,514 - INFO - orders - Found 0 pending order keys in Redis
2025-06-23 11:36:43,524 - DEBUG - orders - Completed SL/TP check cycle for 0 live orders and 0 demo orders
2025-06-23 11:36:48,532 - INFO - orders - Found 0 pending order keys in Redis
2025-06-23 11:36:48,544 - DEBUG - orders - Completed SL/TP check cycle for 0 live orders and 0 demo orders
2025-06-23 11:36:54,498 - INFO - orders - Found 0 pending order keys in Redis
2025-06-23 11:36:54,505 - DEBUG - orders - Completed SL/TP check cycle for 0 live orders and 0 demo orders
2025-06-23 11:36:59,513 - INFO - orders - Found 0 pending order keys in Redis
2025-06-23 11:36:59,524 - DEBUG - orders - Completed SL/TP check cycle for 0 live orders and 0 demo orders
2025-06-23 11:37:09,317 - INFO - orders - Application starting up - Orders logging initialized
2025-06-23 11:37:25,089 - INFO - orders - Found 0 pending order keys in Redis
2025-06-23 11:37:25,257 - DEBUG - orders - Completed SL/TP check cycle for 0 live orders and 0 demo orders
2025-06-23 11:37:30,440 - INFO - orders - Found 0 pending order keys in Redis
2025-06-23 11:37:30,448 - DEBUG - orders - Completed SL/TP check cycle for 0 live orders and 0 demo orders
2025-06-23 11:37:35,617 - INFO - orders - Found 0 pending order keys in Redis
2025-06-23 11:37:35,627 - DEBUG - orders - Completed SL/TP check cycle for 0 live orders and 0 demo orders
2025-06-23 11:37:40,634 - INFO - orders - Found 0 pending order keys in Redis
2025-06-23 11:37:40,647 - DEBUG - orders - Completed SL/TP check cycle for 0 live orders and 0 demo orders
2025-06-23 11:37:45,655 - INFO - orders - Found 0 pending order keys in Redis
2025-06-23 11:37:45,664 - DEBUG - orders - Completed SL/TP check cycle for 0 live orders and 0 demo orders
2025-06-23 11:37:52,102 - INFO - orders - Application starting up - Orders logging initialized
2025-06-23 11:37:54,110 - INFO - orders - Found 0 pending order keys in Redis
2025-06-23 11:37:54,271 - DEBUG - orders - Completed SL/TP check cycle for 0 live orders and 0 demo orders
2025-06-23 11:37:59,288 - INFO - orders - Found 0 pending order keys in Redis
2025-06-23 11:37:59,364 - DEBUG - orders - Completed SL/TP check cycle for 0 live orders and 0 demo orders
2025-06-23 11:38:02,248 - app.api.v1.endpoints.orders - INFO - [get_rejected_orders] user_type: demo
2025-06-23 11:38:04,416 - INFO - orders - Found 0 pending order keys in Redis
2025-06-23 11:38:04,433 - DEBUG - orders - Completed SL/TP check cycle for 0 live orders and 0 demo orders
2025-06-23 11:38:09,447 - INFO - orders - Found 0 pending order keys in Redis
2025-06-23 11:38:09,463 - DEBUG - orders - Completed SL/TP check cycle for 0 live orders and 0 demo orders
2025-06-23 11:38:14,473 - INFO - orders - Found 0 pending order keys in Redis
2025-06-23 11:38:14,486 - DEBUG - orders - Completed SL/TP check cycle for 0 live orders and 0 demo orders
2025-06-23 11:38:19,496 - INFO - orders - Found 0 pending order keys in Redis
2025-06-23 11:38:19,500 - DEBUG - orders - Completed SL/TP check cycle for 0 live orders and 0 demo orders
2025-06-23 11:38:21,387 - INFO - orders - Order placement request received - User ID: 1, Symbol: AUDCHF, Type: BUY, Quantity: 0.01
2025-06-23 11:38:21,395 - INFO - orders - [DEBUG] group_settings_cache: {'sending_orders': 'barclays'}
2025-06-23 11:38:21,395 - INFO - orders - [DEBUG] sending_orders_cache value: barclays (type: <class 'str'>)
2025-06-23 11:38:21,395 - INFO - orders - Order placement: user_id=1, is_barclays_live_user=False, user_type=demo, group_name=Group B, sending_orders_setting=barclays
2025-06-23 11:38:22,808 - INFO - orders - [ORDER_MARGIN_CALC] Calculating margin for AUDCHF BUY order, quantity: 0.01
2025-06-23 11:38:22,809 - INFO - orders - [ORDER_MARGIN_CALC] Contract size for AUDCHF: 100000.00000000 (raw: 100000.00000000, type: <class 'decimal.Decimal'>)
2025-06-23 11:38:22,812 - INFO - orders - [ORDER_MARGIN_CALC] Got BUY price for AUDCHF from cache: 0.5242600000
2025-06-23 11:38:22,812 - INFO - orders - [ORDER_MARGIN_CALC] Contract value calculation for AUDCHF:
2025-06-23 11:38:22,813 - INFO - orders - [ORDER_MARGIN_CALC] Contract value = quantity * contract_size = 0.01 * 100000.00000000 = 1000.0000000000
2025-06-23 11:38:22,813 - INFO - orders - [ORDER_MARGIN_CALC] Margin calculation: (contract_value * price) / leverage = (1000.0000000000 * 0.5242600000) / 100.00 = 5.242600000000000000 (rounded to 5.24)
2025-06-23 11:38:22,813 - INFO - orders - [ORDER_MARGIN_CALC] Commission settings for AUDCHF: type=0, value_type=0, rate=10.0000
2025-06-23 11:38:22,813 - INFO - orders - [ORDER_MARGIN_CALC] Per lot commission: 0.01 * 10.0000 = 0.100000
2025-06-23 11:38:22,813 - INFO - orders - [ORDER_MARGIN_CALC] Profit currency for AUDCHF: CHF
2025-06-23 11:38:22,813 - INFO - orders - [ORDER_MARGIN_CALC] Converting margin from CHF to USD: 5.24 CHF
2025-06-23 11:38:22,813 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 5.24 CHF to USD for margin for AUDCHF BUY order (user_id: 1, position: )
2025-06-23 11:38:22,813 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CHFUSD
2025-06-23 11:38:22,815 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-06-23 11:38:22,816 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CHFUSD, trying inverse
2025-06-23 11:38:22,816 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCHF
2025-06-23 11:38:22,817 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('0.8124000000'), 'o': Decimal('0.8123300000')}
2025-06-23 11:38:22,817 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 0.8124000000
2025-06-23 11:38:22,817 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 5.24 CHF / 0.8124000000 = 6.450024618414574101427868045 USD
2025-06-23 11:38:22,817 - INFO - orders - [ORDER_MARGIN_CALC] Margin after USD conversion: 5.24 CHF -> 6.450024618414574101427868045 USD
2025-06-23 11:38:22,817 - INFO - orders - [ORDER_MARGIN_CALC] Final results for AUDCHF BUY: margin=6.450024618414574101427868045, price=0.5242600000, contract_value=1000.0000000000, commission=0.10
2025-06-23 11:38:22,817 - app.services.order_processing - INFO - [COMMISSION_CALC] User 1 Symbol AUDCHF: Calculated commission=0.10
2025-06-23 11:38:22,825 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_ENTRY] User 1, Symbol AUDCHF, Positions count: 0
2025-06-23 11:38:22,825 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB] No open positions for User 1, Symbol AUDCHF. Returning zero margin.
2025-06-23 11:38:22,825 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_ENTRY] User 1, Symbol AUDCHF, Positions count: 1
2025-06-23 11:38:22,826 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_POS_DETAIL] User 1, Symbol AUDCHF, Pos 1 (ID: NEW_UNSAVED): Type=BUY, Qty=0.01, StoredMargin=6.450024618414574101427868045
2025-06-23 11:38:22,826 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_POS_DETAIL] User 1, Symbol AUDCHF, Pos 1: MarginPerLot=645.0024618414574101427868045
2025-06-23 11:38:22,826 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDCHF: TotalBuyQty=0.01, TotalSellQty=0, NetQty=0.01
2025-06-23 11:38:22,826 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDCHF: AllMarginsPerLot=[Decimal('645.0024618414574101427868045')], HighestMarginPerLot=645.0024618414574101427868045
2025-06-23 11:38:22,826 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDCHF: CalculatedTotalMargin=6.45, ContributingOrders=1 (based on individual stored margins)
2025-06-23 11:38:22,827 - app.services.order_processing - INFO - [MARGIN_PROCESS] User 1 Symbol AUDCHF: MarginBefore=0.00, MarginAfter=6.45, AdditionalMargin=6.45
2025-06-23 11:38:22,848 - app.services.order_processing - INFO - [MARGIN_PROCESS] User 1: OriginalMarginDB=0E-8, CalculatedNewMargin=6.45
2025-06-23 11:38:22,918 - INFO - orders - [PRE-CRUD] About to call create_order with: {'order_id': '2716417609', 'order_status': 'OPEN', 'order_user_id': 1, 'order_company_name': 'AUDCHF', 'order_type': 'BUY', 'order_price': Decimal('0.5242600000'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('1000.0000000000'), 'margin': Decimal('6.450024618414574101427868045'), 'commission': Decimal('0.10'), 'stop_loss': None, 'take_profit': None, 'stoploss_id': None, 'takeprofit_id': None, 'status': 'OPEN'}
2025-06-23 11:38:22,977 - INFO - orders - [MARGIN_COMMIT_CHECK] User 1 margin in session BEFORE commit: 6.45000000
2025-06-23 11:38:23,064 - INFO - orders - User data cache updated for user 1 after placing order
2025-06-23 11:38:24,790 - INFO - orders - Portfolio cache updated and websocket event published for user 1 after placing order.
2025-06-23 11:38:24,791 - INFO - orders - Found 0 pending order keys in Redis
2025-06-23 11:38:24,802 - INFO - orders - Starting update_user_static_orders for user 1, user_type demo
2025-06-23 11:38:24,803 - INFO - orders - Using order model: DemoUserOrder
2025-06-23 11:38:24,850 - INFO - orders - Fetched 1 open orders for user 1
2025-06-23 11:38:24,872 - DEBUG - orders - Completed SL/TP check cycle for 0 live orders and 0 demo orders
2025-06-23 11:38:24,886 - INFO - orders - Fetched 0 pending orders for user 1
2025-06-23 11:38:24,915 - INFO - orders - Updated static orders cache for user 1 with 1 open orders and 0 pending orders
2025-06-23 11:38:30,237 - INFO - orders - Found 0 pending order keys in Redis
2025-06-23 11:38:30,263 - DEBUG - orders - Completed SL/TP check cycle for 0 live orders and 0 demo orders
2025-06-23 11:38:35,737 - INFO - orders - Found 0 pending order keys in Redis
2025-06-23 11:38:35,743 - DEBUG - orders - Completed SL/TP check cycle for 0 live orders and 0 demo orders
2025-06-23 11:38:38,580 - INFO - orders - Add stoploss request received - Order ID: 2716417609, User ID: 1
2025-06-23 11:38:38,591 - INFO - orders - Generated stoploss_id: 3826019517 for order 2716417609
2025-06-23 11:38:38,597 - INFO - orders - User 1 is_barclays_live_user: False
2025-06-23 11:38:38,597 - INFO - orders - Non-Barclays user. Adding stoploss to order 2716417609 immediately
2025-06-23 11:38:38,631 - INFO - orders - Starting update_user_static_orders for user 1, user_type demo
2025-06-23 11:38:38,631 - INFO - orders - Using order model: DemoUserOrder
2025-06-23 11:38:38,638 - INFO - orders - Fetched 1 open orders for user 1
2025-06-23 11:38:38,644 - INFO - orders - Fetched 0 pending orders for user 1
2025-06-23 11:38:38,648 - INFO - orders - Updated static orders cache for user 1 with 1 open orders and 0 pending orders
2025-06-23 11:38:40,751 - INFO - orders - Found 0 pending order keys in Redis
2025-06-23 11:38:40,765 - INFO - orders - [SLTP_CHECK] Checking order 2716417609: symbol=AUDCHF, type=BUY, stop_loss=0.52377000, take_profit=None, user_id=1
2025-06-23 11:38:40,774 - INFO - orders - [SLTP_DEBUG] Types: adjusted_sell_price_n=<class 'decimal.Decimal'>, stop_loss_n=<class 'decimal.Decimal'>, adjusted_buy_price_n=<class 'decimal.Decimal'>, take_profit_n=<class 'NoneType'>
2025-06-23 11:38:40,774 - INFO - orders - [SLTP_DEBUG] Values: adjusted_sell_price_n=0.52379, stop_loss_n=0.52377, adjusted_buy_price_n=0.52427, take_profit_n=None
2025-06-23 11:38:40,774 - INFO - orders - [SLTP_DEBUG] BUY SL: adjusted_sell_price_n=0.52379, stop_loss_n=0.52377, price_diff=0.00002, epsilon=0.00001
2025-06-23 11:38:40,774 - INFO - orders - [SLTP_DEBUG] BUY SL triggered: (adjusted_sell_price_n <= stop_loss_n)=False, (price_diff < epsilon)=False, sl_triggered=False
2025-06-23 11:38:40,774 - INFO - orders - [SLTP_CHECK] Order 2716417609 SL triggered: False, TP triggered: False
2025-06-23 11:38:40,775 - INFO - orders - [SLTP_CHECK] No SL/TP trigger for order 2716417609. Skipping.
2025-06-23 11:38:40,775 - DEBUG - orders - Completed SL/TP check cycle for 0 live orders and 1 demo orders
2025-06-23 11:38:45,784 - INFO - orders - Found 0 pending order keys in Redis
2025-06-23 11:38:45,791 - INFO - orders - [SLTP_CHECK] Checking order 2716417609: symbol=AUDCHF, type=BUY, stop_loss=0.52377000, take_profit=None, user_id=1
2025-06-23 11:38:45,796 - INFO - orders - [SLTP_DEBUG] Types: adjusted_sell_price_n=<class 'decimal.Decimal'>, stop_loss_n=<class 'decimal.Decimal'>, adjusted_buy_price_n=<class 'decimal.Decimal'>, take_profit_n=<class 'NoneType'>
2025-06-23 11:38:45,796 - INFO - orders - [SLTP_DEBUG] Values: adjusted_sell_price_n=0.52378, stop_loss_n=0.52377, adjusted_buy_price_n=0.52427, take_profit_n=None
2025-06-23 11:38:45,796 - INFO - orders - [SLTP_DEBUG] BUY SL: adjusted_sell_price_n=0.52378, stop_loss_n=0.52377, price_diff=0.00001, epsilon=0.00001
2025-06-23 11:38:45,796 - INFO - orders - [SLTP_DEBUG] BUY SL triggered: (adjusted_sell_price_n <= stop_loss_n)=False, (price_diff < epsilon)=False, sl_triggered=False
2025-06-23 11:38:45,796 - INFO - orders - [SLTP_CHECK] Order 2716417609 SL triggered: False, TP triggered: False
2025-06-23 11:38:45,796 - INFO - orders - [SLTP_CHECK] No SL/TP trigger for order 2716417609. Skipping.
2025-06-23 11:38:45,796 - DEBUG - orders - Completed SL/TP check cycle for 0 live orders and 1 demo orders
2025-06-23 11:38:50,804 - INFO - orders - Found 0 pending order keys in Redis
2025-06-23 11:38:50,813 - INFO - orders - [SLTP_CHECK] Checking order 2716417609: symbol=AUDCHF, type=BUY, stop_loss=0.52377000, take_profit=None, user_id=1
2025-06-23 11:38:50,819 - INFO - orders - [SLTP_DEBUG] Types: adjusted_sell_price_n=<class 'decimal.Decimal'>, stop_loss_n=<class 'decimal.Decimal'>, adjusted_buy_price_n=<class 'decimal.Decimal'>, take_profit_n=<class 'NoneType'>
2025-06-23 11:38:50,819 - INFO - orders - [SLTP_DEBUG] Values: adjusted_sell_price_n=0.52379, stop_loss_n=0.52377, adjusted_buy_price_n=0.52429, take_profit_n=None
2025-06-23 11:38:50,819 - INFO - orders - [SLTP_DEBUG] BUY SL: adjusted_sell_price_n=0.52379, stop_loss_n=0.52377, price_diff=0.00002, epsilon=0.00001
2025-06-23 11:38:50,819 - INFO - orders - [SLTP_DEBUG] BUY SL triggered: (adjusted_sell_price_n <= stop_loss_n)=False, (price_diff < epsilon)=False, sl_triggered=False
2025-06-23 11:38:50,820 - INFO - orders - [SLTP_CHECK] Order 2716417609 SL triggered: False, TP triggered: False
2025-06-23 11:38:50,820 - INFO - orders - [SLTP_CHECK] No SL/TP trigger for order 2716417609. Skipping.
2025-06-23 11:38:50,820 - DEBUG - orders - Completed SL/TP check cycle for 0 live orders and 1 demo orders
2025-06-23 11:38:52,889 - INFO - orders - [PENDING_ORDER_EXECUTION][PORTFOLIO_UPDATE] user_id=1, user_type=demo, group_name=Group B, free_margin=18757.94146725750861644510094, margin_level=290920.7979419768777743426502, balance=18765.07000000, equity=18764.39146725750861644510094
2025-06-23 11:38:56,157 - INFO - orders - Found 0 pending order keys in Redis
2025-06-23 11:38:56,169 - INFO - orders - [SLTP_CHECK] Checking order 2716417609: symbol=AUDCHF, type=BUY, stop_loss=0.52377000, take_profit=None, user_id=1
2025-06-23 11:38:56,176 - INFO - orders - [SLTP_DEBUG] Types: adjusted_sell_price_n=<class 'decimal.Decimal'>, stop_loss_n=<class 'decimal.Decimal'>, adjusted_buy_price_n=<class 'decimal.Decimal'>, take_profit_n=<class 'NoneType'>
2025-06-23 11:38:56,177 - INFO - orders - [SLTP_DEBUG] Values: adjusted_sell_price_n=0.52377, stop_loss_n=0.52377, adjusted_buy_price_n=0.52426, take_profit_n=None
2025-06-23 11:38:56,177 - INFO - orders - [SLTP_DEBUG] BUY SL: adjusted_sell_price_n=0.52377, stop_loss_n=0.52377, price_diff=0.00000, epsilon=0.00001
2025-06-23 11:38:56,177 - INFO - orders - [SLTP_DEBUG] BUY SL triggered: (adjusted_sell_price_n <= stop_loss_n)=True, (price_diff < epsilon)=True, sl_triggered=True
2025-06-23 11:38:56,177 - INFO - orders - [SLTP_CHECK] Order 2716417609 SL triggered: True, TP triggered: False
2025-06-23 11:38:56,177 - INFO - orders - [SLTP_TRIGGER] Triggering stop_loss for order 2716417609 (user 1, symbol AUDCHF, type BUY)
2025-06-23 11:38:56,189 - INFO - orders - [MARGIN_CONTRIB] Calculating total margin contribution for user 1, symbol AUDCHF, positions: 1
2025-06-23 11:38:56,192 - INFO - orders - [MARGIN_CONTRIB] User leverage: 100.00 (raw: 100.00)
2025-06-23 11:38:56,200 - INFO - orders - [SYMBOL_INFO] Retrieved external symbol info for AUDCHF: contract_size=100000.00000000, profit_currency=CHF, digit=5.00000
2025-06-23 11:38:56,201 - INFO - orders - [MARGIN_CONTRIB] Position 1: type=BUY, quantity=0.01000000 (raw: 0.01000000), margin=6.45002462 (raw: 6.45002462)
2025-06-23 11:38:56,201 - INFO - orders - [MARGIN_CONTRIB] Position 1 margin per lot: 6.45002462 / 0.01000000 = 645.002462 (rounded to 645.00246200)
2025-06-23 11:38:56,201 - INFO - orders - [MARGIN_CONTRIB] Total buy quantity: 0.01000000, Total sell quantity: 0.0, Net quantity: 0.01000000
2025-06-23 11:38:56,201 - INFO - orders - [MARGIN_CONTRIB] All margins per lot: [Decimal('645.00246200')], Highest margin per lot: 645.00246200
2025-06-23 11:38:56,201 - INFO - orders - [MARGIN_CONTRIB] Total margin calculation: 645.00246200 * 0.01000000 = 6.4500246200000000 (rounded to 6.45002462)
2025-06-23 11:38:56,201 - INFO - orders - [MARGIN_CONTRIB] Calculating total margin contribution for user 1, symbol AUDCHF, positions: 0
2025-06-23 11:38:56,203 - INFO - orders - [MARGIN_CONTRIB] User leverage: 100.00 (raw: 100.00)
2025-06-23 11:38:56,210 - INFO - orders - [SYMBOL_INFO] Retrieved external symbol info for AUDCHF: contract_size=100000.00000000, profit_currency=CHF, digit=5.00000
2025-06-23 11:38:56,210 - INFO - orders - [MARGIN_CONTRIB] Total buy quantity: 0.0, Total sell quantity: 0.0, Net quantity: 0.0
2025-06-23 11:38:56,210 - INFO - orders - [MARGIN_CONTRIB] All margins per lot: [], Highest margin per lot: 0.0
2025-06-23 11:38:56,210 - INFO - orders - [MARGIN_CONTRIB] Total margin calculation: 0.0 * 0.0 = 0.00 (rounded to 0E-8)
2025-06-23 11:38:56,222 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of -0.490000000000000000000000 CHF to USD for PnL on Close (user_id: 1, position: 2716417609)
2025-06-23 11:38:56,222 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CHFUSD
2025-06-23 11:38:56,224 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-06-23 11:38:56,225 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CHFUSD, trying inverse
2025-06-23 11:38:56,225 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCHF
2025-06-23 11:38:56,228 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('0.8123000000'), 'o': Decimal('0.8122400000')}
2025-06-23 11:38:56,228 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 0.8123000000
2025-06-23 11:38:56,228 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: -0.490000000000000000000000 CHF / 0.8123000000 = -0.6032254093315277606795518897 USD
2025-06-23 11:38:56,310 - INFO - orders - Starting update_user_static_orders for user 1, user_type demo
2025-06-23 11:38:56,310 - INFO - orders - Using order model: DemoUserOrder
2025-06-23 11:38:56,317 - INFO - orders - Fetched 0 open orders for user 1
2025-06-23 11:38:56,324 - INFO - orders - Fetched 0 pending orders for user 1
2025-06-23 11:38:56,327 - INFO - orders - Updated static orders cache for user 1 with 0 open orders and 0 pending orders
2025-06-23 11:38:56,347 - INFO - orders - [SLTP_TRIGGER] Successfully closed order 2716417609 due to stop_loss trigger with robust margin/wallet logic.
2025-06-23 11:38:56,347 - DEBUG - orders - Completed SL/TP check cycle for 0 live orders and 1 demo orders
2025-06-23 11:39:01,363 - INFO - orders - Found 0 pending order keys in Redis
2025-06-23 11:39:01,373 - DEBUG - orders - Completed SL/TP check cycle for 0 live orders and 0 demo orders
2025-06-23 11:39:06,389 - INFO - orders - Found 0 pending order keys in Redis
2025-06-23 11:39:06,408 - DEBUG - orders - Completed SL/TP check cycle for 0 live orders and 0 demo orders
2025-06-23 11:39:11,420 - INFO - orders - Found 0 pending order keys in Redis
2025-06-23 11:39:11,440 - DEBUG - orders - Completed SL/TP check cycle for 0 live orders and 0 demo orders
2025-06-23 11:39:11,565 - app.api.v1.endpoints.orders - INFO - [get_rejected_orders] user_type: demo
2025-06-23 11:39:16,455 - INFO - orders - Found 0 pending order keys in Redis
2025-06-23 11:39:16,487 - DEBUG - orders - Completed SL/TP check cycle for 0 live orders and 0 demo orders
2025-06-23 11:39:21,508 - INFO - orders - Found 0 pending order keys in Redis
2025-06-23 11:39:21,550 - DEBUG - orders - Completed SL/TP check cycle for 0 live orders and 0 demo orders
2025-06-23 11:39:24,459 - INFO - orders - Order placement request received - User ID: 1, Symbol: AUDCAD, Type: BUY, Quantity: 0.01
2025-06-23 11:39:24,479 - INFO - orders - [DEBUG] group_settings_cache: {'sending_orders': 'barclays'}
2025-06-23 11:39:24,479 - INFO - orders - [DEBUG] sending_orders_cache value: barclays (type: <class 'str'>)
2025-06-23 11:39:24,479 - INFO - orders - Order placement: user_id=1, is_barclays_live_user=False, user_type=demo, group_name=Group B, sending_orders_setting=barclays
2025-06-23 11:39:25,267 - INFO - orders - [ORDER_MARGIN_CALC] Calculating margin for AUDCAD BUY order, quantity: 0.01
2025-06-23 11:39:25,267 - INFO - orders - [ORDER_MARGIN_CALC] Contract size for AUDCAD: 100000.00000000 (raw: 100000.00000000, type: <class 'decimal.Decimal'>)
2025-06-23 11:39:25,273 - INFO - orders - [ORDER_MARGIN_CALC] Got BUY price for AUDCAD from cache: 0.8868400000
2025-06-23 11:39:25,273 - INFO - orders - [ORDER_MARGIN_CALC] Contract value calculation for AUDCAD:
2025-06-23 11:39:25,273 - INFO - orders - [ORDER_MARGIN_CALC] Contract value = quantity * contract_size = 0.01 * 100000.00000000 = 1000.0000000000
2025-06-23 11:39:25,274 - INFO - orders - [ORDER_MARGIN_CALC] Margin calculation: (contract_value * price) / leverage = (1000.0000000000 * 0.8868400000) / 100.00 = 8.868400000000000000 (rounded to 8.87)
2025-06-23 11:39:25,274 - INFO - orders - [ORDER_MARGIN_CALC] Commission settings for AUDCAD: type=0, value_type=0, rate=10.0000
2025-06-23 11:39:25,274 - INFO - orders - [ORDER_MARGIN_CALC] Per lot commission: 0.01 * 10.0000 = 0.100000
2025-06-23 11:39:25,274 - INFO - orders - [ORDER_MARGIN_CALC] Profit currency for AUDCAD: CAD
2025-06-23 11:39:25,274 - INFO - orders - [ORDER_MARGIN_CALC] Converting margin from CAD to USD: 8.87 CAD
2025-06-23 11:39:25,274 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 8.87 CAD to USD for margin for AUDCAD BUY order (user_id: 1, position: )
2025-06-23 11:39:25,274 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CADUSD
2025-06-23 11:39:25,277 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-06-23 11:39:25,277 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CADUSD, trying inverse
2025-06-23 11:39:25,277 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCAD
2025-06-23 11:39:25,280 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('1.3744100000'), 'o': Decimal('1.3743300000')}
2025-06-23 11:39:25,280 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 1.3744100000
2025-06-23 11:39:25,281 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 8.87 CAD / 1.3744100000 = 6.453678305600221185817914596 USD
2025-06-23 11:39:25,281 - INFO - orders - [ORDER_MARGIN_CALC] Margin after USD conversion: 8.87 CAD -> 6.453678305600221185817914596 USD
2025-06-23 11:39:25,281 - INFO - orders - [ORDER_MARGIN_CALC] Final results for AUDCAD BUY: margin=6.453678305600221185817914596, price=0.8868400000, contract_value=1000.0000000000, commission=0.10
2025-06-23 11:39:25,281 - app.services.order_processing - INFO - [COMMISSION_CALC] User 1 Symbol AUDCAD: Calculated commission=0.10
2025-06-23 11:39:25,299 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_ENTRY] User 1, Symbol AUDCAD, Positions count: 0
2025-06-23 11:39:25,302 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB] No open positions for User 1, Symbol AUDCAD. Returning zero margin.
2025-06-23 11:39:25,303 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_ENTRY] User 1, Symbol AUDCAD, Positions count: 1
2025-06-23 11:39:25,303 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_POS_DETAIL] User 1, Symbol AUDCAD, Pos 1 (ID: NEW_UNSAVED): Type=BUY, Qty=0.01, StoredMargin=6.453678305600221185817914596
2025-06-23 11:39:25,303 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_POS_DETAIL] User 1, Symbol AUDCAD, Pos 1: MarginPerLot=645.3678305600221185817914596
2025-06-23 11:39:25,303 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDCAD: TotalBuyQty=0.01, TotalSellQty=0, NetQty=0.01
2025-06-23 11:39:25,303 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_CALC] User 1, Symbol AUDCAD: AllMarginsPerLot=[Decimal('645.3678305600221185817914596')], HighestMarginPerLot=645.3678305600221185817914596
2025-06-23 11:39:25,303 - app.services.order_processing - DEBUG - [MARGIN_TOTAL_CONTRIB_EXIT] User 1, Symbol AUDCAD: CalculatedTotalMargin=6.45, ContributingOrders=1 (based on individual stored margins)
2025-06-23 11:39:25,303 - app.services.order_processing - INFO - [MARGIN_PROCESS] User 1 Symbol AUDCAD: MarginBefore=0.00, MarginAfter=6.45, AdditionalMargin=6.45
2025-06-23 11:39:25,325 - app.services.order_processing - INFO - [MARGIN_PROCESS] User 1: OriginalMarginDB=0E-8, CalculatedNewMargin=6.45
2025-06-23 11:39:25,476 - INFO - orders - [PRE-CRUD] About to call create_order with: {'order_id': '9253747588', 'order_status': 'OPEN', 'order_user_id': 1, 'order_company_name': 'AUDCAD', 'order_type': 'BUY', 'order_price': Decimal('0.8868400000'), 'order_quantity': Decimal('0.01'), 'contract_value': Decimal('1000.0000000000'), 'margin': Decimal('6.453678305600221185817914596'), 'commission': Decimal('0.10'), 'stop_loss': None, 'take_profit': None, 'stoploss_id': None, 'takeprofit_id': None, 'status': 'OPEN'}
2025-06-23 11:39:25,616 - INFO - orders - [MARGIN_COMMIT_CHECK] User 1 margin in session BEFORE commit: 6.45000000
2025-06-23 11:39:25,693 - INFO - orders - User data cache updated for user 1 after placing order
2025-06-23 11:39:27,406 - INFO - orders - Found 0 pending order keys in Redis
2025-06-23 11:39:27,947 - DEBUG - orders - Completed SL/TP check cycle for 0 live orders and 0 demo orders
2025-06-23 11:39:27,952 - INFO - orders - Portfolio cache updated and websocket event published for user 1 after placing order.
2025-06-23 11:39:27,978 - INFO - orders - Starting update_user_static_orders for user 1, user_type demo
2025-06-23 11:39:27,978 - INFO - orders - Using order model: DemoUserOrder
2025-06-23 11:39:28,004 - INFO - orders - Fetched 1 open orders for user 1
2025-06-23 11:39:28,024 - INFO - orders - Fetched 0 pending orders for user 1
2025-06-23 11:39:28,036 - INFO - orders - Updated static orders cache for user 1 with 1 open orders and 0 pending orders
2025-06-23 11:39:32,974 - INFO - orders - Found 0 pending order keys in Redis
2025-06-23 11:39:33,055 - DEBUG - orders - Completed SL/TP check cycle for 0 live orders and 0 demo orders
2025-06-23 11:39:37,591 - INFO - orders - Add stoploss request received - Order ID: 9253747588, User ID: 1
2025-06-23 11:39:37,676 - INFO - orders - Generated stoploss_id: 5226762037 for order 9253747588
2025-06-23 11:39:37,717 - INFO - orders - User 1 is_barclays_live_user: False
2025-06-23 11:39:37,717 - INFO - orders - Non-Barclays user. Adding stoploss to order 9253747588 immediately
2025-06-23 11:39:37,798 - INFO - orders - Starting update_user_static_orders for user 1, user_type demo
2025-06-23 11:39:37,800 - INFO - orders - Using order model: DemoUserOrder
2025-06-23 11:39:37,833 - INFO - orders - Fetched 1 open orders for user 1
2025-06-23 11:39:37,883 - INFO - orders - Fetched 0 pending orders for user 1
2025-06-23 11:39:37,896 - INFO - orders - Updated static orders cache for user 1 with 1 open orders and 0 pending orders
2025-06-23 11:39:38,147 - INFO - orders - Found 0 pending order keys in Redis
2025-06-23 11:39:38,239 - INFO - orders - [SLTP_CHECK] Checking order 9253747588: symbol=AUDCAD, type=BUY, stop_loss=0.88674000, take_profit=None, user_id=1
2025-06-23 11:39:38,338 - INFO - orders - [SLTP_DEBUG] Types: adjusted_sell_price_n=<class 'decimal.Decimal'>, stop_loss_n=<class 'decimal.Decimal'>, adjusted_buy_price_n=<class 'decimal.Decimal'>, take_profit_n=<class 'NoneType'>
2025-06-23 11:39:38,338 - INFO - orders - [SLTP_DEBUG] Values: adjusted_sell_price_n=0.88677, stop_loss_n=0.88674, adjusted_buy_price_n=0.88687, take_profit_n=None
2025-06-23 11:39:38,338 - INFO - orders - [SLTP_DEBUG] BUY SL: adjusted_sell_price_n=0.88677, stop_loss_n=0.88674, price_diff=0.00003, epsilon=0.00001
2025-06-23 11:39:38,338 - INFO - orders - [SLTP_DEBUG] BUY SL triggered: (adjusted_sell_price_n <= stop_loss_n)=False, (price_diff < epsilon)=False, sl_triggered=False
2025-06-23 11:39:38,339 - INFO - orders - [SLTP_CHECK] Order 9253747588 SL triggered: False, TP triggered: False
2025-06-23 11:39:38,339 - INFO - orders - [SLTP_CHECK] No SL/TP trigger for order 9253747588. Skipping.
2025-06-23 11:39:38,339 - DEBUG - orders - Completed SL/TP check cycle for 0 live orders and 1 demo orders
2025-06-23 11:39:43,410 - INFO - orders - Found 0 pending order keys in Redis
2025-06-23 11:39:43,465 - INFO - orders - [SLTP_CHECK] Checking order 9253747588: symbol=AUDCAD, type=BUY, stop_loss=0.88674000, take_profit=None, user_id=1
2025-06-23 11:39:43,493 - INFO - orders - [SLTP_DEBUG] Types: adjusted_sell_price_n=<class 'decimal.Decimal'>, stop_loss_n=<class 'decimal.Decimal'>, adjusted_buy_price_n=<class 'decimal.Decimal'>, take_profit_n=<class 'NoneType'>
2025-06-23 11:39:43,493 - INFO - orders - [SLTP_DEBUG] Values: adjusted_sell_price_n=0.88680, stop_loss_n=0.88674, adjusted_buy_price_n=0.88688, take_profit_n=None
2025-06-23 11:39:43,494 - INFO - orders - [SLTP_DEBUG] BUY SL: adjusted_sell_price_n=0.88680, stop_loss_n=0.88674, price_diff=0.00006, epsilon=0.00001
2025-06-23 11:39:43,494 - INFO - orders - [SLTP_DEBUG] BUY SL triggered: (adjusted_sell_price_n <= stop_loss_n)=False, (price_diff < epsilon)=False, sl_triggered=False
2025-06-23 11:39:43,494 - INFO - orders - [SLTP_CHECK] Order 9253747588 SL triggered: False, TP triggered: False
2025-06-23 11:39:43,494 - INFO - orders - [SLTP_CHECK] No SL/TP trigger for order 9253747588. Skipping.
2025-06-23 11:39:43,494 - DEBUG - orders - Completed SL/TP check cycle for 0 live orders and 1 demo orders
2025-06-23 11:39:48,518 - INFO - orders - Found 0 pending order keys in Redis
2025-06-23 11:39:48,550 - INFO - orders - [SLTP_CHECK] Checking order 9253747588: symbol=AUDCAD, type=BUY, stop_loss=0.88674000, take_profit=None, user_id=1
2025-06-23 11:39:48,565 - INFO - orders - [SLTP_DEBUG] Types: adjusted_sell_price_n=<class 'decimal.Decimal'>, stop_loss_n=<class 'decimal.Decimal'>, adjusted_buy_price_n=<class 'decimal.Decimal'>, take_profit_n=<class 'NoneType'>
2025-06-23 11:39:48,565 - INFO - orders - [SLTP_DEBUG] Values: adjusted_sell_price_n=0.88683, stop_loss_n=0.88674, adjusted_buy_price_n=0.88692, take_profit_n=None
2025-06-23 11:39:48,566 - INFO - orders - [SLTP_DEBUG] BUY SL: adjusted_sell_price_n=0.88683, stop_loss_n=0.88674, price_diff=0.00009, epsilon=0.00001
2025-06-23 11:39:48,566 - INFO - orders - [SLTP_DEBUG] BUY SL triggered: (adjusted_sell_price_n <= stop_loss_n)=False, (price_diff < epsilon)=False, sl_triggered=False
2025-06-23 11:39:48,566 - INFO - orders - [SLTP_CHECK] Order 9253747588 SL triggered: False, TP triggered: False
2025-06-23 11:39:48,566 - INFO - orders - [SLTP_CHECK] No SL/TP trigger for order 9253747588. Skipping.
2025-06-23 11:39:48,566 - DEBUG - orders - Completed SL/TP check cycle for 0 live orders and 1 demo orders
2025-06-23 11:39:54,009 - INFO - orders - Found 0 pending order keys in Redis
2025-06-23 11:39:54,015 - INFO - orders - [PENDING_ORDER_EXECUTION][PORTFOLIO_UPDATE] user_id=1, user_type=demo, group_name=Group B, free_margin=18757.72727648458476740717025, margin_level=290917.4771547997638357700814, balance=18764.27000000, equity=18764.17727648458476740717025
2025-06-23 11:39:54,038 - INFO - orders - [SLTP_CHECK] Checking order 9253747588: symbol=AUDCAD, type=BUY, stop_loss=0.88674000, take_profit=None, user_id=1
2025-06-23 11:39:54,088 - INFO - orders - [SLTP_DEBUG] Types: adjusted_sell_price_n=<class 'decimal.Decimal'>, stop_loss_n=<class 'decimal.Decimal'>, adjusted_buy_price_n=<class 'decimal.Decimal'>, take_profit_n=<class 'NoneType'>
2025-06-23 11:39:54,089 - INFO - orders - [SLTP_DEBUG] Values: adjusted_sell_price_n=0.88685, stop_loss_n=0.88674, adjusted_buy_price_n=0.88691, take_profit_n=None
2025-06-23 11:39:54,090 - INFO - orders - [SLTP_DEBUG] BUY SL: adjusted_sell_price_n=0.88685, stop_loss_n=0.88674, price_diff=0.00011, epsilon=0.00001
2025-06-23 11:39:54,091 - INFO - orders - [SLTP_DEBUG] BUY SL triggered: (adjusted_sell_price_n <= stop_loss_n)=False, (price_diff < epsilon)=False, sl_triggered=False
2025-06-23 11:39:54,091 - INFO - orders - [SLTP_CHECK] Order 9253747588 SL triggered: False, TP triggered: False
2025-06-23 11:39:54,091 - INFO - orders - [SLTP_CHECK] No SL/TP trigger for order 9253747588. Skipping.
2025-06-23 11:39:54,092 - DEBUG - orders - Completed SL/TP check cycle for 0 live orders and 1 demo orders
2025-06-23 11:39:59,165 - INFO - orders - Found 0 pending order keys in Redis
2025-06-23 11:39:59,187 - INFO - orders - [SLTP_CHECK] Checking order 9253747588: symbol=AUDCAD, type=BUY, stop_loss=0.88674000, take_profit=None, user_id=1
2025-06-23 11:39:59,644 - INFO - orders - [SLTP_DEBUG] Types: adjusted_sell_price_n=<class 'decimal.Decimal'>, stop_loss_n=<class 'decimal.Decimal'>, adjusted_buy_price_n=<class 'decimal.Decimal'>, take_profit_n=<class 'NoneType'>
2025-06-23 11:39:59,644 - INFO - orders - [SLTP_DEBUG] Values: adjusted_sell_price_n=0.88683, stop_loss_n=0.88674, adjusted_buy_price_n=0.88692, take_profit_n=None
2025-06-23 11:39:59,644 - INFO - orders - [SLTP_DEBUG] BUY SL: adjusted_sell_price_n=0.88683, stop_loss_n=0.88674, price_diff=0.00009, epsilon=0.00001
2025-06-23 11:39:59,644 - INFO - orders - [SLTP_DEBUG] BUY SL triggered: (adjusted_sell_price_n <= stop_loss_n)=False, (price_diff < epsilon)=False, sl_triggered=False
2025-06-23 11:39:59,644 - INFO - orders - [SLTP_CHECK] Order 9253747588 SL triggered: False, TP triggered: False
2025-06-23 11:39:59,644 - INFO - orders - [SLTP_CHECK] No SL/TP trigger for order 9253747588. Skipping.
2025-06-23 11:39:59,645 - DEBUG - orders - Completed SL/TP check cycle for 0 live orders and 1 demo orders
2025-06-23 11:39:59,897 - INFO - orders - Add takeprofit request received - Order ID: 9253747588, User ID: 1
2025-06-23 11:39:59,920 - INFO - orders - Generated takeprofit_id: 2807410298 for order 9253747588
2025-06-23 11:39:59,939 - INFO - orders - User 1 is_barclays_live_user: False
2025-06-23 11:39:59,939 - INFO - orders - Non-Barclays user. Adding takeprofit to order 9253747588 immediately
2025-06-23 11:40:00,076 - INFO - orders - Starting update_user_static_orders for user 1, user_type demo
2025-06-23 11:40:00,077 - INFO - orders - Using order model: DemoUserOrder
2025-06-23 11:40:00,141 - INFO - orders - Fetched 1 open orders for user 1
2025-06-23 11:40:00,181 - INFO - orders - Fetched 0 pending orders for user 1
2025-06-23 11:40:00,190 - INFO - orders - Updated static orders cache for user 1 with 1 open orders and 0 pending orders
2025-06-23 11:40:04,892 - INFO - orders - Found 0 pending order keys in Redis
2025-06-23 11:40:04,926 - INFO - orders - [SLTP_CHECK] Checking order 9253747588: symbol=AUDCAD, type=BUY, stop_loss=0.88674000, take_profit=0.88685000, user_id=1
2025-06-23 11:40:04,967 - INFO - orders - [SLTP_DEBUG] Types: adjusted_sell_price_n=<class 'decimal.Decimal'>, stop_loss_n=<class 'decimal.Decimal'>, adjusted_buy_price_n=<class 'decimal.Decimal'>, take_profit_n=<class 'decimal.Decimal'>
2025-06-23 11:40:04,969 - INFO - orders - [SLTP_DEBUG] Values: adjusted_sell_price_n=0.88684, stop_loss_n=0.88674, adjusted_buy_price_n=0.88694, take_profit_n=0.88685
2025-06-23 11:40:04,969 - INFO - orders - [SLTP_DEBUG] BUY SL: adjusted_sell_price_n=0.88684, stop_loss_n=0.88674, price_diff=0.00010, epsilon=0.00001
2025-06-23 11:40:04,970 - INFO - orders - [SLTP_DEBUG] BUY SL triggered: (adjusted_sell_price_n <= stop_loss_n)=False, (price_diff < epsilon)=False, sl_triggered=False
2025-06-23 11:40:04,970 - INFO - orders - [SLTP_DEBUG] BUY TP: adjusted_sell_price_n=0.88684, take_profit_n=0.88685, price_diff=0.00001, epsilon=0.00001
2025-06-23 11:40:04,970 - INFO - orders - [SLTP_DEBUG] BUY TP triggered: (adjusted_sell_price_n >= take_profit_n)=False, (price_diff < epsilon)=False, tp_triggered=False
2025-06-23 11:40:04,970 - INFO - orders - [SLTP_CHECK] Order 9253747588 SL triggered: False, TP triggered: False
2025-06-23 11:40:04,970 - INFO - orders - [SLTP_CHECK] No SL/TP trigger for order 9253747588. Skipping.
2025-06-23 11:40:04,970 - DEBUG - orders - Completed SL/TP check cycle for 0 live orders and 1 demo orders
2025-06-23 11:40:10,286 - INFO - orders - Found 0 pending order keys in Redis
2025-06-23 11:40:10,314 - INFO - orders - [SLTP_CHECK] Checking order 9253747588: symbol=AUDCAD, type=BUY, stop_loss=0.88674000, take_profit=0.88685000, user_id=1
2025-06-23 11:40:10,324 - INFO - orders - [SLTP_DEBUG] Types: adjusted_sell_price_n=<class 'decimal.Decimal'>, stop_loss_n=<class 'decimal.Decimal'>, adjusted_buy_price_n=<class 'decimal.Decimal'>, take_profit_n=<class 'decimal.Decimal'>
2025-06-23 11:40:10,325 - INFO - orders - [SLTP_DEBUG] Values: adjusted_sell_price_n=0.88689, stop_loss_n=0.88674, adjusted_buy_price_n=0.88699, take_profit_n=0.88685
2025-06-23 11:40:10,325 - INFO - orders - [SLTP_DEBUG] BUY SL: adjusted_sell_price_n=0.88689, stop_loss_n=0.88674, price_diff=0.00015, epsilon=0.00001
2025-06-23 11:40:10,325 - INFO - orders - [SLTP_DEBUG] BUY SL triggered: (adjusted_sell_price_n <= stop_loss_n)=False, (price_diff < epsilon)=False, sl_triggered=False
2025-06-23 11:40:10,325 - INFO - orders - [SLTP_DEBUG] BUY TP: adjusted_sell_price_n=0.88689, take_profit_n=0.88685, price_diff=0.00004, epsilon=0.00001
2025-06-23 11:40:10,325 - INFO - orders - [SLTP_DEBUG] BUY TP triggered: (adjusted_sell_price_n >= take_profit_n)=True, (price_diff < epsilon)=False, tp_triggered=True
2025-06-23 11:40:10,325 - INFO - orders - [SLTP_CHECK] Order 9253747588 SL triggered: False, TP triggered: True
2025-06-23 11:40:10,325 - INFO - orders - [SLTP_TRIGGER] Triggering take_profit for order 9253747588 (user 1, symbol AUDCAD, type BUY)
2025-06-23 11:40:10,413 - INFO - orders - [MARGIN_CONTRIB] Calculating total margin contribution for user 1, symbol AUDCAD, positions: 1
2025-06-23 11:40:10,418 - INFO - orders - [MARGIN_CONTRIB] User leverage: 100.00 (raw: 100.00)
2025-06-23 11:40:10,429 - INFO - orders - [SYMBOL_INFO] Retrieved external symbol info for AUDCAD: contract_size=100000.00000000, profit_currency=CAD, digit=5.00000
2025-06-23 11:40:10,429 - INFO - orders - [MARGIN_CONTRIB] Position 1: type=BUY, quantity=0.01000000 (raw: 0.01000000), margin=6.45367831 (raw: 6.45367831)
2025-06-23 11:40:10,430 - INFO - orders - [MARGIN_CONTRIB] Position 1 margin per lot: 6.45367831 / 0.01000000 = 645.367831 (rounded to 645.36783100)
2025-06-23 11:40:10,430 - INFO - orders - [MARGIN_CONTRIB] Total buy quantity: 0.01000000, Total sell quantity: 0.0, Net quantity: 0.01000000
2025-06-23 11:40:10,430 - INFO - orders - [MARGIN_CONTRIB] All margins per lot: [Decimal('645.36783100')], Highest margin per lot: 645.36783100
2025-06-23 11:40:10,430 - INFO - orders - [MARGIN_CONTRIB] Total margin calculation: 645.36783100 * 0.01000000 = 6.4536783100000000 (rounded to 6.45367831)
2025-06-23 11:40:10,431 - INFO - orders - [MARGIN_CONTRIB] Calculating total margin contribution for user 1, symbol AUDCAD, positions: 0
2025-06-23 11:40:10,438 - INFO - orders - [MARGIN_CONTRIB] User leverage: 100.00 (raw: 100.00)
2025-06-23 11:40:10,451 - INFO - orders - [SYMBOL_INFO] Retrieved external symbol info for AUDCAD: contract_size=100000.00000000, profit_currency=CAD, digit=5.00000
2025-06-23 11:40:10,452 - INFO - orders - [MARGIN_CONTRIB] Total buy quantity: 0.0, Total sell quantity: 0.0, Net quantity: 0.0
2025-06-23 11:40:10,452 - INFO - orders - [MARGIN_CONTRIB] All margins per lot: [], Highest margin per lot: 0.0
2025-06-23 11:40:10,452 - INFO - orders - [MARGIN_CONTRIB] Total margin calculation: 0.0 * 0.0 = 0.00 (rounded to 0E-8)
2025-06-23 11:40:10,477 - INFO - orders - [CURRENCY_CONVERT] Starting conversion of 0.050000000000000000000000 CAD to USD for PnL on Close (user_id: 1, position: 9253747588)
2025-06-23 11:40:10,477 - INFO - orders - [CURRENCY_CONVERT] Trying direct conversion with symbol: CADUSD
2025-06-23 11:40:10,483 - INFO - orders - [CURRENCY_CONVERT] Direct conversion prices from cache: None
2025-06-23 11:40:10,483 - INFO - orders - [CURRENCY_CONVERT] No direct conversion rate found for CADUSD, trying inverse
2025-06-23 11:40:10,484 - INFO - orders - [CURRENCY_CONVERT] Trying inverse conversion with symbol: USDCAD
2025-06-23 11:40:10,487 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion prices from cache: {'b': Decimal('1.3743000000'), 'o': Decimal('1.3742400000')}
2025-06-23 11:40:10,487 - INFO - orders - [CURRENCY_CONVERT] Found inverse conversion rate (bid): 1.3743000000
2025-06-23 11:40:10,487 - INFO - orders - [CURRENCY_CONVERT] Inverse conversion successful: 0.050000000000000000000000 CAD / 1.3743000000 = 0.03638215818962380848431928982 USD
2025-06-23 11:40:10,632 - INFO - orders - Starting update_user_static_orders for user 1, user_type demo
2025-06-23 11:40:10,632 - INFO - orders - Using order model: DemoUserOrder
2025-06-23 11:40:10,642 - INFO - orders - Fetched 0 open orders for user 1
2025-06-23 11:40:10,654 - INFO - orders - Fetched 0 pending orders for user 1
2025-06-23 11:40:10,658 - INFO - orders - Updated static orders cache for user 1 with 0 open orders and 0 pending orders
2025-06-23 11:40:10,674 - INFO - orders - [SLTP_TRIGGER] Successfully closed order 9253747588 due to take_profit trigger with robust margin/wallet logic.
2025-06-23 11:40:10,675 - DEBUG - orders - Completed SL/TP check cycle for 0 live orders and 1 demo orders
2025-06-23 11:40:15,691 - INFO - orders - Found 0 pending order keys in Redis
2025-06-23 11:40:15,719 - DEBUG - orders - Completed SL/TP check cycle for 0 live orders and 0 demo orders
2025-06-23 11:40:21,216 - INFO - orders - Found 0 pending order keys in Redis
2025-06-23 11:40:21,226 - DEBUG - orders - Completed SL/TP check cycle for 0 live orders and 0 demo orders
2025-06-23 11:40:26,300 - INFO - orders - Found 0 pending order keys in Redis
2025-06-23 11:40:26,306 - DEBUG - orders - Completed SL/TP check cycle for 0 live orders and 0 demo orders
2025-06-23 11:40:31,312 - INFO - orders - Found 0 pending order keys in Redis
2025-06-23 11:40:31,321 - DEBUG - orders - Completed SL/TP check cycle for 0 live orders and 0 demo orders
2025-06-23 11:40:36,333 - INFO - orders - Found 0 pending order keys in Redis
2025-06-23 11:40:36,349 - DEBUG - orders - Completed SL/TP check cycle for 0 live orders and 0 demo orders
2025-06-23 11:40:41,373 - INFO - orders - Found 0 pending order keys in Redis
2025-06-23 11:40:41,387 - DEBUG - orders - Completed SL/TP check cycle for 0 live orders and 0 demo orders
2025-06-23 11:40:46,396 - INFO - orders - Found 0 pending order keys in Redis
2025-06-23 11:40:46,456 - DEBUG - orders - Completed SL/TP check cycle for 0 live orders and 0 demo orders
2025-06-23 11:40:51,557 - INFO - orders - Found 0 pending order keys in Redis
2025-06-23 11:40:51,573 - DEBUG - orders - Completed SL/TP check cycle for 0 live orders and 0 demo orders
2025-06-23 11:40:56,590 - INFO - orders - Found 0 pending order keys in Redis
2025-06-23 11:40:56,605 - DEBUG - orders - Completed SL/TP check cycle for 0 live orders and 0 demo orders
